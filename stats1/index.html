<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProPush.me Pro Stats</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); padding: 40px; }
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); max-width: 1100px; margin: auto; }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e2e8f0; margin-bottom: 2rem; padding-bottom: 1rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        input { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; }
        button { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; }
        button:hover { background: #1d4ed8; transform: translateY(-1px); }
        .stat-box { background: #eff6ff; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #dbeafe; }
        .stat-val { display: block; font-size: 24px; font-weight: bold; color: var(--primary); }
        .stat-label { font-size: 12px; text-transform: uppercase; color: #64748b; }
        table { width: 100%; border-collapse: collapse; margin-top: 2rem; font-size: 14px; }
        th { background: #f1f5f9; text-align: left; padding: 12px; font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid #e2e8f0; }
        .chart-container { margin-top: 30px; height: 300px; }
        #status { margin-top: 10px; font-weight: 500; }
    </style>
</head>
<body>

<div class="card">
    <div class="header">
        <h2>ðŸš€ ProPush API Manager</h2>
        <div id="status">Ready</div>
    </div>

    <div class="grid">
        <div class="input-group">
            <label>API Key</label>
            <input type="password" id="apiKey" value="230d888eee00b98cdd814f24c4d766199fe94513f3975519">
        </div>
        <div class="input-group">
            <label>From</label>
            <input type="date" id="dateFrom">
        </div>
        <div class="input-group">
            <label>To</label>
            <input type="date" id="dateTo">
        </div>
        <div class="input-group">
            <label>&nbsp;</label>
            <button onclick="loadDashboard()">Refresh Data</button>
        </div>
    </div>

    <div class="grid" id="summaryTiles" style="display: none;">
        <div class="stat-box"><span class="stat-label">Total Profit</span><span class="stat-val" id="totalProfit">$0.00</span></div>
        <div class="stat-box"><span class="stat-label">Subscriptions</span><span class="stat-val" id="totalSubs">0</span></div>
        <div class="stat-box"><span class="stat-label">Unsubs</span><span class="stat-val" id="totalUnsubs">0</span></div>
    </div>

    <div class="chart-container">
        <canvas id="statsChart"></canvas>
    </div>

    <table id="dataTable">
        <thead><tr id="tableHead"></tr></thead>
        <tbody id="tableBody"></tbody>
    </table>
</div>

<script>
    // Initialize default dates
    const d = new Date();
    document.getElementById('dateTo').value = d.toISOString().split('T')[0];
    d.setDate(d.getDate() - 14);
    document.getElementById('dateFrom').value = d.toISOString().split('T')[0];

    let myChart = null;

    async function loadDashboard() {
        const key = document.getElementById('apiKey').value;
        const from = document.getElementById('dateFrom').value;
        const to = document.getElementById('dateTo').value;
        const status = document.getElementById('status');

        status.innerText = "âŒ› Loading...";
        status.style.color = "orange";

        // We use a CORS Proxy to allow the browser to talk to the API
        const targetUrl = `https://api.propush.me/v5/pub/statistics?date_from=${from}&date_to=${to}&group_by[]=date`;
        const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;

        try {
            const response = await fetch(proxyUrl);
            const wrapper = await response.json();
            const data = JSON.parse(wrapper.contents);

            if (!data.rows) throw new Error("No data returned");

            renderStats(data.rows);
            status.innerText = "âœ… Updated";
            status.style.color = "green";
        } catch (err) {
            status.innerText = "âŒ Error: " + err.message;
            status.style.color = "red";
        }
    }

    function renderStats(rows) {
        document.getElementById('summaryTiles').style.display = 'grid';
        
        let profit = 0, subs = 0, unsubs = 0;
        const labels = [], values = [];

        const tbody = document.getElementById('tableBody');
        const thead = document.getElementById('tableHead');
        tbody.innerHTML = ''; thead.innerHTML = '';

        // Headers
        const cols = ['date', 'subscriptions', 'unsubscribes', 'profit'];
        cols.forEach(c => thead.innerHTML += `<th>${c.toUpperCase()}</th>`);

        rows.forEach(row => {
            profit += parseFloat(row.profit || 0);
            subs += parseInt(row.subscriptions || 0);
            unsubs += parseInt(row.unsubscribes || 0);

            labels.push(row.date);
            values.push(row.profit);

            tbody.innerHTML += `<tr>
                <td>${row.date}</td>
                <td>${row.subscriptions}</td>
                <td>${row.unsubscribes}</td>
                <td>$${parseFloat(row.profit).toFixed(4)}</td>
            </tr>`;
        });

        document.getElementById('totalProfit').innerText = `$${profit.toFixed(2)}`;
        document.getElementById('totalSubs').innerText = subs;
        document.getElementById('totalUnsubs').innerText = unsubs;

        updateChart(labels, values);
    }

    function updateChart(labels, data) {
        if(myChart) myChart.destroy();
        const ctx = document.getElementById('statsChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels.reverse(),
                datasets: [{
                    label: 'Daily Profit ($)',
                    data: data.reverse(),
                    borderColor: '#2563eb',
                    tension: 0.3,
                    fill: true,
                    backgroundColor: 'rgba(37, 99, 235, 0.1)'
                }]
            },
            options: { maintainAspectRatio: false }
        });
    }
</script>
</body>
</html>
