<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Redirecting… • CyberChat</title>
<style>
  body {
    margin: 0; padding: 0;
    height: 100vh;
    display: flex; justify-content: center; align-items: center;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    background: #07111a;
    color: #5eead4;
    text-align: center;
    user-select: none;
  }
  .container {
    max-width: 320px;
    padding: 20px;
    border-radius: 12px;
    background: rgba(255 255 255 / 0.05);
    backdrop-filter: blur(8px);
  }
  .loading-dot {
    animation: blink 1.5s infinite;
    font-weight: 700;
  }
  @keyframes blink {
    0%, 100% {opacity: 1;}
    50% {opacity: 0;}
  }
</style>
</head>
<body>
  <div class="container">
    <h1>Redirecting you to CyberChat</h1>
    <p>Please wait<span class="loading-dot">...</span></p>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import { getDatabase, ref, runTransaction, push } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    storageBucket: "itzhoyoo-f9f7e.filestorage.app",
    messagingSenderId: "1094792075584",
    appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
    measurementId: "G-LLT6F9WRKH"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // Extract UID from path like /refer.html=UID
  const path = location.pathname;
  let uid = null;
  if(path.startsWith('/refer.html=')){
    uid = path.split('=')[1];
  } else {
    // fallback: ?refer=UID query param
    const urlParams = new URLSearchParams(location.search);
    uid = urlParams.get('refer');
  }

  if(uid){
    const baseRef = ref(db, `referrals/${uid}`);

    // Increment visitsCount atomically
    runTransaction(ref(db, `referrals/${uid}/visitsCount`), (current) => {
      return (current || 0) + 1;
    });

    // Push a new hit record with user agent and referrer
    push(ref(db, `referrals/${uid}/hits`), {
      t: Date.now(),
      ua: navigator.userAgent.slice(0, 140),
      ref: document.referrer ? (document.referrer.length > 120 ? document.referrer.slice(0,120) : document.referrer) : ''
    });
  }

  // Redirect after 2 seconds to main site or wherever you want
  setTimeout(() => {
    window.location.href = "https://cyberchat.online/";
  }, 2000);
</script>
</body>
</html>