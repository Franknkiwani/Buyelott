<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Withdraw RBX</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,'SF Pro',sans-serif;}
body{background:#0a0a0a;color:#fff;min-height:100vh;display:flex;flex-direction:column;user-select:none;}
body.loading{overflow:hidden;touch-action:none;user-select:none;}
header{position:sticky;top:0;padding:16px 20px;backdrop-filter:blur(20px);background:rgba(255,255,255,0.05);border-bottom:1px solid rgba(255,255,255,0.1);display:flex;justify-content:space-between;align-items:center;z-index:10;}
header h1{font-size:1.4rem;}
main{flex:1;padding:20px;display:flex;flex-direction:column;gap:20px;opacity:0;}
.balance-box{background:rgba(255,255,255,0.05);border-radius:20px;padding:24px;text-align:center;}
.balance-box .amount{font-size:2rem;font-weight:700;}
.withdraw-inputs{display:flex;flex-direction:column;gap:12px;}
.withdraw-inputs input,.withdraw-inputs textarea{padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.3);background:rgba(0,0,0,.3);color:#fff;font-size:1rem;outline:none;box-shadow:none;-webkit-tap-highlight-color:transparent;width:100%;}
.withdraw-inputs textarea{height:80px;resize:none;}
.confirm-btn{padding:14px;border-radius:20px;border:none;font-weight:700;background:#fff;color:#000;cursor:pointer;outline:none;box-shadow:none;-webkit-tap-highlight-color:transparent;}
.confirm-btn:disabled{opacity:.5;cursor:not-allowed;}
.msg{text-align:center;font-weight:600;}
.msg.error{color:#ff4d4d;}
.msg.success{color:#00ff99;}
.history{display:flex;flex-direction:column;gap:10px;max-height:240px;overflow:auto;}
.history-item{background:rgba(255,255,255,0.05);padding:12px;border-radius:14px;font-size:.9rem;}
#loadingScreen{position:fixed;inset:0;background:#0a0a0a;display:flex;align-items:center;justify-content:center;z-index:999;flex-direction:column;}
.spinner{width:60px;height:60px;border:6px solid rgba(255,255,255,0.2);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:12px;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
.loading-text{text-align:center;font-size:1rem;opacity:0.8;}
</style>
</head>
<body class="loading">

<div id="loadingScreen">
  <div class="spinner"></div>
  <div class="loading-text">Watch and earn Robux, nice to see you here!</div>
</div>

<header>
  <h1>Withdraw RBX</h1>
  <button onclick="location.href='/'" style="outline:none;box-shadow:none;-webkit-tap-highlight-color:transparent;">Close</button>
</header>

<main>
  <div class="balance-box">
    <div class="amount" id="currentBalance">0 RBX</div>
    <div>Available Balance</div>
  </div>

  <div class="withdraw-inputs">
    <input id="robloxUsername" placeholder="Roblox username (required)" required>
    <input id="withdrawAmount" type="number" placeholder="Amount (RBX)" required>
    <textarea id="extraInfo" placeholder="Extra info (optional)"></textarea>
    <input id="sendDate" type="date" required>
    <button class="confirm-btn" id="confirmWithdrawBtn">Withdraw</button>
    <div class="msg" id="withdrawMsg"></div>
  </div>

  <h2>Withdrawal History</h2>
  <div class="history" id="withdrawHistory"></div>
</main>
<h2 style="text-align:center;margin-top:20px;">Withdrawal Q&A</h2>
<div class="faq" style="display:flex;flex-direction:column;gap:12px;margin:0 auto;width:90%;">
  <div class="faq-item" style="padding:16px;border-radius:16px;background:rgba(255,255,255,0.05);">
    <h3 style="font-size:1rem;margin-bottom:6px;">Minimum Withdrawal?</h3>
    <p style="font-size:0.9rem;opacity:0.8;">The minimum withdrawal is 150 RBX. You cannot withdraw less than this amount.</p>
  </div>
  <div class="faq-item" style="padding:16px;border-radius:16px;background:rgba(255,255,255,0.05);">
    <h3 style="font-size:1rem;margin-bottom:6px;">How do I schedule?</h3>
    <p style="font-size:0.9rem;opacity:0.8;">Select the date you want your RBX to be sent using the date picker above.</p>
  </div>
  <div class="faq-item" style="padding:16px;border-radius:16px;background:rgba(255,255,255,0.05);">
    <h3 style="font-size:1rem;margin-bottom:6px;">Roblox Username?</h3>
    <p style="font-size:0.9rem;opacity:0.8;">RBX will be sent to this Roblox account. Make sure the username is correct.</p>
  </div>
  <div class="faq-item" style="padding:16px;border-radius:16px;background:rgba(255,255,255,0.05);">
    <h3 style="font-size:1rem;margin-bottom:6px;">When will I receive RBX?</h3>
    <p style="font-size:0.9rem;opacity:0.8;">Withdrawals are processed automatically on the selected send date. Status will show Pending, Approved, or Rejected.</p>
  </div>
</div>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
import { getDatabase, ref, onValue, push, runTransaction } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

const app = initializeApp({
  apiKey:"AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
  authDomain:"itzhoyoo-f9f7e.firebaseapp.com",
  databaseURL:"https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
  projectId:"itzhoyoo-f9f7e"
});

const auth = getAuth(app);
const db = getDatabase(app);

const currentBalance = document.getElementById('currentBalance');
const withdrawHistory = document.getElementById('withdrawHistory');
const msg = document.getElementById('withdrawMsg');
const btn = document.getElementById('confirmWithdrawBtn');

const robloxUsername = document.getElementById('robloxUsername');
const withdrawAmount = document.getElementById('withdrawAmount');
const extraInfo = document.getElementById('extraInfo');
const sendDate = document.getElementById('sendDate');

const loadingScreen = document.getElementById('loadingScreen');
const main = document.querySelector('main');

let user=null, balance=0;

// Wait for auth
onAuthStateChanged(auth,u=>{
  if(!u){location.href='/login'; return;}
  user=u;
  loadData();
});

function loadData(){
  // Listen continuously to balance changes for instant update
  const balRef = ref(db, `users/${user.uid}/rbxbalance`);
  onValue(balRef, snap=>{
    balance = snap.val()||0;
    currentBalance.innerText = balance+" RBX";
    withdrawAmount.max = balance;
  });

  // Load withdrawal history
  const histRef = ref(db, `withdrawals/${user.uid}`);
  onValue(histRef, snap=>{
    withdrawHistory.innerHTML='';
    if(!snap.exists()){withdrawHistory.innerHTML='<div>No withdrawals yet</div>'; return;}
    Object.values(snap.val()).sort((a,b)=>b.time-a.time).forEach(w=>{
      let color='yellow', text='Pending';
      if(w.status==='approved'){color='green'; text='Approved'}
      if(w.status==='rejected'){color='red'; text='Rejected'}
      const div=document.createElement('div');
      div.className='history-item';
      div.innerHTML=`
        <div><b>Roblox:</b> ${w.robloxUsername}</div>
        <div><b>Amount:</b> ${w.amount} RBX</div>
        <div><b>Requested:</b> ${new Date(w.time).toLocaleDateString()}</div>
        <div><b>Send Date:</b> ${w.sendDate}</div>
        <div><b>Status:</b> <span style="color:${color};font-weight:bold">${text}</span></div>
      `;
      withdrawHistory.appendChild(div);
    });
  });

  // Hide loading
  setTimeout(()=>{
    loadingScreen.style.display='none';
    main.style.opacity=1;
    document.body.classList.remove('loading');
  },2000); // keep smooth delay
}

// Withdraw click
btn.onclick=async()=>{
  msg.className='msg';
  const name=robloxUsername.value.trim();
  const amt=parseInt(withdrawAmount.value);

  if(!name){msg.classList.add('error'); msg.innerText='Roblox username required'; return;}
  if(isNaN(amt)||amt<150){msg.classList.add('error'); msg.innerText='Minimum withdraw is 150 RBX'; return;}
  if(amt>balance){msg.classList.add('error'); msg.innerText='Insufficient balance'; return;}
  if(!sendDate.value){msg.classList.add('error'); msg.innerText='Select send date'; return;}

  btn.disabled=true;

  try{
    await push(ref(db, `withdrawals/${user.uid}`), {
      robloxUsername:name,
      amount:amt,
      info:extraInfo.value,
      sendDate:sendDate.value,
      time:Date.now(),
      status:'pending'
    });

    // Deduct balance via transaction for safety
    await runTransaction(ref(db, `users/${user.uid}/rbxbalance`), v => (v||0)-amt);

    msg.classList.add('success');
    msg.innerText='Withdrawal submitted (Pending)';

    robloxUsername.value='';
    withdrawAmount.value='';
    extraInfo.value='';
    sendDate.value='';
  }catch(err){
    console.error(err);
    msg.classList.add('error');
    msg.innerText='Error submitting withdrawal';
  }finally{
    btn.disabled=false;
  }
};
</script>
</body>
</html>