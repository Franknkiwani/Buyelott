<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller Portal | ItzHoyoo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200;0,800;1,800&display=swap" rel="stylesheet">
  <style>
    :root { --accent: #3b82f6; --bg: #000000; --card: #0a0a0a; --border: rgba(255,255,255,0.08); }
    body {
        background: var(--bg); color: #fff; font-family: 'Plus Jakarta Sans', sans-serif;
        background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #000 70%);
        min-height: 100vh; padding-top: 80px; overflow-x: hidden;
    }
    .card-solid { background: var(--card); border: 1px solid var(--border); backdrop-blur: 10px; }
    .input-field { background: #000; border: 1px solid #1a1a1a; color: white; transition: 0.3s; font-size: 13px; width: 100%; padding: 1rem; border-radius: 0.75rem; font-weight: 700; }
    .input-field:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 15px rgba(59, 130, 246, 0.1); }
    
    .overlay { position: fixed; inset: 0; z-index: 300; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; backdrop-blur: 5px; opacity: 0; transition: 0.3s; }
    .overlay.active { display: flex; opacity: 1; }

    /* The Flooty Logic: Panel starts hidden */
    #stats-panel { 
        transform: translateY(20px); opacity: 0; visibility: hidden; 
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
    }
    #stats-panel.active { transform: translateY(0); opacity: 1; visibility: visible; }

    .toggle-switch { width: 40px; height: 20px; background: #333; border-radius: 20px; position: relative; cursor: pointer; transition: 0.3s; }
    .toggle-switch.active { background: #3b82f6; }
    .toggle-circle { width: 14px; height: 14px; background: white; border-radius: 50%; position: absolute; top: 3px; left: 3px; transition: 0.3s; }
    .toggle-switch.active .toggle-circle { left: 23px; }

    @keyframes pulse-blue { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
    .withdraw-ready { animation: pulse-blue 2s infinite; background: #3b82f6 !important; color: white !important; }
</style>

</head>
<body class="overflow-hidden">

    <div id="loading-screen" class="fixed inset-0 z-[500] bg-black flex flex-col items-center justify-center transition-all duration-700">
        <div class="w-12 h-12 border-t-2 border-blue-500 rounded-full animate-spin mb-4"></div>
        <p class="text-[10px] font-black uppercase tracking-[0.5em] text-blue-500">Syncing Terminal</p>
    </div>

    <div id="custom-modal" class="overlay">
        <div class="w-full max-w-sm card-solid rounded-[32px] p-8 text-center border-white/10">
            <h3 id="modal-title" class="text-lg font-black italic uppercase mb-2">Notice</h3>
            <p id="modal-text" class="text-xs text-gray-400 font-medium mb-6 leading-relaxed"></p>
            <div class="flex gap-2" id="modal-footer">
                <button onclick="closeModal()" class="flex-1 py-3 bg-white/5 rounded-xl text-[10px] font-black uppercase">Dismiss</button>
            </div>
        </div>
    </div>

    <div id="support-overlay" class="overlay">
        <div class="w-full max-w-lg card-solid rounded-[40px] p-10 relative">
            <button onclick="toggleSupport(false)" class="absolute top-8 right-8 text-gray-500 font-black hover:text-white">✕</button>
            <h2 class="text-2xl font-black italic uppercase mb-8 text-center">Contact <span class="text-blue-500">Center</span></h2>
            
            <div class="space-y-4">
                <a href="https://wa.me/27742132827" target="_blank" class="flex items-center justify-between p-5 bg-blue-500/5 border border-white/5 rounded-2xl hover:bg-blue-500/10 transition">
                    <div>
                        <p class="text-[10px] font-black uppercase text-blue-500 tracking-widest">Merchant Support (You)</p>
                        <p class="text-xs font-bold text-white">Payouts & Seller Verification</p>
                        <p class="text-[9px] text-gray-500 mt-1">+27 74 213 2827</p>
                    </div>
                    <span class="bg-blue-500 text-white px-3 py-1 rounded-lg font-black text-[9px]">SELLER</span>
                </a>

                <a href="https://wa.me/27846737224" target="_blank" class="flex items-center justify-between p-5 bg-green-500/5 border border-white/5 rounded-2xl hover:bg-green-500/10 transition">
                    <div>
                        <p class="text-[10px] font-black uppercase text-green-500 tracking-widest">Client Support (Buyers)</p>
                        <p class="text-xs font-bold text-white">Payment Proofs & Disputes</p>
                        <p class="text-[9px] text-gray-500 mt-1">+27 84 673 7224</p>
                    </div>
                    <span class="bg-green-500 text-black px-3 py-1 rounded-lg font-black text-[9px]">BUYER</span>
                </a>
            </div>
        </div>
    </div>

    <header class="fixed top-0 left-0 right-0 h-16 flex items-center px-6 z-50 bg-black/60 backdrop-blur-2xl border-b border-white/5">
        <div class="max-w-7xl mx-auto w-full flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div id="user-initials" class="w-9 h-9 rounded-xl bg-blue-600 flex items-center justify-center text-[10px] font-black">??</div>
                <div class="leading-none">
                    <p class="text-[9px] text-gray-500 font-black uppercase tracking-widest">Authorized Seller</p>
                    <p id="user-name" class="text-xs font-bold text-white">@username</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="toggleSupport(true)" class="text-[10px] font-black uppercase tracking-widest px-4 py-2 bg-blue-600/20 text-blue-400 rounded-xl hover:bg-blue-600 hover:text-white transition">Support</button>
                <a href="/" class="text-[10px] font-black uppercase tracking-widest px-4 py-2 border border-white/10 rounded-xl hover:bg-white hover:text-black transition">Home</a>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 grid grid-cols-1 lg:grid-cols-12 gap-8 pb-20">
        <div class="lg:col-span-4">
            <div class="card-solid p-6 rounded-[32px] sticky top-24">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xs font-black uppercase text-blue-500 italic">Deploy Account</h2>
                    <div class="flex items-center gap-2">
                        <span class="text-[7px] font-black text-gray-500 uppercase">Promote (50% Fee)</span>
                        <div id="promo-toggle" onclick="togglePromo()" class="toggle-switch"><div class="toggle-circle"></div></div>
                    </div>
                </div>

                <form id="listing-form" class="space-y-4">
                    <input type="text" id="acc-name" placeholder="Account Name" class="input-field" required>
                    
                    <select id="acc-tier" class="input-field appearance-none cursor-pointer">
                        <option value="Standard" selected>Tier: Standard</option>
                        <option value="Average">Tier: Average</option>
                        <option value="Legendary">Tier: Legendary</option>
                    </select>

                    <input type="number" id="acc-price" step="0.01" min="1" placeholder="Price ($)" class="input-field" required>
                    
                    <div id="revenue-calc" class="flex justify-between px-1 hidden">
                        <span class="text-[9px] font-black text-red-500 uppercase italic">Fee (<span id="fee-pct">30</span>%): <span id="calc-cut"></span></span>
                        <span class="text-[9px] font-black text-green-500 uppercase italic">Earn: <span id="calc-profit"></span></span>
                    </div>

                    <div class="relative">
                        <textarea id="acc-desc" placeholder="Product Details..." class="input-field h-24 resize-none" required></textarea>
                        <button type="button" onclick="generateAIDesc()" class="absolute bottom-3 right-3 bg-blue-600/10 text-blue-400 text-[8px] px-2 py-1 rounded font-black uppercase hover:bg-blue-600 hover:text-white transition">AI Rewrite</button>
                    </div>

                    <div id="drop-zone" class="border-2 border-dashed border-white/5 rounded-xl p-4 text-center cursor-pointer hover:border-blue-500 transition">
                        <p class="text-[9px] font-black uppercase text-gray-500" id="upload-status">Add Images</p>
                        <input type="file" id="img-input" multiple accept="image/*" class="hidden">
                        <div id="img-previews" class="flex gap-2 mt-3 flex-wrap justify-center"></div>
                    </div>
                    
                    <button type="submit" id="submit-btn" class="w-full py-4 bg-white text-black font-black uppercase text-[10px] rounded-xl hover:bg-blue-600 hover:text-white transition">Publish Listing</button>
                </form>
            </div>
        </div>

        <div class="lg:col-span-8">
            <h2 class="text-xs font-black uppercase italic mb-6 text-gray-500">Inventory Management</h2>
            <div id="my-listings" class="space-y-3"></div>
        </div>
    </main>

    <div id="stats-panel" class="fixed bottom-6 right-6 w-80 card-solid p-6 rounded-[32px] shadow-2xl z-[150]">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-[10px] font-black uppercase text-blue-500 italic tracking-widest">Financial Terminal</h3>
            <button id="stats-minimize" class="text-gray-600 hover:text-white">✕</button>
        </div>
        
        <div class="space-y-4 mb-6">
            <div class="flex justify-between border-b border-white/5 pb-2">
                <p class="text-[9px] font-bold text-gray-500 uppercase tracking-tighter">Est. Pending Profit</p>
                <p id="p-possible" class="text-xs font-black text-white">$0.00</p>
            </div>
            <div class="flex justify-between">
                <div>
                    <p class="text-[9px] font-bold text-gray-500 uppercase tracking-tighter">Withdrawable Balance</p>
                    <p id="p-actual" class="text-lg font-black text-green-400 leading-tight">$0.00</p>
                </div>
                <div class="text-right">
                    <p class="text-[9px] font-bold text-gray-500 uppercase tracking-tighter">Sold</p>
                    <p id="p-orders" class="text-xs font-black text-blue-400">0</p>
                </div>
            </div>
        </div>

        <button id="payout-btn" onclick="requestPayout()" class="w-full py-4 bg-white/5 text-gray-500 font-black rounded-2xl text-[10px] uppercase transition cursor-not-allowed" disabled>
            Request Payout
        </button>
        <p id="payout-min-notice" class="text-[8px] text-red-500/60 font-black uppercase text-center mt-2">Minimum $3.00 required to withdraw</p>
    </div>

    <div id="order-overlay" class="overlay">
        <div class="w-full max-w-2xl card-solid rounded-[40px] p-8 max-h-[85vh] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-black italic uppercase">Fulfillment <span class="text-blue-500">Required</span></h2>
                <button onclick="closeOrderModal()" class="text-[10px] font-black uppercase text-gray-500 hover:text-white">Close</button>
            </div>
            <div id="order-list" class="overflow-y-auto space-y-3"></div>
        </div>
    </div>
<button id="stats-flooty" class="fixed bottom-6 right-6 w-14 h-14 bg-blue-600 rounded-2xl shadow-2xl flex items-center justify-center z-[200] hover:scale-110 active:scale-95 transition-all">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
</button>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
    import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
        authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
        databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
        projectId: "itzhoyoo-f9f7e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const IMGUR_CLIENT_ID = '891e5bb4aa94282';

    let uploadedImages = [];
    let sellerInfo = {};
    let isPromoted = false;
    let currentActualProfit = 0;

    // --- PANEL CONTROLS ---
    const statsFlooty = document.getElementById('stats-flooty');
    const statsPanel = document.getElementById('stats-panel');
    const statsMinimize = document.getElementById('stats-minimize');

    if(statsFlooty) statsFlooty.onclick = () => statsPanel.classList.toggle('active');
    if(statsMinimize) statsMinimize.onclick = (e) => { e.stopPropagation(); statsPanel.classList.remove('active'); };

    // --- MODAL SYSTEM ---
    window.showModal = (title, text, onConfirm = null) => {
        const modal = document.getElementById('custom-modal');
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-text').textContent = text;
        const footer = document.getElementById('modal-footer');
        footer.innerHTML = `<button onclick="closeModal()" class="flex-1 py-3 bg-white/5 rounded-xl text-[10px] font-black uppercase">Dismiss</button>`;
        if(onConfirm) {
            const b = document.createElement('button');
            b.className = "flex-1 py-3 bg-blue-600 rounded-xl text-[10px] font-black uppercase";
            b.textContent = "Confirm";
            b.onclick = () => { onConfirm(); closeModal(); };
            footer.appendChild(b);
        }
        modal.classList.add('active');
    };
    window.closeModal = () => document.getElementById('custom-modal').classList.remove('active');

    // --- AUTH ---
    onAuthStateChanged(auth, (user) => {
        if (!user) window.location.href = "/";
        else {
            const username = user.email.split('@')[0];
            sellerInfo = { uid: user.uid, username: `@${username}` };
            document.getElementById('user-name').textContent = sellerInfo.username;
            document.getElementById('user-initials').textContent = username.substring(0, 2).toUpperCase();
            syncDashboard();
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('opacity-0', 'invisible');
                document.body.classList.remove('overflow-hidden');
            }, 1000);
        }
    });

    // --- FORM LOGIC ---
    window.togglePromo = () => {
        isPromoted = !isPromoted;
        document.getElementById('promo-toggle').classList.toggle('active');
        document.getElementById('fee-pct').textContent = isPromoted ? '50' : '30';
        updateRevenue();
    };

    const updateRevenue = () => {
        const v = parseFloat(document.getElementById('acc-price').value);
        const box = document.getElementById('revenue-calc');
        if(v > 0) {
            const feeRate = isPromoted ? 0.5 : 0.3;
            box.classList.remove('hidden');
            document.getElementById('calc-cut').textContent = `-$${(v*feeRate).toFixed(2)}`;
            document.getElementById('calc-profit').textContent = `$${(v*(1-feeRate)).toFixed(2)}`;
        } else box.classList.add('hidden');
    };
    document.getElementById('acc-price').oninput = updateRevenue;

    window.toggleSupport = (s) => document.getElementById('support-overlay').classList.toggle('active', s);
    window.closeOrderModal = () => document.getElementById('order-overlay').classList.remove('active');

    // --- DATA SYNC & ANALYTICS ---
    function syncDashboard() {
        onValue(ref(db, 'dls_accounts'), (snap) => {
            const list = document.getElementById('my-listings');
            let possibleValue = 0, html = '', count = 0;
            
            snap.forEach(child => {
                const acc = child.val();
                if(acc.ownerUid === sellerInfo.uid) {
                    count++;
                    const cutRate = acc.isPromoted ? 0.5 : 0.7;
                    possibleValue += (acc.price * cutRate);
                    
                    // Analytics defaults if they don't exist yet
                    const views = acc.views || 0;
                    const clicks = acc.clicks || 0;
                    const sales = acc.sales || 0;
                    
                    html += `
                        <div class="card-solid p-5 rounded-[24px] border-white/5 space-y-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <div class="relative">
                                        <img src="${acc.images?.[0]}" class="w-12 h-12 rounded-xl object-cover">
                                        ${acc.isPromoted ? '<span class="absolute -top-2 -left-2 bg-blue-600 text-[7px] px-1.5 py-0.5 rounded italic font-black">PRO</span>' : ''}
                                    </div>
                                    <div>
                                        <h4 class="text-sm font-black uppercase italic">${acc.name} <span class="text-blue-500 opacity-50 ml-2 text-[10px]">${acc.tier}</span></h4>
                                        <p class="text-[10px] font-bold text-green-500 uppercase tracking-tight">Possible: $${(acc.price * cutRate).toFixed(2)}</p>
                                    </div>
                                </div>
                                <button onclick="confirmDelete('${child.key}')" class="text-gray-600 hover:text-red-500 transition">✕</button>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-2 pt-2 border-t border-white/5">
                                <div class="text-center">
                                    <p class="text-[8px] font-black text-gray-500 uppercase">Views</p>
                                    <p class="text-xs font-black text-white">${views}</p>
                                </div>
                                <div class="text-center border-x border-white/5">
                                    <p class="text-[8px] font-black text-gray-500 uppercase">Clicks</p>
                                    <p class="text-xs font-black text-white">${clicks}</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-[8px] font-black text-blue-500 uppercase">Sales</p>
                                    <p class="text-xs font-black text-white">${sales}</p>
                                </div>
                            </div>
                        </div>`;
                }
            });
            list.innerHTML = count > 0 ? html : '<div class="py-20 text-center opacity-20 text-[10px] font-black uppercase">No Active Inventory</div>';
            document.getElementById('p-possible').textContent = `$${possibleValue.toFixed(2)}`;
        });

        // Actual Profit calculation (Real Sales)
        onValue(ref(db, 'orders'), (snap) => {
            let actualCash = 0, soldCount = 0;
            snap.forEach(child => {
                const o = child.val();
                if(o.sellerUid === sellerInfo.uid) {
                    soldCount++;
                    const cut = o.isPromoted ? 0.5 : 0.7;
                    if(o.paid) actualCash += (o.price * cut);
                }
            });
            currentActualProfit = actualCash;
            document.getElementById('p-actual').textContent = `$${actualCash.toFixed(2)}`;
            document.getElementById('p-orders').textContent = soldCount;
            
            const btn = document.getElementById('payout-btn');
            if(actualCash >= 3) {
                btn.disabled = false;
                btn.classList.add('withdraw-active');
                btn.classList.replace('text-gray-500', 'text-white');
            }
        });
    }

    // --- ACTIONS ---
    window.confirmDelete = (id) => showModal("Delete?", "Remove this listing?", () => remove(ref(db, `dls_accounts/${id}`)));

    document.getElementById('listing-form').onsubmit = async (e) => {
        e.preventDefault();
        if(uploadedImages.length === 0) return showModal("Wait", "Upload at least one image.");
        const btn = document.getElementById('submit-btn'); btn.disabled = true; btn.textContent = "Deploying...";
        
        await push(ref(db, 'dls_accounts'), {
            name: document.getElementById('acc-name').value,
            price: parseFloat(document.getElementById('acc-price').value),
            desc: document.getElementById('acc-desc').value,
            tier: document.getElementById('acc-tier').value,
            images: uploadedImages,
            isPromoted: isPromoted,
            ownerUid: sellerInfo.uid,
            owner: sellerInfo.username,
            createdAt: Date.now(),
            views: 0,
            clicks: 0,
            sales: 0
        });
        location.reload();
    };

    // --- IMAGE HELPERS ---
    const imgInput = document.getElementById('img-input');
    document.getElementById('drop-zone').onclick = () => imgInput.click();
    imgInput.onchange = async (e) => {
        for (const file of e.target.files) {
            const fd = new FormData(); fd.append('image', file);
            const res = await fetch('https://api.imgur.com/3/image', { method: 'POST', headers: { Authorization: `Client-ID ${IMGUR_CLIENT_ID}` }, body: fd });
            const data = await res.json();
            if(data.success) { uploadedImages.push(data.data.link); renderPreviews(); }
        }
    };
    function renderPreviews() {
        document.getElementById('img-previews').innerHTML = uploadedImages.map((url, i) => `
            <div class="relative"><img src="${url}" class="w-10 h-10 rounded-lg object-cover">
            <button type="button" onclick="removeImg(${i})" class="absolute -top-1 -right-1 bg-red-500 rounded-full w-4 h-4 text-[10px]">✕</button></div>`).join('');
    }
    window.removeImg = (i) => { uploadedImages.splice(i, 1); renderPreviews(); };
</script>

</body>
</html>
