<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Imgur + Firebase Image Upload (Public / Private) - Demo</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; margin: 18px; background:#f5f7fb; color:#111; }
    header { display:flex; align-items:center; gap:12px; margin-bottom:18px; }
    .card { background:white; border-radius:10px; padding:12px; box-shadow:0 6px 18px rgba(20,30,60,0.06); margin-bottom:12px; }
    input, select, button, textarea { font:inherit; padding:8px; border-radius:8px; border:1px solid #ddd; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    #gallery { display:grid; grid-template-columns: repeat(auto-fill,minmax(240px,1fr)); gap:12px; margin-top:12px; }
    .thumb img { width:100%; height:160px; object-fit:cover; border-radius:8px; display:block; }
    .meta { font-size:13px; color:#444; margin-top:6px; display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .muted { color:#666; font-size:13px; }
    button.primary { background:#2643ff; color:white; border:0; padding:10px 12px; border-radius:8px; cursor:pointer; }
    button.ghost { background:transparent; border:1px solid #ddd; cursor:pointer; }
    .small { font-size:13px; padding:6px 8px; border-radius:7px; }
    .userbox { display:flex; align-items:center; gap:8px; }
    .avatar { width:36px; height:36px; border-radius:50%; background:#ddd; display:inline-block; overflow:hidden; }
    .avatar img { width:100%; height:100%; object-fit:cover; }
    .follow-btn { background:#28a745; color:white; border:0; padding:6px 8px; border-radius:8px; cursor:pointer; }
    .liked { color:#e24b4b; font-weight:700; }
    .center { text-align:center; }
    .notice { background:#fff8e6; border-left:4px solid #ffd24d; padding:8px; border-radius:6px; margin-bottom:10px; }
  </style>
</head>
<body>
  <header>
    <div>
      <h2 style="margin:0">Imgur + Firebase Upload — Public / Private</h2>
      <div class="muted">Upload images to Imgur, store metadata in Firebase, share public images, like & follow users.</div>
    </div>
    <div style="margin-left:auto" id="authArea"></div>
  </header>

  <div class="card">
    <div class="notice">
      This demo uses your Imgur Client-ID and Firebase Realtime Database. Anyone opening the page can view public images.
    </div>

    <div id="uploader">
      <div class="row">
        <div style="flex:1">
          <label>Caption</label><br/>
          <input id="caption" placeholder="A short caption" style="width:100%" />
        </div>

        <div style="width:170px">
          <label>Privacy</label><br/>
          <select id="privacy" style="width:100%">
            <option value="public">Public — anyone can see</option>
            <option value="private">Private — only you can see</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px" class="row">
        <input id="file" type="file" accept="image/*" />
        <button class="primary" id="uploadBtn">Upload to Imgur & Save</button>
        <div id="uploadStatus" class="muted"></div>
      </div>

      <div id="preview" style="margin-top:10px" class="row"></div>
    </div>
  </div>

  <div class="card">
    <div style="display:flex; align-items:center; gap:10px;">
      <h3 style="margin:0">Public Gallery</h3>
      <div class="muted">Automatically shows images saved with privacy = public.</div>
    </div>

    <div id="gallery" aria-live="polite"></div>
  </div>

  <!-- Firebase + App scripts -->
<script type="module">
  // ----------------------------
  //  CONFIG
  // ----------------------------
  const IMGUR_CLIENT_ID = "891e5bb4aa94282"; 
  const firebaseConfig = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    storageBucket: "itzhoyoo-f9f7e.filestorage.app",
    messagingSenderId: "1094792075584",
    appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
    measurementId: "G-LLT6F9WRKH"
  };

  // ----------------------------
  // Firebase Imports
  // ----------------------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    signInAnonymously,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import {
    getDatabase,
    ref,
    push,
    set,
    update,
    onValue,
    query,
    orderByChild,
    equalTo,
    get,
    child,
    runTransaction
  } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // ----------------------------
  // UI References
  // ----------------------------
  const fileInput = document.getElementById('file');
  const uploadBtn = document.getElementById('uploadBtn');
  const preview = document.getElementById('preview');
  const uploadStatus = document.getElementById('uploadStatus');
  const captionEl = document.getElementById('caption');
  const privacyEl = document.getElementById('privacy');
  const gallery = document.getElementById('gallery');
  const authArea = document.getElementById('authArea');

  let currentUser = null;

  // ----------------------------
  // AUTH
  // ----------------------------
  function renderAuth(user) {
    authArea.innerHTML = '';
    if (!user) {
      const g = document.createElement('button');
      g.textContent = 'Sign in with Google';
      g.className = 'primary small';
      g.onclick = async () => {
        try { await signInWithPopup(auth, new GoogleAuthProvider()); }
        catch { await signInAnonymously(auth); }
      };

      const anon = document.createElement('button');
      anon.textContent = 'Continue anonymously';
      anon.className = 'ghost small';
      anon.onclick = () => signInAnonymously(auth);

      authArea.appendChild(g);
      authArea.appendChild(anon);
    } else {
      const box = document.createElement('div');
      box.className = 'userbox';

      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      const img = document.createElement('img');
      img.src = user.photoURL || `https://api.dicebear.com/7.x/identicon/svg?seed=${user.uid}`;
      avatar.appendChild(img);

      const name = document.createElement('div');
      name.innerHTML = `<strong>${user.displayName || 'Anonymous'}</strong><br><span class="muted">${user.uid.slice(0,6)}</span>`;

      const outBtn = document.createElement('button');
      outBtn.textContent = 'Sign out';
      outBtn.className = 'ghost small';
      outBtn.onclick = () => signOut(auth);

      box.appendChild(avatar);
      box.appendChild(name);
      box.appendChild(outBtn);

      authArea.appendChild(box);
    }
  }

  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    renderAuth(user);
    if (user) {
      await set(ref(db, `users/${user.uid}`), {
        displayName: user.displayName || 'Anonymous',
        photoURL: user.photoURL || null,
        lastSeen: Date.now()
      }).catch(()=>{});
    }
    loadPublicGallery();
  });

  // ----------------------------
  // Preview selected file
  // ----------------------------
  fileInput.addEventListener('change', () => {
    preview.innerHTML = '';
    if (!fileInput.files.length) return;

    const img = document.createElement('img');
    img.src = URL.createObjectURL(fileInput.files[0]);
    img.style.maxHeight = '120px';
    img.style.borderRadius = '8px';
    preview.appendChild(img);
  });

  // ----------------------------
  // Upload → Imgur → Firebase save
  // ----------------------------
  uploadBtn.addEventListener('click', async () => {
    if (!fileInput.files.length) return alert('Choose an image');

    if (!currentUser) await signInAnonymously(auth);

    const file = fileInput.files[0];
    const caption = captionEl.value || '';
    const privacy = privacyEl.value || 'public';

    uploadStatus.textContent = 'Uploading to Imgur...';
    uploadBtn.disabled = true;

    try {
      const base64 = await fileToBase64(file);

      const payload = new URLSearchParams();
      payload.append('image', base64.replace(/^data:image\/\w+;base64,/, ''));
      payload.append('type', 'base64');

      const res = await fetch("https://api.imgur.com/3/image", {
        method: "POST",
        headers: { Authorization: "Client-ID " + IMGUR_CLIENT_ID },
        body: payload
      });

      const data = await res.json();
      if (!data.success) throw new Error("Imgur upload failed");

      const link = data.data.link;
      const delHash = data.data.deletehash;

      const newImg = push(ref(db, "images"));
      await set(newImg, {
        ownerUid: currentUser.uid,
        ownerName: currentUser.displayName || "Anonymous",
        ownerPhoto: currentUser.photoURL || null,
        caption,
        privacy,
        imgurLink: link,
        imgurDeleteHash: delHash,
        createdAt: Date.now(),
        likesCount: 0
      });

      uploadStatus.innerHTML = `Uploaded. <a href="${link}" target="_blank">View</a>`;

      fileInput.value = "";
      captionEl.value = "";
      preview.innerHTML = "";

      loadPublicGallery();
    } catch (e) {
      uploadStatus.textContent = "Upload failed: " + e.message;
    }
    uploadBtn.disabled = false;
  });

  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const r = new FileReader();
      r.onload = () => resolve(r.result);
      r.onerror = reject;
      r.readAsDataURL(file);
    });
  }

  // ----------------------------
  // FIXED PUBLIC GALLERY LOADER
  // ----------------------------
  async function loadPublicGallery() {
    gallery.innerHTML = '<div class="muted center">Loading public images…</div>';

    try {
      const snap = await get(ref(db, 'images'));

      gallery.innerHTML = '';

      if (!snap.exists()) {
        gallery.innerHTML = '<div class="muted center">No public images yet.</div>';
        return;
      }

      const all = snap.val();

      const entries = Object.entries(all)
        .filter(([id, meta]) => meta && meta.privacy === "public")
        .sort((a, b) => b[1].createdAt - a[1].createdAt);

      if (!entries.length) {
        gallery.innerHTML = '<div class="muted center">No public images yet.</div>';
        return;
      }

      entries.forEach(([id, meta]) => {
        gallery.appendChild(makeImageCard(id, meta));
      });

    } catch (e) {
      console.error(e);
      gallery.innerHTML = '<div class="muted center">Failed to load gallery.</div>';
    }
  }

  // ----------------------------
  // Image Card (likes + follow)
  // ----------------------------
  function makeImageCard(id, meta) {
    const card = document.createElement("div");
    card.className = "card thumb";

    const img = document.createElement("img");
    img.src = meta.imgurLink;
    img.style.width = "100%";
    img.style.borderRadius = "6px";
    card.appendChild(img);

    const metaDiv = document.createElement("div");
    metaDiv.className = "meta";

    const owner = document.createElement("div");
    owner.innerHTML = `<strong>${meta.ownerName}</strong><br><span class="muted">${new Date(meta.createdAt).toLocaleString()}</span>`;
    metaDiv.appendChild(owner);

    const actions = document.createElement("div");
    actions.style.marginTop = "6px";

    const likeBtn = document.createElement("button");
    likeBtn.textContent = `❤ ${meta.likesCount || 0}`;
    likeBtn.className = "small";
    likeBtn.onclick = () => handleLike(id, meta, likeBtn);

    const viewBtn = document.createElement("a");
    viewBtn.textContent = "View";
    viewBtn.href = meta.imgurLink;
    viewBtn.target = "_blank";
    viewBtn.className = "small";

    actions.appendChild(likeBtn);
    actions.appendChild(viewBtn);

    // follow system
    if (currentUser && currentUser.uid !== meta.ownerUid) {
      const followBtn = document.createElement("button");
      followBtn.className = "small";
      followBtn.textContent = "Follow";

      const fRef = ref(db, `users/${meta.ownerUid}/followers/${currentUser.uid}`);
      get(fRef).then(s => {
        if (s.exists()) followBtn.textContent = "Unfollow";
      });

      followBtn.onclick = async () => {
        const s = await get(fRef);
        if (s.exists()) {
          await set(fRef, null);
          followBtn.textContent = "Follow";
        } else {
          await set(fRef, true);
          followBtn.textContent = "Unfollow";
        }
      };
      actions.appendChild(followBtn);
    }

    metaDiv.appendChild(actions);
    card.appendChild(metaDiv);

    return card;
  }

  // ----------------------------
  // LIKE HANDLER
  // ----------------------------
  async function handleLike(id, meta, likeBtn) {
    if (!currentUser) return alert("Sign in");

    const likedRef = ref(db, `images/${id}/likedBy/${currentUser.uid}`);
    const countRef = ref(db, `images/${id}/likesCount`);

    const snap = await get(likedRef);
    if (snap.exists()) {
      await set(likedRef, null);
      await runTransaction(countRef, c => (c || 0) - 1);
    } else {
      await set(likedRef, true);
      await runTransaction(countRef, c => (c || 0) + 1);
    }

    const newCount = await get(countRef);
    likeBtn.textContent = `❤ ${newCount.exists() ? newCount.val() : 0}`;
  }
</script>
</body>
</html>