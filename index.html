<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Posts Display</title>
  <style>
    body { background: #121212; color: #eee; font-family: Arial, sans-serif; padding: 20px; }
    .post-card {
      background: #1e1e1e; border-radius: 12px; padding: 16px; margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }
    .post-header {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
    }
    .user-info {
      display: flex; align-items: center; gap: 12px;
    }
    .user-pic {
      width: 40px; height: 40px; border-radius: 50%; object-fit: cover;
    }
    .user-names {
      display: flex; flex-direction: column;
    }
    .username {
      font-weight: bold; font-size: 16px;
    }
    .handle {
      font-size: 12px; color: #6fc3df;
    }
    .post-title {
      font-size: 18px; font-weight: bold; margin: 10px 0;
    }
    .post-image {
      width: 100%; max-height: 200px; object-fit: cover; border-radius: 10px; margin-bottom: 10px;
    }
    .post-stats {
      display: flex; justify-content: space-around; font-size: 14px; color: #888; margin-bottom: 12px;
    }
    .post-actions {
      display: flex; gap: 20px;
    }
    button {
      cursor: pointer; background: #333; border: none; padding: 8px 12px; border-radius: 8px;
      color: #eee; font-weight: 600; transition: background 0.3s;
    }
    button:hover {
      background: #555;
    }
    .liked {
      color: #ff6b81;
      animation: pulse 0.5s ease;
    }
    .following {
      background-color: #2ecc71 !important;
      color: #fff !important;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>

  <div id="postsContainer"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getDatabase, ref, onValue, update, get, set } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
      authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
      databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
      projectId: "itzhoyoo-f9f7e",
      storageBucket: "itzhoyoo-f9f7e.appspot.com",
      messagingSenderId: "1094792075584",
      appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    const postsRef = ref(db, 'posts');
    const postsContainer = document.getElementById('postsContainer');

    let currentUser = null;

    // Track logged-in user
    onAuthStateChanged(auth, user => {
      currentUser = user;
      loadPostsRealtime();
    });

    function loadPostsRealtime() {
      onValue(postsRef, snapshot => {
        postsContainer.innerHTML = '';
        const posts = snapshot.val() || {};

        Object.entries(posts).forEach(([postId, post]) => {
          // Create post card
          const postEl = document.createElement('div');
          postEl.className = 'post-card';

          // Check if current user liked this post
          let userLiked = false;
          if (currentUser && post.likesBy && post.likesBy[currentUser.uid]) {
            userLiked = true;
          }

          // Check if current user follows the post uploader
          let userFollows = false;
          if (currentUser && post.followers && post.followers[currentUser.uid]) {
            userFollows = true;
          }

          postEl.innerHTML = `
            <div class="post-header">
              <div class="user-info">
                <img src="${post.userPic || 'https://i.pravatar.cc/40'}" alt="User Pic" class="user-pic" />
                <div class="user-names">
                  <div class="username">${post.username || 'Anonymous'}</div>
                  <div class="handle">@${post.handle || 'user'}</div>
                </div>
              </div>
              <button class="follow-btn ${userFollows ? 'following' : ''}">
                ${userFollows ? 'Following' : 'Follow'}
              </button>
            </div>
            <div class="post-title">${post.title || 'Untitled Post'}</div>
            ${post.image ? `<img src="${post.image}" alt="Post Image" class="post-image" />` : ''}
            <div class="post-stats">
              <div>Views: ${post.views || 0}</div>
              <div>Likes: <span id="like-count-${postId}">${post.likes || 0}</span></div>
              <div>Comments: ${post.comments ? Object.keys(post.comments).length : 0}</div>
            </div>
            <div class="post-actions">
              <button class="like-btn ${userLiked ? 'liked' : ''}" data-id="${postId}">üëç Like</button>
              <button class="view-comments-btn" data-id="${postId}">üëÅÔ∏è View Comments</button>
              <button class="share-btn" data-id="${postId}">üîó Share</button>
            </div>
          `;

          postsContainer.appendChild(postEl);

          // Like button logic
          const likeBtn = postEl.querySelector('.like-btn');
          likeBtn.onclick = async () => {
            if (!currentUser) {
              alert('Please log in to like posts.');
              return;
            }
            const postLikesByRef = ref(db, `posts/${postId}/likesBy/${currentUser.uid}`);
            const postLikesRef = ref(db, `posts/${postId}/likes`);
            if (userLiked) {
              // Remove like
              await set(postLikesByRef, null);
              await update(ref(db, `posts/${postId}`), { likes: (post.likes || 1) - 1 });
              likeBtn.classList.remove('liked');
              userLiked = false;
              // Update count visually
              const countSpan = document.getElementById(`like-count-${postId}`);
              if (countSpan) countSpan.textContent = (post.likes || 1) - 1;
              post.likes = (post.likes || 1) - 1;
            } else {
              // Add like
              await set(postLikesByRef, true);
              await update(ref(db, `posts/${postId}`), { likes: (post.likes || 0) + 1 });
              likeBtn.classList.add('liked');
              userLiked = true;
              // Animate
              likeBtn.animate([
                { transform: 'scale(1)' },
                { transform: 'scale(1.4)' },
                { transform: 'scale(1)' }
              ], { duration: 400 });
              // Update count visually
              const countSpan = document.getElementById(`like-count-${postId}`);
              if (countSpan) countSpan.textContent = (post.likes || 0) + 1;
              post.likes = (post.likes || 0) + 1;
            }
          };

          // Follow button logic
          const followBtn = postEl.querySelector('.follow-btn');
          followBtn.onclick = async () => {
            if (!currentUser) {
              alert('Please log in to follow users.');
              return;
            }
            const followerRef = ref(db, `posts/${postId}/followers/${currentUser.uid}`);
            if (userFollows) {
              // Unfollow
              await set(followerRef, null);
              followBtn.textContent = 'Follow';
              followBtn.classList.remove('following');
              userFollows = false;
            } else {
              // Follow
              await set(followerRef, true);
              followBtn.textContent = 'Following';
              followBtn.classList.add('following');
              userFollows = true;
            }
          };

          // Share button
          const shareBtn = postEl.querySelector('.share-btn');
          shareBtn.onclick = () => {
            const shareData = {
              title: post.title || 'Check out this post',
              text: post.title || '',
              url: window.location.href + `#post-${postId}`
            };
            if (navigator.share) {
              navigator.share(shareData).catch(err => alert('Share failed: ' + err));
            } else {
              prompt('Copy and share this link:', shareData.url);
            }
          };

          // View comments button placeholder
          postEl.querySelector('.view-comments-btn').onclick = () => {
            alert('Open comments modal for post ' + postId);
          };
        });
      });
    }
  </script>
</body>
</html>