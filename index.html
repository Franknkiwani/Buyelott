<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DLS Match Making</title>
<style>
  /* Reset */
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0; 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
      Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    background: #f5f7fa;
    color: #222;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  header {
    border-bottom: 3px solid #0070f3;
    padding: 1rem 1.5rem;
    text-align: center;
    font-weight: 700;
    font-size: 1.5rem;
    letter-spacing: 1px;
    background: white;
    user-select: none;
  }
  main {
    flex: 1;
    max-width: 480px;
    margin: 2rem auto;
    padding: 0 1rem;
  }
  form {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    background: white;
    padding: 1.5rem 2rem;
    border-radius: 8px;
    box-shadow: 0 3px 10px rgb(0 0 0 / 0.1);
  }
  label {
    font-weight: 600;
    font-size: 0.95rem;
  }
  input[type="text"], select {
    padding: 0.6rem 0.8rem;
    border: 1.5px solid #ccc;
    border-radius: 5px;
    font-size: 1rem;
    transition: border-color 0.2s ease;
  }
  input[type="text"]:focus, select:focus {
    border-color: #0070f3;
    outline: none;
  }
  button {
    background: #0070f3;
    border: none;
    color: white;
    padding: 0.75rem;
    font-size: 1.1rem;
    font-weight: 700;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.25s ease;
  }
  button:hover {
    background: #005bb5;
  }
  section#matches {
    margin-top: 2rem;
  }
  .match-card {
    background: white;
    padding: 1rem 1.25rem;
    border-radius: 7px;
    box-shadow: 0 1px 6px rgb(0 0 0 / 0.08);
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
  }
  @media (max-width: 520px) {
    main {
      margin: 1rem;
    }
    form {
      padding: 1rem 1rem;
    }
  }
</style>
</head>
<body>
<header>DLS Match Making</header>
<main>
  <form id="matchForm" autocomplete="off">
    <label for="teamName">Your Team Name</label>
    <input type="text" id="teamName" name="teamName" placeholder="e.g. Cape Crushers" required minlength="3" maxlength="20" />

    <label for="region">Region</label>
    <select id="region" name="region" required>
      <option value="" disabled selected>Select region</option>
      <option value="africa">Africa</option>
      <option value="europe">Europe</option>
      <option value="asia">Asia</option>
      <option value="americas">Americas</option>
      <option value="oceania">Oceania</option>
    </select>

    <button type="submit">Find Match</button>
  </form>

  <section id="matches" aria-live="polite"></section>
</main>

<!-- Firebase SDKs -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getDatabase, ref, push, get, query, orderByChild, remove } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

  // Your real Firebase config:
  const firebaseConfig = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    storageBucket: "itzhoyoo-f9f7e.filestorage.app",
    messagingSenderId: "1094792075584",
    appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
    measurementId: "G-LLT6F9WRKH"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const form = document.getElementById('matchForm');
  const matchesSection = document.getElementById('matches');

  async function addToWaiting(teamName, region) {
    const waitingRef = ref(db, 'waiting_teams');
    const newEntryRef = await push(waitingRef, {
      teamName,
      region,
      timestamp: Date.now()
    });
    return newEntryRef.key;
  }

  async function findMatch(region, excludeKey) {
    const waitingRef = ref(db, 'waiting_teams');
    const regionQuery = query(waitingRef, orderByChild('region'));
    const snapshot = await get(regionQuery);
    if (!snapshot.exists()) return null;

    let matchKey = null;
    let matchData = null;
    snapshot.forEach(childSnap => {
      const data = childSnap.val();
      const key = childSnap.key;
      if (data.region === region && key !== excludeKey) {
        matchKey = key;
        matchData = data;
        return true;
      }
    });
    if (matchKey && matchData) {
      return { key: matchKey, data: matchData };
    }
    return null;
  }

  async function removeWaiting(key) {
    if (!key) return;
    const entryRef = ref(db, `waiting_teams/${key}`);
    await remove(entryRef);
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    matchesSection.textContent = '';
    const teamName = form.teamName.value.trim();
    const region = form.region.value;

    if (!teamName || !region) {
      matchesSection.textContent = 'Please fill in all fields.';
      return;
    }

    const ownKey = await addToWaiting(teamName, region);

    matchesSection.textContent = 'Searching for a match... ⏳';

    let attempts = 0;
    const maxAttempts = 10;

    const intervalId = setInterval(async () => {
      attempts++;
      const match = await findMatch(region, ownKey);
      if (match) {
        clearInterval(intervalId);

        await removeWaiting(match.key);
        await removeWaiting(ownKey);

        matchesSection.innerHTML = `
          <div class="match-card">
            Matched with <strong>${match.data.teamName}</strong> from <em>${match.data.region}</em>!
          </div>
        `;
      } else if (attempts >= maxAttempts) {
        clearInterval(intervalId);
        await removeWaiting(ownKey);
        matchesSection.textContent = 'No matches found right now. Try again later.';
      }
    }, 2000);
  });
</script>
</body>
</html>