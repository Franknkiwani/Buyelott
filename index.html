<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DLS Group Chat w/ Profile & Location & Pic Upload</title>
  <style>
    /* Your existing styles (body, header, chat, messages, footer) remain the same... */
    body {
      margin: 0;
      background: #121212;
      color: #eee;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      position: sticky;
      top: 0;
      background: #1f1f1f;
      padding: 1rem 1.5rem;
      font-weight: 700;
      font-size: 1.5rem;
      color: #4caf50;
      border-bottom: 1px solid #333;
      z-index: 10;
      user-select: none;
    }
    main.chat {
      flex: 1;
      padding: 1rem;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
      background: #181818;
    }
    .message-container {
      display: flex;
      max-width: 75%;
      gap: 0.8rem;
      user-select: text;
      position: relative;
    }
    .message-container.you {
      align-self: flex-end;
      flex-direction: row-reverse;
    }
    .message-container.other {
      align-self: flex-start;
    }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      flex-shrink: 0;
      object-fit: cover;
      border: 2px solid #4caf50;
      background: #333;
    }
    .message-content {
      background: #2a2a2a;
      border-radius: 15px;
      padding: 0.7rem 1rem;
      font-size: 1rem;
      line-height: 1.3;
      position: relative;
      color: #ccc;
      word-wrap: break-word;
    }
    .message-container.you .message-content {
      background: #4caf50;
      color: #121212;
      border-bottom-right-radius: 3px;
    }
    .message-info {
      font-size: 0.75rem;
      color: #9ccc65;
      margin-bottom: 0.15rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .sender-name {
      user-select: text;
    }
    .flag {
      font-size: 1.2rem;
    }
    .timestamp {
      font-weight: 400;
      color: #a5d6a7;
      margin-left: auto;
      font-style: italic;
    }
    footer {
      background: #1f1f1f;
      padding: 0.7rem 1rem;
      display: flex;
      gap: 0.7rem;
      border-top: 1px solid #333;
    }
    input[type="text"] {
      flex: 1;
      padding: 0.7rem 1rem;
      font-size: 1rem;
      border-radius: 25px;
      border: none;
      outline: none;
      background: #2a2a2a;
      color: #eee;
      transition: background 0.3s;
    }
    input[type="text"]:focus {
      background: #3a3a3a;
    }
    button.send-btn {
      background: #4caf50;
      border: none;
      color: #121212;
      font-weight: 700;
      font-size: 1rem;
      padding: 0 1.2rem;
      border-radius: 25px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button.send-btn:disabled {
      background: #3a7d3a;
      cursor: not-allowed;
    }
    button.send-btn:hover:not(:disabled) {
      background: #43a047;
    }

    /* Modal overlay for username input + profile pic */
    #usernameModal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      flex-direction: column;
      gap: 1rem;
      padding: 1rem;
      backdrop-filter: blur(8px);
    }
    #usernameModal.hidden {
      display: none;
    }
    #usernameModal h2 {
      color: #4caf50;
      font-weight: 900;
      font-size: 2rem;
      margin-bottom: 0.5rem;
      user-select: none;
    }
    #usernameModal input[type="text"] {
      padding: 1rem 1.5rem;
      font-size: 1.2rem;
      border-radius: 30px;
      border: none;
      outline: none;
      width: 280px;
      max-width: 90vw;
      text-align: center;
      background: #2a2a2a;
      color: #eee;
      transition: background 0.3s;
    }
    #usernameModal input[type="text"]:focus {
      background: #3a3a3a;
    }
    #usernameModal button {
      background: #4caf50;
      color: #121212;
      border: none;
      padding: 0.8rem 2rem;
      font-size: 1.1rem;
      font-weight: 800;
      border-radius: 30px;
      cursor: pointer;
      transition: background 0.3s;
    }
    #usernameModal button:disabled {
      background: #3a7d3a;
      cursor: not-allowed;
    }
    #usernameModal button:hover:not(:disabled) {
      background: #43a047;
    }
    /* Profile pic upload */
    #profilePicContainer {
      position: relative;
      width: 120px;
      height: 120px;
      border-radius: 50%;
      overflow: hidden;
      background: #333;
      border: 3px solid #4caf50;
      cursor: pointer;
      transition: border-color 0.3s;
    }
    #profilePicContainer:hover {
      border-color: #81c784;
    }
    #profilePicInput {
      display: none;
    }
    #profilePicPreview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
      display: block;
    }
    #uploadingText {
      color: #ccc;
      font-size: 0.9rem;
      user-select: none;
    }
  </style>
</head>
<body>

<header>DLS Group Chat</header>

<!-- Username Modal -->
<div id="usernameModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" class="">
  <h2 id="modalTitle">Welcome! Enter your username & profile pic</h2>

  <label id="profilePicContainer" for="profilePicInput" title="Click to select profile picture">
    <img id="profilePicPreview" src="https://api.dicebear.com/6.x/thumbs/svg?seed=default&scale=90" alt="Profile Picture Preview" />
  </label>
  <input type="file" id="profilePicInput" accept="image/*" aria-label="Upload profile picture" />

  <input type="text" id="usernameInput" placeholder="Your username (min 3 chars)" autocomplete="off" maxlength="20" aria-describedby="uploadingText" />
  <div id="uploadingText" aria-live="polite" style="height:1.3em;"></div>
  <button id="usernameSubmit" disabled>Join Chat</button>
</div>

<main class="chat" id="chat" aria-live="polite"></main>

<footer>
  <input type="text" id="messageInput" placeholder="Type your message..." autocomplete="off" disabled />
  <button class="send-btn" id="sendBtn" disabled>Send</button>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
  import { getDatabase, ref, push, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js";

  // Firebase config (replace with yours)
  const firebaseConfig = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    storageBucket: "itzhoyoo-f9f7e.filestorage.app",
    messagingSenderId: "1094792075584",
    appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
  };

  // Imgur Client ID
  const IMGUR_CLIENT_ID = "891e5bb4aa94282";

  // Init Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const chatRef = ref(db, 'groupchat/messages');

  // Elements
  const usernameModal = document.getElementById('usernameModal');
  const usernameInput = document.getElementById('usernameInput');
  const usernameSubmit = document.getElementById('usernameSubmit');
  const chat = document.getElementById('chat');
  const input = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const profilePicInput = document.getElementById('profilePicInput');
  const profilePicPreview = document.getElementById('profilePicPreview');
  const uploadingText = document.getElementById('uploadingText');

  // User profile data
  let userProfile = {
    username: null,
    avatar: null, // URL to uploaded profile pic or fallback
  };

  // Enable submit if username valid & avatar uploaded (or default avatar)
  function validateSubmit() {
    const nameValid = usernameInput.value.trim().length >= 3;
    const avatarReady = !!userProfile.avatar;
    usernameSubmit.disabled = !(nameValid && avatarReady);
  }

  // Avatar fallback dicebear generator (seed username)
  function generateAvatar(seed) {
    return `https://api.dicebear.com/6.x/thumbs/svg?seed=${encodeURIComponent(seed)}&scale=90`;
  }

  // Upload image file to Imgur, returns URL or throws
  async function uploadToImgur(file) {
    uploadingText.textContent = 'Uploading image to Imgur...';
    const formData = new FormData();
    formData.append('image', file);

    const res = await fetch('https://api.imgur.com/3/image', {
      method: 'POST',
      headers: {
        Authorization: 'Client-ID ' + IMGUR_CLIENT_ID,
      },
      body: formData
    });
    if (!res.ok) {
      uploadingText.textContent = 'Upload failed. Try again.';
      throw new Error('Imgur upload failed');
    }
    const data = await res.json();
    uploadingText.textContent = '';
    return data.data.link;
  }

  // Handle profile pic selection
  profilePicInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    // Show preview locally before upload
    const reader = new FileReader();
    reader.onload = (ev) => {
      profilePicPreview.src = ev.target.result;
    };
    reader.readAsDataURL(file);

    try {
      // Upload to Imgur
      const imgUrl = await uploadToImgur(file);
      userProfile.avatar = imgUrl;
      validateSubmit();
    } catch (e) {
      console.error(e);
      userProfile.avatar = null;
      validateSubmit();
    }
  });

  // Username input listener
  usernameInput.addEventListener('input', () => {
    userProfile.username = usernameInput.value.trim();
    // If user hasn't uploaded pic yet, fallback avatar:
    if (!userProfile.avatar && userProfile.username.length >= 3) {
      userProfile.avatar = generateAvatar(userProfile.username);
      profilePicPreview.src = userProfile.avatar;
    }
    validateSubmit();
  });

  // Handle submit join chat
  usernameSubmit.addEventListener('click', () => {
    if (usernameSubmit.disabled) return;
    usernameModal.classList.add('hidden');
    initUser(userProfile.username, userProfile.avatar);
  });

  // Util: time ago
  function timeAgo(ts) {
    const seconds = Math.floor((Date.now() - ts) / 1000);
    if (seconds < 10) return "just now";
    if (seconds < 60) return seconds + "s ago";
    if (seconds < 3600) return Math.floor(seconds / 60) + "m ago";
    if (seconds < 86400) return Math.floor(seconds / 3600) + "h ago";
    return new Date(ts).toLocaleDateString();
  }

  // Country code to flag emoji
  function countryCodeToFlagEmoji(cc) {
    if (!cc) return "🏳️";
    return cc
      .toUpperCase()
      .replace(/./g, char =>
        String.fromCodePoint(127397 + char.charCodeAt())
      );
  }

  // Variables for user location data
  let userCountry = "Unknown";
  let userCountryCode = "";
  let userFlag = "🏳️";

  // Fetch IP location info
  async function fetchUserLocation() {
    try {
      const res = await fetch('https://ipapi.co/json/');
      if (!res.ok) throw new Error("Failed to fetch IP info");
      const data = await res.json();
      userCountry = data.country_name || "Unknown";
      userCountryCode = data.country_code || "";
      userFlag = countryCodeToFlagEmoji(userCountryCode);
    } catch {
      // Silent fail
    }
  }

  // Initialize user-related features after username + avatar set
  async function initUser(username, avatar) {
    await fetchUserLocation();

    // Enable input area
    input.disabled = false;
    input.focus();

    // Enable send button only when input has text
    input.addEventListener('input', () => {
      sendBtn.disabled = input.value.trim().length === 0;
    });

    // Listen for incoming messages
    onChildAdded(chatRef, (snapshot) => {
      const msg = snapshot.val();
      addMessage(msg, username);
    });

    // Send message handler
    sendBtn.onclick = () => {
      const text = input.value.trim();
      if (!text) return;

      const messageData = {
        sender: username,
        text,
        timestamp: Date.now(),
        avatar: avatar,
        country: userCountry,
        flag: userFlag
      };

      push(chatRef, messageData);
      input.value = '';
      sendBtn.disabled = true;
    };

    // Send on Enter key
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !sendBtn.disabled) {
        sendBtn.click();
        e.preventDefault();
      }
    });
  }

  // Add a message bubble to chat
  function addMessage({ sender, text, timestamp, avatar, country, flag }, currentUsername) {
    const isYou = sender === currentUsername;
    const container = document.createElement('div');
    container.className = 'message-container ' + (isYou ? 'you' : 'other');

    const avatarImg = document.createElement('img');
    avatarImg.className = 'avatar';
    avatarImg.src = avatar || generateAvatar(sender);
    avatarImg.alt = sender + ' avatar';
    avatarImg.loading = 'lazy';

    const content = document.createElement('div');
    content.className = 'message-content';

    const info = document.createElement('div');
    info.className = 'message-info';

    const nameSpan = document.createElement('span');
    nameSpan.className = 'sender-name';
    nameSpan.textContent = sender;

    const flagSpan = document.createElement('span');
    flagSpan.className = 'flag';
    flagSpan.textContent = flag || countryCodeToFlagEmoji(country);

    const timeSpan = document.createElement('span');
    timeSpan.className = 'timestamp';
    timeSpan.textContent = timeAgo(timestamp || Date.now());

    info.appendChild(nameSpan);
    info.appendChild(flagSpan);
    info.appendChild(timeSpan);

    content.appendChild(info);

    const messageText = document.createElement('div');
    messageText.textContent = text;
    content.appendChild(messageText);

    container.appendChild(avatarImg);
    container.appendChild(content);

    chat.appendChild(container);
    chat.scrollTop = chat.scrollHeight;
  }
</script>

</body>
</html>