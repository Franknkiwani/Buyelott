<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dark App with Matchmaking & Firebase</title>
  <style>
    * {
      margin: 0; padding: 0; box-sizing: border-box;
    }
    html, body {
      height: 100%; background: #000; color: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow-x: hidden;
    }
    .player-badge {
      position: absolute; top: 20px; left: 20px;
      background: #111; border: 2px solid #444;
      padding: 16px 20px; border-radius: 12px;
      display: flex; align-items: center;
      font-size: 1rem; color: #eee; gap: 15px;
      box-shadow: 0 0 10px #000;
      min-width: 260px;
      z-index: 5;
    }
    .player-badge img {
      width: 48px; height: 32px; object-fit: cover;
      border-radius: 4px; border: 1px solid #666;
    }
    .player-info {
      display: flex; flex-direction: column;
    }
    .rank {
      font-size: 0.9rem; color: #999;
    }

    /* Center text when empty */
    .center {
      height: 100%;
      display: flex; align-items: center; justify-content: center;
      text-align: center; opacity: 0.1; font-size: 1.5rem; letter-spacing: 1px;
    }

    /* AUTH POPUP STYLES */
    #auth-popup {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }
    #auth-popup .auth-container {
      background: #111;
      padding: 30px 40px;
      border-radius: 12px;
      width: 320px;
      box-shadow: 0 0 20px #222;
      color: #eee;
    }
    #auth-popup h2 {
      margin-bottom: 20px;
      font-weight: 700;
      text-align: center;
      letter-spacing: 1.2px;
    }
    #auth-popup input[type="email"],
    #auth-popup input[type="password"] {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 15px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      background: #222;
      color: #eee;
    }
    #auth-popup button {
      width: 100%;
      padding: 12px;
      background: #2979ff;
      border: none;
      border-radius: 6px;
      font-weight: 700;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.25s ease;
    }
    #auth-popup button:hover {
      background: #1c54b2;
    }
    #auth-popup .toggle-auth {
      margin-top: 12px;
      text-align: center;
      font-size: 0.9rem;
      cursor: pointer;
      color: #4d90fe;
      user-select: none;
    }
    #auth-popup .error-message {
      color: #f44336;
      margin-bottom: 15px;
      font-size: 0.9rem;
      text-align: center;
      min-height: 1.3em;
    }

    /* MATCHMAKING AREA */
    #matchmaking {
      position: fixed;
      bottom: 20px; left: 50%;
      transform: translateX(-50%);
      background: #111;
      border: 2px solid #444;
      border-radius: 16px;
      padding: 20px 30px;
      max-width: 600px;
      width: 90vw;
      color: #eee;
      box-shadow: 0 0 15px #000;
      font-size: 1rem;
      z-index: 10;
    }
    #matchmaking h3 {
      margin-bottom: 12px;
      font-weight: 700;
      text-align: center;
      font-size: 1.3rem;
      letter-spacing: 1.2px;
    }
    #users-list {
      max-height: 200px;
      overflow-y: auto;
      margin-bottom: 20px;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 8px;
      background: #222;
    }
    .user-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 6px 10px;
      border-bottom: 1px solid #333;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .user-item:hover {
      background: #333;
    }
    .user-item img {
      width: 32px; height: 22px;
      object-fit: cover;
      border-radius: 3px;
      margin-right: 12px;
      border: 1px solid #555;
    }
    .user-info {
      flex: 1;
      display: flex;
      gap: 12px;
      align-items: center;
      font-size: 0.9rem;
      color: #ddd;
    }
    .user-rank {
      color: #aaa;
      font-size: 0.8rem;
    }
    .challenge-btn {
      background: #2979ff;
      border: none;
      padding: 6px 12px;
      color: white;
      border-radius: 6px;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .challenge-btn:disabled {
      background: #555;
      cursor: not-allowed;
    }
    .challenge-btn:hover:not(:disabled) {
      background: #1c54b2;
    }

    /* MATCH STATUS */
    #match-status {
      font-size: 1.5rem;
      text-align: center;
      margin-top: 12px;
      color: #59ff7a;
      font-weight: 900;
      letter-spacing: 3px;
      user-select: none;
    }
    #countdown {
      font-size: 3.5rem;
      text-align: center;
      color: #ff5555;
      font-weight: 900;
      letter-spacing: 6px;
      user-select: none;
      margin-top: 10px;
    }

  </style>
</head>
<body>
  <div class="player-badge" id="player-badge" style="display:none;">Loading user data...</div>
  <div class="center" id="center-text">Empty Dark App</div>

  <!-- AUTH POPUP -->
  <div id="auth-popup" style="display:none;">
    <div class="auth-container">
      <h2 id="auth-title">Login</h2>
      <div class="error-message" id="auth-error"></div>
      <input type="email" id="email" placeholder="Email" required autocomplete="username" />
      <input type="password" id="password" placeholder="Password" required autocomplete="current-password" />
      <button id="auth-action-btn">Login</button>
      <div class="toggle-auth" id="toggle-auth-text">Don't have an account? Register</div>
    </div>
  </div>

  <!-- MATCHMAKING AREA -->
  <div id="matchmaking" style="display:none;">
    <h3>Available Players (Click to Challenge)</h3>
    <div id="users-list">Loading users...</div>
    <div id="match-status"></div>
    <div id="countdown"></div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
  import { getDatabase, ref, get, set, onValue, update, serverTimestamp, remove } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    storageBucket: "itzhoyoo-f9f7e.firebasestorage.app",
    messagingSenderId: "1094792075584",
    appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
    measurementId: "G-LLT6F9WRKH"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  // DOM
  const playerBadge = document.getElementById('player-badge');
  const centerText = document.getElementById('center-text');
  const authPopup = document.getElementById('auth-popup');
  const authTitle = document.getElementById('auth-title');
  const authError = document.getElementById('auth-error');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const authActionBtn = document.getElementById('auth-action-btn');
  const toggleAuthText = document.getElementById('toggle-auth-text');

  const matchmakingDiv = document.getElementById('matchmaking');
  const usersListDiv = document.getElementById('users-list');
  const matchStatusDiv = document.getElementById('match-status');
  const countdownDiv = document.getElementById('countdown');

  // Rank logic
  function getRank(xp) {
    const matchesPlayed = Math.floor(xp / 10);
    if (matchesPlayed >= 50) return 'ðŸ’Ž Diamond';
    if (matchesPlayed >= 20) return 'ðŸ¥‡ Gold';
    if (matchesPlayed >= 10) return 'ðŸ¥ˆ Silver';
    if (matchesPlayed >= 5) return 'ðŸ¥‰ Bronze';
    return 'ðŸ”° Newbie';
  }

  // Fetch country info
  async function fetchCountry() {
    try {
      const res = await fetch('https://ipapi.co/json/');
      return await res.json();
    } catch {
      return null;
    }
  }

  // Utility: generate 6-char uppercase alphanumeric code
  function generateCode() {
    return Math.random().toString(36).substring(2, 8).toUpperCase();
  }

  // Global state
  let currentUser = null;
  let currentUserCountry = { name: 'Unknown', code: 'us' };
  let usersList = {};
  let currentMatch = null;
  let countdownInterval = null;

  // Update player badge UI
  async function updatePlayerBadge(user) {
    const uid = user.uid;
    let xp = 1;
    try {
      const snap = await get(ref(db, `users/${uid}/xp`));
      if (snap.exists()) xp = snap.val();
    } catch {}

    const rank = getRank(xp);
    // Update user country on DB (just once)
    if (!currentUserCountry || currentUserCountry.name === 'Unknown') {
      const countryData = await fetchCountry();
      if (countryData) {
        currentUserCountry = {
          name: countryData.country_name || 'Unknown',
          code: countryData.country_code?.toLowerCase() || 'us'
        };
      }
    }
    // Save user info to DB with online flag + country + xp
    await set(ref(db, `users/${uid}`), {
      email: user.email,
      country: currentUserCountry.name,
      countryCode: currentUserCountry.code,
      xp,
      online: true,
      lastOnline: serverTimestamp()
    });

    const flagUrl = `https://flagcdn.com/w80/${currentUserCountry.code}.png`;
    const fallbackFlag = 'https://flagcdn.com/w80/us.png';

    playerBadge.innerHTML = `
      <img src="${flagUrl}" alt="Flag" onerror="this.onerror=null;this.src='${fallbackFlag}'">
      <div class="player-info">
        <div>${currentUserCountry.name}</div>
        <div>XP: ${xp}</div>
        <div class="rank">Rank: ${rank}</div>
      </div>
    `;
    playerBadge.style.display = 'flex';
  }

  // Listen to users list changes
  function listenToUsers() {
    const usersRef = ref(db, 'users');
    onValue(usersRef, (snapshot) => {
      usersList = snapshot.val() || {};
      renderUsersList();
    });
  }

  // Render users list except current user
  function renderUsersList() {
    usersListDiv.innerHTML = '';
    const filteredUsers = Object.entries(usersList)
      .filter(([uid, data]) => uid !== currentUser.uid && data.online);

    if (filteredUsers.length === 0) {
      usersListDiv.textContent = 'No other players online.';
      return;
    }

    filteredUsers.forEach(([uid, data]) => {
      const userDiv = document.createElement('div');
      userDiv.classList.add('user-item');

      const flagUrl = `https://flagcdn.com/w40/${(data.countryCode || 'us').toLowerCase()}.png`;
      const fallbackFlag = 'https://flagcdn.com/w40/us.png';

      const userInfo = document.createElement('div');
      userInfo.className = 'user-info';
      userInfo.innerHTML = `
        <img src="${flagUrl}" alt="Flag" onerror="this.onerror=null;this.src='${fallbackFlag}'">
        <span>${data.country || 'Unknown'}</span>
        <span>XP: ${data.xp || 1}</span>
        <span class="user-rank">${getRank(data.xp || 1)}</span>
      `;

      const challengeBtn = document.createElement('button');
      challengeBtn.className = 'challenge-btn';
      challengeBtn.textContent = 'Challenge';
      challengeBtn.onclick = () => createMatch(uid);

      userDiv.appendChild(userInfo);
      userDiv.appendChild(challengeBtn);
      usersListDiv.appendChild(userDiv);
    });
  }

  // Create match in Firebase
  async function createMatch(opponentUid) {
    if (currentMatch) {
      alert('You already have an active match!');
      return;
    }

    const matchId = Math.random().toString(36).substring(2, 10);
    const code = generateCode();
    const now = Date.now();
    const expiresAt = now + 5 * 60 * 1000; // 5 minutes

    // Write match
    await set(ref(db, `matches/${matchId}`), {
      player1: currentUser.uid,
      player2: opponentUid,
      code,
      createdAt: now,
      expiresAt,
      status: 'active'
    });

    currentMatch = { id: matchId };
    showMatchStatus(`Match started! Code: ${code}`);
    startCountdown(expiresAt);

    // Also listen for match changes
    listenToMatch(matchId);
  }

  // Listen to current match data
  function listenToMatch(matchId) {
    const matchRef = ref(db, `matches/${matchId}`);
    onValue(matchRef, (snapshot) => {
      const match = snapshot.val();
      if (!match) {
        // Match removed or expired
        clearMatch();
        return;
      }
      if (match.status !== 'active') {
        clearMatch();
        return;
      }
      currentMatch = { ...match, id: matchId };
      showMatchStatus(`Match code: ${match.code}`);
      // Update countdown if needed
      if (match.expiresAt) startCountdown(match.expiresAt);
    });
  }

  // Clear match UI and state
  function clearMatch() {
    currentMatch = null;
    stopCountdown();
    matchStatusDiv.textContent = '';
    countdownDiv.textContent = '';
  }

  // Countdown timer logic
  function startCountdown(expireTimestamp) {
    stopCountdown();

    function updateTimer() {
      const now = Date.now();
      const diff = expireTimestamp - now;
      if (diff <= 0) {
        countdownDiv.textContent = "TIME'S UP!";
        clearMatch();
        return;
      }
      const minutes = Math.floor(diff / 60000);
      const seconds = Math.floor((diff % 60000) / 1000);
      countdownDiv.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    updateTimer();
    countdownInterval = setInterval(updateTimer, 1000);
  }

  function stopCountdown() {
    if (countdownInterval) {
      clearInterval(countdownInterval);
      countdownInterval = null;
    }
  }

  function showMatchStatus(message) {
    matchStatusDiv.textContent = message;
  }

  // AUTH logic

  let isRegistering = false;

  function showAuthPopup(show) {
    authPopup.style.display = show ? 'flex' : 'none';
  }

  function clearAuthError() {
    authError.textContent = '';
  }

  authActionBtn.addEventListener('click', () => {
    clearAuthError();
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if (!email || !password) {
      authError.textContent = 'Please enter email and password.';
      return;
    }
    if (isRegistering) {
      createUserWithEmailAndPassword(auth, email, password)
        .then(userCredential => {
          currentUser = userCredential.user;
          showAuthPopup(false);
          initializeAfterLogin();
        })
        .catch(error => {
          authError.textContent = error.message;
        });
    } else {
      signInWithEmailAndPassword(auth, email, password)
        .then(userCredential => {
          currentUser = userCredential.user;
          showAuthPopup(false);
          initializeAfterLogin();
        })
        .catch(error => {
          authError.textContent = error.message;
        });
    }
  });

  toggleAuthText.addEventListener('click', () => {
    isRegistering = !isRegistering;
    authTitle.textContent = isRegistering ? 'Register' : 'Login';
    authActionBtn.textContent = isRegistering ? 'Register' : 'Login';
    toggleAuthText.textContent = isRegistering ? 'Already have an account? Login' : "Don't have an account? Register";
    clearAuthError();
  });

  // Initialize app after user logged in
  async function initializeAfterLogin() {
    centerText.style.display = 'none';
    matchmakingDiv.style.display = 'block';
    await updatePlayerBadge(currentUser);
    listenToUsers();
    // Set user online status and cleanup on disconnect
    const userRef = ref(db, `users/${currentUser.uid}`);
    await update(userRef, { online: true, lastOnline: serverTimestamp() });

    // On disconnect
    userRef.onDisconnect().update({ online: false, lastOnline: serverTimestamp() });
  }

  // Auth state listener
  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      showAuthPopup(false);
      initializeAfterLogin();
    } else {
      showAuthPopup(true);
    }
  });

  // Before unload, mark user offline
  window.addEventListener('beforeunload', async () => {
    if (currentUser) {
      await update(ref(db, `users/${currentUser.uid}`), { online: false, lastOnline: serverTimestamp() });
    }
  });

  // Initial loading message
  centerText.textContent = 'Loading...';

</script>
</body>
</html>