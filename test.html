<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SongVibe Recorder</title>
  <script src="https://cdn.jsdelivr.net/npm/ml5@0.12.2/dist/ml5.min.js"></script>
  <style>
    body {
      background: #12121b;
      color: #eee;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
        Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
      padding: 1rem;
    }

    h1 {
      margin-bottom: 1rem;
      font-weight: 600;
      text-shadow: 0 0 8px #0ff;
    }

    button {
      background: rgba(255 255 255 / 0.1);
      border: 1.5px solid #0ff;
      padding: 0.8rem 1.5rem;
      border-radius: 12px;
      color: #0ff;
      font-size: 1.1rem;
      margin: 0.5rem;
      cursor: pointer;
      user-select: none;
      transition: background 0.3s ease;
    }

    button:disabled {
      color: #222;
      border-color: #222;
      cursor: not-allowed;
      background: transparent;
    }

    #result {
      margin-top: 1.5rem;
      font-size: 1.3rem;
      font-weight: 600;
      min-height: 2rem;
    }

    select {
      margin-top: 1rem;
      background: #222;
      color: #0ff;
      border: 1px solid #0ff;
      padding: 0.5rem 1rem;
      border-radius: 10px;
      font-size: 1.1rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>ðŸŽ¤ SongVibe Recorder</h1>
  <button id="recordBtn">Start Recording</button>
  <button id="stopBtn" disabled>Stop Recording</button>

  <audio id="audioPlayback" controls style="margin-top:1rem; display:none"></audio>

  <div id="result"></div>
  <div id="manualVibe" style="display:none;">
    <label for="vibeSelect">Pick your vibe if unclear:</label>
    <select id="vibeSelect">
      <option value="Happy">Happy</option>
      <option value="Sad">Sad</option>
      <option value="Calm">Calm</option>
      <option value="Energetic">Energetic</option>
      <option value="Angry">Angry</option>
      <option value="Chill">Chill</option>
    </select>
    <button id="confirmVibe">Confirm Vibe</button>
  </div>

  <script>
    let mediaRecorder;
    let audioChunks = [];
    let audioBlob;
    let audioUrl;

    const recordBtn = document.getElementById("recordBtn");
    const stopBtn = document.getElementById("stopBtn");
    const audioPlayback = document.getElementById("audioPlayback");
    const resultDiv = document.getElementById("result");
    const manualVibeDiv = document.getElementById("manualVibe");
    const vibeSelect = document.getElementById("vibeSelect");
    const confirmVibeBtn = document.getElementById("confirmVibe");

    let classifier;
    let isClassifying = false;

    recordBtn.onclick = async () => {
      resultDiv.textContent = "ðŸŽ™ï¸ Recording...";
      recordBtn.disabled = true;
      stopBtn.disabled = false;
      manualVibeDiv.style.display = "none";
      audioPlayback.style.display = "none";

      audioChunks = [];

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

        mediaRecorder.onstop = async () => {
          audioBlob = new Blob(audioChunks, { type: "audio/webm" });
          audioUrl = URL.createObjectURL(audioBlob);
          audioPlayback.src = audioUrl;
          audioPlayback.style.display = "block";

          resultDiv.textContent = "Analyzing vibe...";
          await analyzeVibe(audioBlob);
        };
      } catch (err) {
        resultDiv.textContent = "âš ï¸ Error accessing microphone.";
        recordBtn.disabled = false;
        stopBtn.disabled = true;
      }
    };

    stopBtn.onclick = () => {
      if (mediaRecorder && mediaRecorder.state !== "inactive") {
        mediaRecorder.stop();
        recordBtn.disabled = false;
        stopBtn.disabled = true;
      }
    };

    async function analyzeVibe(blob) {
      if (!classifier) {
        resultDiv.textContent = "Loading ML model...";
        classifier = await ml5.soundClassifier('SpeechCommands18w', { probabilityThreshold: 0.1 });
      }

      isClassifying = true;

      // ml5 soundClassifier works on live mic or audio stream, not blob, so trick time:
      // We will use Web Audio API to decode blob, play silently, and classify live stream.

      // Decode blob to AudioBuffer
      const audioCtx = new AudioContext();
      const arrayBuffer = await blob.arrayBuffer();
      const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

      // Play the audio silently through AudioContext
      const source = audioCtx.createBufferSource();
      source.buffer = audioBuffer;

      const dest = audioCtx.createMediaStreamDestination();
      source.connect(dest);
      source.start();

      // Classify from dest.stream
      classifier.classify(dest.stream, (error, results) => {
        if (error) {
          console.error(error);
          resultDiv.textContent = "âš ï¸ Error classifying audio.";
          isClassifying = false;
          return;
        }
        if (!results || results.length === 0) {
          resultDiv.textContent = "No vibe detected.";
          isClassifying = false;
          manualVibeDiv.style.display = "block";
          return;
        }

        // Pick highest confidence result
        const top = results[0];
        // For demo, treat these labels as vibes:
        const vibesMap = {
          'happy': "ðŸ˜Š Happy",
          'sad': "ðŸ˜¢ Sad",
          'neutral': "ðŸ˜ Neutral",
          'angry': "ðŸ˜  Angry",
          'calm': "ðŸ˜Œ Calm",
          'excited': "âš¡ Energetic",
        };

        // ml5 model labels are limited, so fallback to manual
        let vibeText = vibesMap[top.label.toLowerCase()] || null;

        if (top.confidence > 0.7 && vibeText) {
          resultDiv.textContent = `Detected Vibe: ${vibeText} (Confidence: ${(top.confidence * 100).toFixed(1)}%)`;
          manualVibeDiv.style.display = "none";
        } else {
          resultDiv.textContent = "Vibe unclear, please select manually.";
          manualVibeDiv.style.display = "block";
        }

        isClassifying = false;
        audioCtx.close();
        source.stop();
      });
    }

    confirmVibeBtn.onclick = () => {
      const chosen = vibeSelect.value;
      resultDiv.textContent = `Manual Vibe Selected: ${chosen}`;
      manualVibeDiv.style.display = "none";
    };
  </script>
</body>
</html>