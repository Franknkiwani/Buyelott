<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <title>Promote Your DLS Ad & Analytics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ===== iOS-ish dark theme ===== */
    :root { --accent:#00ffb3; --bg:#000; --panel:#111; --text-muted:#666; }
    * { box-sizing:border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
      background: var(--bg);
      color: #fff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 20px;
      gap: 20px;
    }
    h1 {
      font-size: 1.3rem;
      margin: 0 0 10px 0;
      font-weight: 700;
      text-align: center;
    }
    .container {
      display: flex;
      gap: 20px;
      max-width: 1100px;
      margin: 0 auto;
      flex-wrap: wrap;
    }
    .panel {
      background: var(--panel);
      border-radius: 20px;
      box-shadow: 0 0 18px rgba(255, 255, 255, 0.05);
      overflow: hidden;
      padding: 20px;
      flex: 1 1 480px;
      min-width: 300px;
      display: flex;
      flex-direction: column;
      max-height: 80vh;
    }
    /* Promote panel specifics */
    #promotePanel {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    #previewBox {
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 0 15px rgba(0, 255, 179, 0.2);
      flex-shrink: 0;
      max-height: 210px;
    }
    #previewBox img {
      width: 100%;
      height: 210px;
      object-fit: cover;
      display: block;
    }
    .info {
      padding: 12px 0 0 0;
    }
    .desc {
      font-size: 1.05rem;
      color: #ccc;
      margin: 0 0 6px 0;
    }
    .price {
      color: var(--accent);
      font-size: 1.3rem;
      font-weight: 600;
      margin: 0;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
    }
    select.field {
      padding: 12px;
      border-radius: 12px;
      border: none;
      background: #1c1c1c;
      color: #fff;
      font-size: 1rem;
      width: 100%;
      cursor: pointer;
    }
    .btn {
      padding: 13px;
      text-align: center;
      font-weight: 700;
      text-transform: uppercase;
      border: none;
      border-radius: 12px;
      background: var(--accent);
      color: #000;
      cursor: pointer;
      transition: 0.2s;
      user-select: none;
    }
    .btn:hover {
      background: #00e6a6;
    }
    .btn.alt {
      background: #444;
      color: #fff;
      margin-top: -10px;
      font-size: 0.9rem;
    }
    .hidden {
      display: none !important;
    }
    .status {
      font-size: 0.9rem;
      color: #ccc;
      text-align: center;
      max-width: 420px;
      min-height: 1.3em;
    }
    .paypal-box {
      margin-top: 12px;
    }

    /* Analytics panel */
    #analyticsPanel {
      overflow-y: auto;
      color: #eee;
      font-size: 0.95rem;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    #analyticsPanel h2 {
      margin-top: 0;
      color: var(--accent);
      font-weight: 700;
      text-align: center;
    }
    .analytics-summary {
      display: flex;
      justify-content: space-around;
      gap: 10px;
      border-bottom: 1px solid #333;
      padding-bottom: 12px;
    }
    .analytics-summary > div {
      flex: 1;
      background: #222;
      border-radius: 12px;
      padding: 10px;
      text-align: center;
      box-shadow: inset 0 0 5px rgba(0,255,179,0.3);
    }
    .analytics-summary strong {
      display: block;
      font-size: 1.4rem;
      color: var(--accent);
      margin-bottom: 4px;
    }
    .ads-list {
      flex: 1;
      overflow-y: auto;
    }
    .ad-item {
      background: #222;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      box-shadow: inset 0 0 6px rgba(0,255,179,0.2);
    }
    .ad-title {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--accent);
      margin-bottom: 6px;
    }
    .ad-stats {
      font-size: 0.9rem;
      color: #aaa;
      display: flex;
      justify-content: space-between;
    }
    .orders-section {
      margin-top: 12px;
      color: #bbb;
    }
    .order-item {
      background: #111;
      border-radius: 10px;
      padding: 8px;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }
    /* Loading overlay */
    #loadingOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
      color: var(--accent);
      font-size: 1.4rem;
      font-weight: 700;
      user-select: none;
    }
    #loadingOverlay .spinner {
      border: 4px solid #222;
      border-top: 4px solid var(--accent);
      border-radius: 50%;
      width: 48px;
      height: 48px;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

<div id="loadingOverlay">
  <div class="spinner"></div>
  Loading data...
</div>

<h1>Promote Your Account</h1>

<div class="container">
  <!-- Left Panel: Promote -->
  <section id="promotePanel" class="panel" aria-label="Promotion Section">
    <div id="previewBox">
      <img id="previewImg" src="https://via.placeholder.com/400x300?text=Loading..." alt="Ad preview" />
      <div class="info">
        <p class="desc" id="previewDesc">Loading description…</p>
        <p class="price" id="previewPrice">$0.00</p>
      </div>
    </div>

    <label for="viewsSelect">Select Views Package</label>
    <select id="viewsSelect" name="os0" class="field" disabled aria-describedby="statusMsg">
      <option value="1000 views">1000 views — $1.00</option>
      <option value="5000 views">5000 views — $5.00</option>
      <option value="10000 views">10000 views — $9.00</option>
    </select>

    <button class="btn alt" id="freeBtn">Use FREE $0.100 Credit (100 views)</button>

    <div class="paypal-box hidden" id="paypalBox">
      <form
        action="https://www.paypal.com/cgi-bin/webscr"
        method="post"
        target="_top"
        id="paypalForm"
      >
        <input type="hidden" name="cmd" value="_s-xclick" />
        <input type="hidden" name="hosted_button_id" value="CYPBY27MX3SY6" />
        <input type="hidden" name="currency_code" value="USD" />
        <!-- hidden select synced with main select -->
        <select name="os0" id="paypalViewsSelect" style="display:none;">
          <option value="1000 views">1000 views</option>
          <option value="5000 views">5000 views</option>
          <option value="10000 views">10000 views</option>
        </select>
        <input
          type="image"
          src="https://www.paypalobjects.com/en_US/i/btn/btn_paynow_SM.gif"
          border="0"
          name="submit"
          title="PayPal - The safer, easier way to pay online!"
          alt="Buy Now"
        />
      </form>
    </div>
    
    <div class="status" id="statusMsg" role="status" aria-live="polite"></div>
  </section>

  <!-- Right Panel: Analytics -->
  <section id="analyticsPanel" class="panel" aria-label="Ads Analytics Section">
    <h2>Your Ads Performance</h2>
    <div class="analytics-summary" aria-live="polite">
      <div>
        <strong id="totalViews">0</strong>
        Views Remaining
      </div>
      <div>
        <strong id="totalClicks">0</strong>
        Clicks
      </div>
    </div>
    <div class="ads-list" id="adsList" aria-live="polite" tabindex="0">
      <!-- Ad items inserted here dynamically -->
    </div>
    <div class="orders-section" id="ordersSection">
      <h3>Orders</h3>
      <div id="ordersList" tabindex="0">
        <!-- Orders inserted here dynamically -->
      </div>
    </div>
  </section>
</div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getDatabase, ref, get, child, update, set } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

const firebaseConfig = {
  apiKey:"AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
  authDomain:"itzhoyoo-f9f7e.firebaseapp.com",
  databaseURL:"https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
  projectId:"itzhoyoo-f9f7e",
  storageBucket:"itzhoyoo-f9f7e.filestorage.app",
  messagingSenderId:"1094792075584",
  appId:"1:1094792075584:web:d49e9c3f899d3cd31082a5",
  measurementId:"G-LLT6F9WRKH"
};

const app  = initializeApp(firebaseConfig);
const db   = getDatabase(app);
const auth = getAuth(app);

/* DOM refs */
const previewImg   = document.getElementById("previewImg");
const previewDesc  = document.getElementById("previewDesc");
const previewPrice = document.getElementById("previewPrice");
const statusMsg    = document.getElementById("statusMsg");
const viewsSelect  = document.getElementById("viewsSelect");
const paypalBox    = document.getElementById("paypalBox");
const paypalViewsSelect = document.getElementById("paypalViewsSelect");
const freeBtn      = document.getElementById("freeBtn");
const loadingOverlay = document.getElementById("loadingOverlay");

const totalViewsEl = document.getElementById("totalViews");
const totalClicksEl = document.getElementById("totalClicks");
const adsList = document.getElementById("adsList");
const ordersList = document.getElementById("ordersList");

/* Helpers */
const params  = new URLSearchParams(location.search);
const adId    = params.get("id");
const FREE_VIEWS = 100;

let user      = null;
let adData    = null;
let freeUsed  = false;

function fmt(n){ return n.toLocaleString(); }

async function loadAd() {
  if(!adId) {
    statusMsg.textContent = "❌ Missing ?id in URL";
    viewsSelect.disabled = true;
    freeBtn.disabled = true;
    return null;
  }
  try {
    const snap = await get(child(ref(db), `dlsaccounts/${adId}`));
    if(!snap.exists()) {
      statusMsg.textContent = "❌ Ad not found";
      viewsSelect.disabled = true;
      freeBtn.disabled = true;
      return null;
    }
    adData = snap.val();
    previewImg.src = adData.images?.[0] || "https://via.placeholder.com/400x300?text=No+Image";
    previewDesc.textContent = adData.description?.slice(0,60) || "No description";
    previewPrice.textContent = `$${adData.price || "0.00"}`;
    return adData;
  } catch(e) {
    console.error(e);
    statusMsg.textContent = "🚨 Error loading ad";
    viewsSelect.disabled = true;
    freeBtn.disabled = true;
    return null;
  }
}

async function onUserAuth(u) {
  if (!u) {
    statusMsg.textContent = "⚠️ Please sign in to promote.";
    viewsSelect.disabled = true;
    freeBtn.disabled = true;
    paypalBox.classList.add("hidden");
    loadingOverlay.style.display = 'none';
    showNoAdsAnalytics();
    return;
  }
  user = u;

  const usnap = await get(child(ref(db), `users/${user.uid}/usedFreeAds`));
  freeUsed = usnap.exists() && usnap.val() === true;
  if (freeUsed) freeBtn.classList.add("hidden");

  viewsSelect.disabled = false;
  paypalBox.classList.remove("hidden");
  statusMsg.textContent = "Select a views package and click PayPal to pay.";

  await loadUserAnalytics();

  loadingOverlay.style.display = "none";
}

function showNoAdsAnalytics() {
  adsList.innerHTML = '<p style="color:#666;text-align:center;">No ads found.</p>';
  ordersList.innerHTML = '<p style="color:#666;text-align:center;">No orders were made.</p>';
  totalViewsEl.textContent = "0";
  totalClicksEl.textContent = "0";
}

viewsSelect.addEventListener("change", () => {
  paypalViewsSelect.value = viewsSelect.value;

  const views = Number(viewsSelect.value.split(" ")[0]);
  const prices = {1000: 1.00, 5000: 5.00, 10000: 9.00};
  const price = prices[views] || 0;

  statusMsg.textContent = `Selected ${fmt(views)} views for $${price.toFixed(2)}. Click PayPal to pay.`;
});

freeBtn.addEventListener("click", async () => {
  if (freeUsed) {
    statusMsg.textContent = "😅 Free credit already used.";
    return;
  }
  try {
    await saveCampaign({ views: FREE_VIEWS, isFree: true, pricePaid: 0 });
    await update(ref(db, `users/${user.uid}`), { usedFreeAds: true });
    freeBtn.classList.add("hidden");
    statusMsg.textContent = `✅ Free promo live! ${fmt(FREE_VIEWS)} views coming your way.`;
    await loadUserAnalytics();
  } catch (e) {
    console.error(e);
    statusMsg.textContent = "❌ Failed to start free promo.";
  }
});

async function saveCampaign({ views, isFree, pricePaid }) {
  if (!user || !adId) return;
  const key = `${adId}_${user.uid}`;
  await set(ref(db, `dlsaccountsads/${key}`), {
    uid: user.uid,
    adId,
    viewsRemaining: views,
    viewsPerDay: views,
    isFree,
    pricePaid,
    clicks: 0,
    createdAt: Date.now(),
  });
}

async function loadUserAnalytics() {
  adsList.innerHTML = "";
  ordersList.innerHTML = "";
  totalViewsEl.textContent = "0";
  totalClicksEl.textContent = "0";

  try {
    const adsSnap = await get(ref(db, "dlsaccountsads"));
    if (!adsSnap.exists()) {
      showNoAdsAnalytics();
      return;
    }

    const adsData = adsSnap.val();
    const userAds = Object.entries(adsData).filter(([key, val]) => val.uid === user.uid);

    if(userAds.length === 0) {
      showNoAdsAnalytics();
      return;
    }

    let totalViews = 0;
    let totalClicks = 0;

    for(const [key, ad] of userAds) {
      totalViews += ad.viewsRemaining || 0;
      totalClicks += ad.clicks || 0;

      const el = document.createElement("div");
      el.className = "ad-item";
      el.innerHTML = `
        <div class="ad-title">Ad ID: ${ad.adId}</div>
        <div class="ad-stats">
          <span>Views Remaining: ${fmt(ad.viewsRemaining || 0)}</span>
          <span>Clicks: ${fmt(ad.clicks || 0)}</span>
        </div>
      `;
      adsList.appendChild(el);
    }

    totalViewsEl.textContent = fmt(totalViews);
    totalClicksEl.textContent = fmt(totalClicks);

    await loadOrdersForUserAds(userAds.map(([key,val]) => val.adId));

  } catch (e) {
    console.error(e);
    adsList.innerHTML = '<p style="color:#f55;text-align:center;">Error loading ads analytics.</p>';
    ordersList.innerHTML = '<p style="color:#f55;text-align:center;">Error loading orders.</p>';
  }
}

async function loadOrdersForUserAds(adIds) {
  try {
    if(adIds.length === 0) {
      ordersList.innerHTML = '<p style="color:#666;text-align:center;">No orders were made.</p>';
      return;
    }
    const ordersSnap = await get(ref(db, "dlsaccountsorders"));
    if (!ordersSnap.exists()) {
      ordersList.innerHTML = '<p style="color:#666;text-align:center;">No orders were made.</p>';
      return;
    }

    const ordersData = ordersSnap.val();

    const filteredOrders = Object.values(ordersData).filter(order =>
      adIds.includes(order.adId) && order.sellerUid === user.uid
    );

    if (filteredOrders.length === 0) {
      ordersList.innerHTML = '<p style="color:#666;text-align:center;">No orders were made.</p>';
      return;
    }

    filteredOrders.sort((a,b) => (b.createdAt || 0) - (a.createdAt || 0));

    filteredOrders.forEach(order => {
      const el = document.createElement("div");
      el.className = "order-item";
      el.textContent = `Order for Ad ID ${order.adId} - Buyer: ${order.uid || 'Unknown'} - Qty: ${order.quantity || 1} - Date: ${new Date(order.createdAt).toLocaleString()}`;
      ordersList.appendChild(el);
    });
  } catch (e) {
    console.error(e);
    ordersList.innerHTML = '<p style="color:#f55;text-align:center;">Error loading orders.</p>';
  }
}

/* LOCAL STORAGE: Save purchase info before redirect to PayPal */
const paypalForm = document.getElementById("paypalForm");
paypalForm.addEventListener("submit", (e) => {
  if(!user) {
    e.preventDefault();
    statusMsg.textContent = "⚠️ You must be signed in to pay.";
    return;
  }

  const views = Number(viewsSelect.value.split(" ")[0]);
  const prices = {1000: 1.00, 5000: 5.00, 10000: 9.00};
  const price = prices[views] || 0;

  statusMsg.textContent = `🛒 Saving purchase info locally: ${fmt(views)} views for $${price.toFixed(2)}.`;

  localStorage.setItem('pendingPurchase', JSON.stringify({
    userId: user.uid,
    adId,
    viewsPurchased: views,
    pricePaid: price,
    timestamp: Date.now()
  }));

  // No preventDefault here — let PayPal redirect happen
});

/* Initialize everything */
async function init() {
  loadingOverlay.style.display = "flex";
  await loadAd();
  onAuthStateChanged(auth, onUserAuth);
}

init();
</script>
</body>
</html>