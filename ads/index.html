<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Promote Your DLS Ad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* ===== iOS-ish dark theme ===== */
    :root { --accent:#00ffb3; --bg:#000; --panel:#111; }
    * { box-sizing:border-box; }
    body{
      margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
      background:var(--bg); color:#fff; display:flex; flex-direction:column;
      align-items:center; padding:32px 20px; gap:28px;
    }
    h1{font-size:1.8rem;margin:0;font-weight:700;text-align:center;}
    .card{background:var(--panel);border-radius:20px;box-shadow:0 0 18px rgba(255,255,255,.05);
          overflow:hidden;max-width:420px;width:100%;}
    .card img{width:100%;height:200px;object-fit:cover;}
    .info{padding:16px;}
    .desc{font-size:1.05rem;color:#ccc;margin-bottom:6px;}
    .price{color:var(--accent);font-size:1.3rem;font-weight:600;margin:0;}
    .field,.btn{width:100%;max-width:420px;}
    .field{padding:12px;border-radius:12px;border:none;background:#1c1c1c;
           color:#fff;font-size:1rem;}
    .field:focus{outline:2px solid var(--accent);}
    .btn{padding:13px;text-align:center;font-weight:700;text-transform:uppercase;
         border:none;border-radius:12px;background:var(--accent);color:#000;
         cursor:pointer;transition:.2s;}
    .btn:hover{background:#00e6a6;}
    .btn.alt{background:#444;color:#fff;margin-top:-10px;font-size:.9rem;}
    .hidden{display:none !important;}
    .status{font-size:.9rem;color:#ccc;text-align:center;max-width:420px;}
    .paypal-box{margin-top:12px;}
  </style>
</head>
<body>

  <h1>Promote Your DLS Ad</h1>

  <!-- === Ad Preview === -->
  <div class="card" id="previewBox">
    <img id="previewImg" src="https://via.placeholder.com/400x300?text=Loading..." alt="">
    <div class="info">
      <p class="desc" id="previewDesc">Loading description…</p>
      <p class="price" id="previewPrice">$0.00</p>
    </div>
  </div>

  <!-- === Views / Pricing === -->
  <input type="number" class="field" id="viewsInput"
         placeholder="Views per day (1 – 10 000)" min="1" max="10000">

  <div class="status" id="costDisplay">Daily Cost: $0.000</div>

  <!-- === Action Buttons === -->
  <button class="btn" id="payBtn">Pay to Promote</button>
  <button class="btn alt" id="freeBtn">Use FREE $0.100 Credit (100 views)</button>

  <!-- PayPal form (hidden until needed) -->
  <div class="paypal-box hidden" id="paypalBox">
    <form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top" id="paypalForm">
      <input type="hidden" name="cmd" value="_s-xclick" />
      <input type="hidden" name="hosted_button_id" value="CYPBY27MX3SY6" />
      <input type="hidden" name="currency_code" value="USD" />
      <!-- dynamic amount -->
      <input type="hidden" name="amount" id="ppAmount" value="0.00" />
      <input type="image"
             src="https://www.paypalobjects.com/en_US/i/btn/btn_paynow_SM.gif"
             border="0" name="submit"
             title="PayPal - The safer, easier way to pay online!"
             alt="Buy Now" />
    </form>
  </div>

  <div class="status" id="statusMsg"></div>

<script type="module">
/* ---------- Firebase setup ---------- */
import { initializeApp }         from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getDatabase, ref,
         get, child, update, set } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
import { getAuth, onAuthStateChanged }
       from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

const firebaseConfig = {
  apiKey:"AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
  authDomain:"itzhoyoo-f9f7e.firebaseapp.com",
  databaseURL:"https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
  projectId:"itzhoyoo-f9f7e",
  storageBucket:"itzhoyoo-f9f7e.filestorage.app",
  messagingSenderId:"1094792075584",
  appId:"1:1094792075584:web:d49e9c3f899d3cd31082a5",
  measurementId:"G-LLT6F9WRKH"
};

const app  = initializeApp(firebaseConfig);
const db   = getDatabase(app);
const auth = getAuth(app);

/* ---------- DOM refs ---------- */
const previewImg   = document.getElementById("previewImg");
const previewDesc  = document.getElementById("previewDesc");
const previewPrice = document.getElementById("previewPrice");
const viewsInput   = document.getElementById("viewsInput");
const costDisplay  = document.getElementById("costDisplay");
const payBtn       = document.getElementById("payBtn");
const freeBtn      = document.getElementById("freeBtn");
const statusMsg    = document.getElementById("statusMsg");
const paypalBox    = document.getElementById("paypalBox");
const ppAmount     = document.getElementById("ppAmount");

/* ---------- Helpers ---------- */
const params  = new URLSearchParams(location.search);
const adId    = params.get("id");
const CPC     = 0.001;            // cost per view in USD
const FREE_VIEWS = 100;           // freebies for newbies

let user      = null;             // Firebase user
let adData    = null;             // product data
let freeUsed  = false;            // whether user spent free credit

function fmt(n){ return n.toLocaleString(); }

/* ---------- Load product ---------- */
async function loadAd() {
  if(!adId) { statusMsg.textContent="❌ Missing ?id in URL"; return; }
  try{
    const snap = await get(child(ref(db),`dlsaccounts/${adId}`));
    if(!snap.exists()){ statusMsg.textContent="❌ Ad not found"; return; }
    adData = snap.val();
    previewImg.src   = adData.images?.[0] ||
                       "https://via.placeholder.com/400x300?text=No+Image";
    previewDesc.textContent = adData.description?.slice(0,60) || "No description";
    previewPrice.textContent = `$${adData.price||"0.00"}`;
  }catch(e){ console.error(e); statusMsg.textContent="🚨 Error loading ad"; }
}

/* ---------- Auth & free-credit check ---------- */
onAuthStateChanged(auth, async (u)=>{
  if(!u){ statusMsg.textContent="⚠️ Please sign in to promote."; payBtn.disabled=true; freeBtn.disabled=true; return; }
  user=u;
  // Check if free credit already used
  const usnap = await get(child(ref(db),`users/${user.uid}/usedFreeAds`));
  freeUsed = usnap.exists() && usnap.val()===true;
  if(freeUsed) freeBtn.classList.add("hidden");
});

/* ---------- Live cost calc ---------- */
viewsInput.addEventListener("input", ()=>{
  const views = Number(viewsInput.value);
  const cost  = isNaN(views)?0:views*CPC;
  costDisplay.textContent = `Daily Cost: $${cost.toFixed(3)}`;
});

/* ---------- Save promotion to DB ---------- */
async function saveCampaign({views, isFree, pricePaid}){
  const key = `${adId}_${user.uid}`;
  await set(ref(db,`dlsaccountsads/${key}`),{
    uid:user.uid,
    adId,
    viewsRemaining: views,
    viewsPerDay:    views,
    isFree,
    pricePaid,
    createdAt: Date.now()
  });
}

/* ---------- FREE button ---------- */
freeBtn.addEventListener("click", async ()=>{
  if(freeUsed){ statusMsg.textContent="😅 Free credit already used."; return; }
  try{
    await saveCampaign({views:FREE_VIEWS,isFree:true,pricePaid:0});
    await update(ref(db,`users/${user.uid}`),{ usedFreeAds:true });
    freeBtn.classList.add("hidden");
    statusMsg.textContent=`✅ Free promo live! ${fmt(FREE_VIEWS)} views coming your way.`;
  }catch(e){ console.error(e); statusMsg.textContent="❌ Failed to start free promo."; }
});

/* ---------- PAY button ---------- */
payBtn.addEventListener("click", ()=>{
  const views = Number(viewsInput.value);
  if(isNaN(views)||views<1||views>10000){
    statusMsg.textContent="❌ Enter 1–10 000 views first."; return;
  }
  const price = (views*CPC).toFixed(2);
  ppAmount.value = price;                     // put cost in the PayPal form
  paypalBox.classList.remove("hidden");       // reveal PayPal button
  statusMsg.textContent=`Click PayPal to pay $${price}. After payment you’ll start receiving ${fmt(views)} views/day.`;
  
  // 👉 You MAY want to wait for PayPal IPN / webhook before saving.
  // For demo purposes we save immediately so you can see it in Firebase.
  saveCampaign({views,isFree:false,pricePaid:+price})
     .then(()=>console.log("Paid campaign saved"))
     .catch(e=>console.error("DB save failed",e));
});

/* ---------- init ---------- */
loadAd();
</script>
</body>
</html>