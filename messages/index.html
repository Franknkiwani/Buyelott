<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat with Seller</title>
  <style>
    /* Reset + base */
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0; padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      background-color: #121212;
      color: #eee;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background-color: #1da1f2;
      color: #fff;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      position: fixed;
      width: 100%;
      top: 0; left: 0;
      z-index: 1000;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    header img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 2px solid #fff;
      object-fit: cover;
      flex-shrink: 0;
    }
    header .seller-name {
      font-weight: 700;
      font-size: 1.2rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #chatContainer {
      flex: 1;
      margin-top: 64px; /* header height + some spacing */
      overflow-y: auto;
      padding: 12px 12px 80px; /* bottom padding for input */
      scroll-behavior: smooth;
    }
    .message {
      max-width: 75%;
      margin-bottom: 12px;
      padding: 10px 14px;
      border-radius: 20px;
      font-size: 1rem;
      line-height: 1.3;
      word-wrap: break-word;
      position: relative;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      user-select: text;
    }
    .message .timestamp {
      font-size: 0.7rem;
      color: #ccc;
      position: absolute;
      bottom: 4px;
      right: 12px;
      opacity: 0.7;
    }
    /* Messages sent by current user */
    .message.self {
      background-color: #1da1f2;
      color: #000;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }
    /* Messages from seller */
    .message.seller {
      background-color: #333;
      color: #eee;
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }
    /* System messages */
    .message.system {
      background: transparent;
      color: #888;
      text-align: center;
      font-style: italic;
      max-width: 100%;
      margin: 16px auto;
    }

    form#chatForm {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background-color: #181818;
      display: flex;
      padding: 8px 12px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.6);
      align-items: center;
      gap: 8px;
      z-index: 1100;
    }
    form#chatForm input[type="text"] {
      flex: 1;
      background: #222;
      border: none;
      padding: 12px 16px;
      border-radius: 24px;
      color: #eee;
      font-size: 1rem;
      outline: none;
    }
    form#chatForm button {
      background-color: #1da1f2;
      border: none;
      border-radius: 24px;
      padding: 12px 20px;
      color: #000;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.25s ease;
    }
    form#chatForm button:disabled {
      background-color: #555;
      cursor: not-allowed;
    }
    form#chatForm button:hover:not(:disabled) {
      background-color: #0c7abf;
      color: #fff;
    }

    /* Scrollbar styles for mobile */
    #chatContainer::-webkit-scrollbar {
      width: 6px;
    }
    #chatContainer::-webkit-scrollbar-thumb {
      background-color: #1da1f2;
      border-radius: 3px;
    }
  </style>
</head>
<body>

<header>
  <img id="sellerAvatar" src="https://via.placeholder.com/40?text=ðŸ‘¤" alt="Seller Avatar" />
  <div class="seller-name" id="sellerName">Loading seller...</div>
</header>

<div id="chatContainer" role="log" aria-live="polite" aria-relevant="additions"></div>

<form id="chatForm" aria-label="Send message" autocomplete="off">
  <input type="text" id="messageInput" placeholder="Type a message..." required aria-required="true" />
  <button type="submit" id="sendBtn" disabled>Send</button>
</form>

<script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    storageBucket: "itzhoyoo-f9f7e.filestorage.app",
    messagingSenderId: "1094792075584",
    appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  const sellerAvatarEl = document.getElementById('sellerAvatar');
  const sellerNameEl = document.getElementById('sellerName');
  const chatContainer = document.getElementById('chatContainer');
  const chatForm = document.getElementById('chatForm');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');

  let currentUser = null;
  let sellerUid = null;
  let sellerName = 'Seller';
  let sellerAvatar = '';
  let productId = null;
  let chatId = null;

  // Helper to escape HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Format timestamp nicely (e.g. 3:45 PM)
  function formatTimestamp(ts) {
    const date = new Date(ts);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  // Determine chatId from two uids (sort them alphabetically)
  function getChatId(uid1, uid2) {
    return uid1 < uid2 ? uid1 + '_' + uid2 : uid2 + '_' + uid1;
  }

  // Scroll chat container to bottom
  function scrollToBottom() {
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  // Add message bubble
  function addMessageBubble(text, senderUid, timestamp) {
    const div = document.createElement('div');
    div.classList.add('message');

    if (senderUid === currentUser.uid) {
      div.classList.add('self');
    } else if (senderUid === sellerUid) {
      div.classList.add('seller');
    } else {
      div.classList.add('system');
    }

    div.innerHTML = `
      ${escapeHtml(text)}
      <span class="timestamp">${formatTimestamp(timestamp)}</span>
    `;

    chatContainer.appendChild(div);
  }

  // Listen for auth state changes
  auth.onAuthStateChanged(user => {
    if (!user) {
      alert('You must log in to chat.');
      window.location.href = '/login'; // change if needed
      return;
    }
    currentUser = user;

    // Get productId from URL
    const urlParams = new URLSearchParams(window.location.search);
    productId = urlParams.get('product');
    if (!productId) {
      alert('Missing product id in URL.');
      return;
    }

    // Load product info to get seller UID, name, avatar
    db.ref(`/dlsaccounts/${productId}`).once('value').then(snapshot => {
      const product = snapshot.val();
      if (!product) {
        alert('Product not found.');
        return;
      }
      sellerUid = product.seller?.uid;
      sellerName = product.seller?.username || 'Seller';
      sellerAvatar = product.seller?.avatar || 'https://via.placeholder.com/40?text=ðŸ‘¤';

      sellerNameEl.textContent = sellerName;
      sellerAvatarEl.src = sellerAvatar;

      if (!sellerUid) {
        alert('Seller info missing.');
        return;
      }

      chatId = getChatId(currentUser.uid, sellerUid);

      // Listen for new messages
      const messagesRef = db.ref(`/chats/${chatId}/messages`).limitToLast(100);
      messagesRef.off(); // just in case
      messagesRef.on('child_added', snapshot => {
        const msg = snapshot.val();
        if (msg && msg.text && msg.sender && msg.timestamp) {
          addMessageBubble(msg.text, msg.sender, msg.timestamp);
          scrollToBottom();
        }
      });

      sendBtn.disabled = false;
      messageInput.focus();
    });
  });

  // Send message handler
  chatForm.addEventListener('submit', e => {
    e.preventDefault();
    const text = messageInput.value.trim();
    if (!text) return;

    const messagesRef = db.ref(`/chats/${chatId}/messages`);
    const newMsgRef = messagesRef.push();

    newMsgRef.set({
      sender: currentUser.uid,
      text,
      timestamp: Date.now()
    }).then(() => {
      messageInput.value = '';
      messageInput.focus();
    }).catch(err => {
      alert('Error sending message. Try again.');
      console.error(err);
    });
  });
</script>
</body>
</html>