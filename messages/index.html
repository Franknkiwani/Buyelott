<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat with Seller</title>
  <style>
    body {
      margin: 0; padding: 0;
      background: #121212;
      color: #eee;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      display: flex; flex-direction: column; height: 100vh;
    }
    header {
      background: #1da1f2;
      color: #fff;
      padding: 12px 16px;
      display: flex; align-items: center; gap: 12px;
      position: fixed; width: 100%; top: 0; left: 0; z-index: 1000;
      border-bottom: 1px solid #0c7ddb;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    header img {
      width: 42px; height: 42px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #fff;
    }
    #sellerName {
      font-weight: 700; font-size: 1.2rem;
      overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
      flex: 1;
    }
    #productPreview {
      margin-top: 64px; /* header height */
      background: #181818;
      border-bottom: 1px solid #222;
      padding: 12px 16px;
      z-index: 900;
      position: sticky;
      top: 64px;
    }
    #productPreview a {
      color: inherit; text-decoration: none;
      display: flex; align-items: center; gap: 12px;
    }
    #productPreview img {
      width: 60px; height: 60px;
      border-radius: 10px;
      object-fit: cover;
      background: #222;
    }
    #productPreview strong {
      font-size: 16px;
    }
    #productPreview p {
      color: #aaa; font-size: 13px; margin-top: 4px;
    }
    #chatContainer {
      flex: 1;
      overflow-y: auto;
      padding: 12px 12px 80px;
      scroll-behavior: smooth;
      background: #121212;
    }
    .message {
      max-width: 80%;
      padding: 12px 16px;
      margin-bottom: 10px;
      font-size: 15px;
      line-height: 1.4;
      border-radius: 20px;
      position: relative;
      word-wrap: break-word;
      word-break: break-word;
      user-select: text;
    }
    .message.self {
      margin-left: auto;
      background: linear-gradient(135deg, #0f7cf9, #30a0f9);
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .message.seller {
      margin-right: auto;
      background: #1a1a1a;
      color: #eee;
      border-bottom-left-radius: 4px;
    }
    .message.system {
      background: none;
      color: #666;
      text-align: center;
      font-style: italic;
      max-width: 100%;
      margin: 24px auto 12px;
      user-select: none;
    }
    .message .timestamp {
      font-size: 10px;
      opacity: 0.5;
      position: absolute;
      bottom: 4px;
      right: 12px;
      user-select: none;
    }
    .message a {
      color: #1da1f2;
      text-decoration: underline;
      word-break: break-word;
    }
    #chatForm {
      position: fixed;
      bottom: 0; left: 0; width: 100%;
      padding: 8px 12px;
      background: #181818;
      display: flex;
      gap: 8px;
      box-shadow: 0 -1px 8px rgba(0,0,0,0.6);
      z-index: 1100;
    }
    #messageInput {
      flex: 1;
      padding: 12px 16px;
      background: #222;
      border: none;
      border-radius: 24px;
      color: #eee;
      font-size: 1rem;
      outline: none;
    }
    #sendBtn {
      background: #1da1f2;
      color: #000;
      border: none;
      border-radius: 24px;
      padding: 12px 20px;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    #sendBtn:disabled {
      background: #444;
      cursor: not-allowed;
    }
    #sendBtn:hover:not(:disabled) {
      background: #2b8afc;
    }
  </style>
</head>
<body>

<header>
  <img id="sellerAvatar" src="https://via.placeholder.com/40?text=ðŸ‘¤" alt="Seller Avatar" />
  <div id="sellerName">Loading seller...</div>
</header>

<div id="productPreview"></div>

<div id="chatContainer"></div>

<form id="chatForm">
  <input id="messageInput" type="text" placeholder="Type a message..." autocomplete="off" required />
  <button id="sendBtn" type="submit" disabled>Send</button>
</form>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    storageBucket: "itzhoyoo-f9f7e.filestorage.app",
    messagingSenderId: "1094792075584",
    appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  const sellerAvatarEl = document.getElementById('sellerAvatar');
  const sellerNameEl = document.getElementById('sellerName');
  const productPreviewEl = document.getElementById('productPreview');
  const chatContainer = document.getElementById('chatContainer');
  const chatForm = document.getElementById('chatForm');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');

  let currentUser = null;
  let sellerUid = null;
  let sellerName = '';
  let sellerAvatar = '';
  let productId = null;
  let chatId = null;

  // Escape HTML to avoid XSS
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Format timestamp (e.g. 14:23)
  function formatTimestamp(ts) {
    const date = new Date(ts);
    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  // Consistent chat ID generation (sorted UIDs)
  function getChatId(uid1, uid2) {
    return uid1 < uid2 ? uid1 + '_' + uid2 : uid2 + '_' + uid1;
  }

  // Scroll chat to bottom
  function scrollToBottom() {
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  // Convert URLs in messages to clickable links
  function linkify(text) {
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    return text.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener">${url}</a>`);
  }

  // Add a chat message bubble
  function addMessageBubble(text, senderUid, timestamp) {
    const div = document.createElement('div');
    div.classList.add('message');

    if (senderUid === currentUser.uid) {
      div.classList.add('self');
    } else if (senderUid === sellerUid) {
      div.classList.add('seller');
    } else {
      div.classList.add('system');
    }

    const checkmark = senderUid === currentUser.uid ? `<span style="margin-left:6px;color:#1da1f2;font-size:12px;">âœ…</span>` : '';

    div.innerHTML = `
      <div>${linkify(escapeHtml(text))}${checkmark}</div>
      <span class="timestamp">${formatTimestamp(timestamp)}</span>
    `;

    chatContainer.appendChild(div);
  }

  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      alert('You must log in to chat.');
      window.location.href = '/login';
      return;
    }
    currentUser = user;

    // Get product ID from URL query
    const urlParams = new URLSearchParams(window.location.search);
    productId = urlParams.get('product');
    if (!productId) {
      alert('Missing product id in URL.');
      return;
    }

    // Load product info + seller data
    const productSnap = await db.ref(`/dlsaccounts/${productId}`).once('value');
    const product = productSnap.val();
    if (!product) {
      alert('Product not found.');
      return;
    }

    // Show product preview
    productPreviewEl.innerHTML = `
      <a href="https://cyberchat.online/product?id=${productId}" target="_blank" rel="noopener">
        <img src="${product.images?.[0] || 'https://via.placeholder.com/80'}" alt="Product" />
        <div>
          <strong>${escapeHtml(product.title || 'Unnamed Account')}</strong>
          <p>Tap to view product ðŸ‘‡</p>
        </div>
      </a>
    `;

    // Seller info
    sellerUid = product.seller?.uid;
    sellerName = product.seller?.username || 'Seller';
    sellerAvatar = product.seller?.avatar || 'https://via.placeholder.com/40?text=ðŸ‘¤';

    sellerNameEl.textContent = sellerName;
    sellerAvatarEl.src = sellerAvatar;

    if (!sellerUid) {
      alert('Seller info missing.');
      return;
    }

    // Generate consistent chat ID
    chatId = getChatId(currentUser.uid, sellerUid);

    // Ensure chat meta exists before listening for messages
    const metaRef = db.ref(`/chats/${chatId}/meta`);
    const metaSnap = await metaRef.once('value');

    if (!metaSnap.exists()) {
      // Create default meta object including lastReadTimes for both users
      await metaRef.set({
        users: {
          [currentUser.uid]: true,
          [sellerUid]: true,
        },
        lastMessage: '',
        lastTimestamp: 0,
        lastReadTimes: {
          [currentUser.uid]: 0,
          [sellerUid]: 0,
        }
      });
    }

    // Listen for last 100 messages
    const messagesRef = db.ref(`/chats/${chatId}/messages`).limitToLast(100);
    messagesRef.off(); // remove previous listeners to avoid duplicates
    messagesRef.on('child_added', (snapshot) => {
      const msg = snapshot.val();
      if (msg && msg.text && msg.sender && msg.timestamp) {
        addMessageBubble(msg.text, msg.sender, msg.timestamp);
        scrollToBottom();
      }
    });

    sendBtn.disabled = false;
    messageInput.focus();
  });

  chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = messageInput.value.trim();
    if (!text) return;

    const messagesRef = db.ref(`/chats/${chatId}/messages`);

    // Push new message
    const newMsgRef = messagesRef.push();
    const timestamp = Date.now();

    try {
      await newMsgRef.set({
        sender: currentUser.uid,
        text,
        timestamp
      });

      // Update meta after sending message
      const metaRef = db.ref(`/chats/${chatId}/meta`);

      // Use transaction to update meta atomically and prevent overwrites
      await metaRef.transaction((meta) => {
        if (meta === null) {
          // In case meta somehow missing, recreate it
          return {
            users: {
              [currentUser.uid]: true,
              [sellerUid]: true,
            },
            lastMessage: text,
            lastTimestamp: timestamp,
            lastReadTimes: {
              [currentUser.uid]: timestamp,
              [sellerUid]: 0,
            }
          };
        }
        meta.lastMessage = text;
        meta.lastTimestamp = timestamp;
        if (!meta.users) meta.users = {};
        meta.users[currentUser.uid] = true;
        meta.users[sellerUid] = true;
        if (!meta.lastReadTimes) meta.lastReadTimes = {};
        meta.lastReadTimes[currentUser.uid] = timestamp;
        if (!meta.lastReadTimes[sellerUid]) meta.lastReadTimes[sellerUid] = 0;
        return meta;
      });

      messageInput.value = '';
      messageInput.focus();

      // Auto-reply from seller if first message and current user is not seller
      const messagesSnap = await messagesRef.once('value');
      if (messagesSnap.numChildren() === 1 && currentUser.uid !== sellerUid) {
        const autoMsgRef = messagesRef.push();
        await autoMsgRef.set({
          sender: sellerUid,
          text: `Buy the account here:\nhttps://cyberchat.online/product?id=${productId}`,
          timestamp: Date.now()
        });
      }
    } catch (err) {
      alert('Error sending message. Try again.');
      console.error(err);
    }
  });

  // Enable send button only if input has content
  messageInput.addEventListener('input', () => {
    sendBtn.disabled = messageInput.value.trim().length === 0;
  });
</script>

</body>
</html>