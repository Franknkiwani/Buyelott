<!DOCTYPE html>  
<html lang="en">  
<head>  
  <meta charset="UTF-8" />  
  <title>Secure Checkout • CyberChat</title>  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />  
  
  <style>  
    html, body {  
      margin: 0;  
      padding: 0;  
      background: #000;  
      color: #fff;  
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;  
      user-select: none;  
      -webkit-tap-highlight-color: transparent;  
      text-align: center;  
    }  
  
    .page {  
      padding: 32px 24px;  
      max-width: 500px;  
      margin: 0 auto;  
    }  
  
    .title {  
      font-size: 28px;  
      font-weight: 700;  
      margin-bottom: 12px;  
    }  
  
    .subtitle {  
      color: #aaa;  
      font-size: 15px;  
      margin-bottom: 20px;  
    }  
  
    .product-img {  
      width: 100%;  
      max-height: 240px;  
      object-fit: cover;  
      border-radius: 20px;  
      margin-bottom: 24px;  
      background: #111;  
    }  
  
    .price {  
      font-size: 26px;  
      font-weight: bold;  
      color: #ffd700;  
      margin: 20px 0;  
    }  
  
    .secure-pay-btn {  
      margin: 32px 0 16px;  
      width: 100%;  
      padding: 16px;  
      background: linear-gradient(135deg, #6e00ff, #9f00ff, #00d9ff);  
      color: white;  
      font-size: 17px;  
      font-weight: 700;  
      border: none;  
      border-radius: 16px;  
      box-shadow: 0 0 30px rgba(100, 0, 255, 0.3);  
      cursor: pointer;  
      transition: all 0.3s ease;  
      display: flex;  
      justify-content: center;  
      align-items: center;  
      gap: 10px;  
    }  
  
    .secure-pay-btn:hover {  
      transform: scale(1.04);  
      box-shadow: 0 0 40px rgba(100, 0, 255, 0.5);  
    }  
  
    .lock-icon {  
      width: 20px;  
      height: 20px;  
      fill: white;  
    }  
  
    .delivery-info {  
      font-size: 14px;  
      color: #ccc;  
      margin-top: 8px;  
    }  
  
    .trust-badges {  
      margin-top: 24px;  
      display: flex;  
      justify-content: center;  
      flex-wrap: wrap;  
      gap: 16px;  
    }  
  
    .trust-badges img {  
      height: 32px;  
      opacity: 0.9;  
      filter: brightness(1.2);  
    }  
  
    /* Comment section styles */
    #commentSection {
      margin-top: 32px;
      text-align: left;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    #commentSection h3 {
      font-size: 20px;
      margin-bottom: 12px;
      color: #eee;
      text-align: center;
    }

    #commentInput {
      width: 100%;
      padding: 12px;
      border-radius: 12px;
      background: #111;
      color: #fff;
      border: none;
      resize: none;
      font-size: 14px;
      box-sizing: border-box;
      outline-offset: 2px;
      outline-color: #6e00ff;
      transition: outline-color 0.3s ease;
    }

    #commentInput:focus {
      outline-color: #9f00ff;
    }

    #postCommentBtn {
      margin-top: 10px;
      background: #6e00ff;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: background 0.3s ease;
      font-size: 15px;
    }

    #postCommentBtn:hover:not(:disabled) {
      background: #9f00ff;
    }

    #postCommentBtn:disabled {
      background: #444;
      cursor: not-allowed;
    }

    #commentStatus {
      margin-top: 10px;
      color: #0f0;
      display: none;
      font-size: 14px;
      text-align: center;
    }

    #commentList {
      margin-top: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .comment {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      background: #111;
      padding: 12px;
      border-radius: 12px;
    }

    .comment img {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      object-fit: cover;
      flex-shrink: 0;
    }

    .comment-content {
      flex: 1;
      color: #ddd;
    }

    .comment-author {
      font-weight: 600;
      font-size: 14px;
      color: #fff;
    }

    .comment-text {
      margin: 4px 0;
      font-size: 14px;
      line-height: 1.3;
      color: #ccc;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .comment-date {
      font-size: 12px;
      color: #777;
    }

    .loading {  
      color: #777;  
      margin-top: 80px;  
    } 
    .payment-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(12px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.payment-modal-content {
  background: #111;
  border-radius: 18px;
  padding: 24px;
  max-width: 400px;
  width: 90%;
  color: #fff;
  box-shadow: 0 0 24px rgba(255, 255, 255, 0.08);
  text-align: center;
}

.payment-options {
  display: flex;
  justify-content: space-between;
  margin-bottom: 20px;
  gap: 10px;
}

.option-btn {
  flex: 1;
  padding: 12px;
  font-weight: bold;
  background: #222;
  color: #fff;
  border: none;
  border-radius: 12px;
  cursor: pointer;
  transition: 0.2s ease;
}

.option-btn.active {
  background: #6e00ff;
}

.payment-section {
  display: none;
}

.payment-section.active {
  display: block;
}

.pay-method-btn {
  display: inline-block;
  margin-top: 20px;
  padding: 14px 24px;
  background: linear-gradient(135deg, #6e00ff, #00d9ff);
  border-radius: 12px;
  color: #fff;
  font-weight: bold;
  text-decoration: none;
  box-shadow: 0 0 16px rgba(100, 0, 255, 0.4);
}
  </style>  
</head>  
<body>  
  <div class="page" id="paymentPage">  
    <div class="loading">Loading secure checkout...</div>  
  </div>  
  <!-- Payment Options Modal -->
<div id="paymentMethodModal" class="payment-modal" style="display:none;">
  <div class="payment-modal-content">
    <div class="payment-options">
      <button class="option-btn active" id="manualTab">24 HOUR DELIVERY</button>
      <button class="option-btn" id="standardTab">7–21 DAYS DELIVERY</button>
    </div>

    <div id="manualSection" class="payment-section active">
      <h3>MANUAL PAYMENT</h3>
      <p>Send <b id="manualAmountText"></b> as <u>friends and family</u> to avoid PayPal long holds and fees.</p>
      <a id="manualPayLink" target="_blank" class="pay-method-btn">Pay Now</a>
    </div>

    <div id="standardSection" class="payment-section">
      <h3>STANDARD PAYPAL</h3>
      <p>Pay normally with buyer protection. Delivery may take 7–21 days depending on PayPal’s release system.</p>
      <a id="standardPayLink" target="_blank" class="pay-method-btn">Secure PayPal Checkout</a>
    </div>
  </div>
</div>
<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getDatabase, ref, get, push, serverTimestamp, onValue } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
  authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
  databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
  projectId: "itzhoyoo-f9f7e"
};

const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const page = document.getElementById("paymentPage");

const urlParams = new URLSearchParams(window.location.search);
const productId = urlParams.get("id");

let price = "0.00";
let title = "CyberChat Product";

function formatDate(ts) {
  const d = new Date(ts);
  return d.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
}

// Tracking session start time for session duration calc
const sessionStart = Date.now();

function generateTrackingCode() {
  const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let code = "CYBER-" + Date.now() + "-";
  for (let i = 0; i < 4; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}

function getDeviceType() {
  const ua = navigator.userAgent;
  if (/mobile|iphone|android|ipad|tablet/i.test(ua)) return "Mobile/Tablet";
  return "Desktop";
}

async function getUsername(uid) {
  try {
    const snap = await get(ref(db, `users/${uid}/username`));
    if (snap.exists()) return snap.val();
  } catch {}
  return null;
}

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    page.innerHTML = `<div class="loading">Please log in to complete your purchase.</div>`;
    return;
  }

  if (!productId) {
    page.innerHTML = `<div class="loading">Invalid product link.</div>`;
    return;
  }

  const snap = await get(ref(db, "dlsaccounts/" + productId));
  if (!snap.exists()) {
    page.innerHTML = `<div class="loading">Product not found.</div>`;
    return;
  }

  const data = snap.val();
  title = data.title || "CyberChat Product";
  const description = data.description || "";
  price = parseFloat(data.price || 0).toFixed(2);
  const img = (data.images && data.images[0]) || "https://via.placeholder.com/500x240?text=No+Image";

  page.innerHTML = `
    <div class="title">${title}</div>
    <div class="subtitle">${description}</div>
    <img src="${img}" class="product-img" alt="Product Image">
    <div class="price">$${price}</div>

    <button class="secure-pay-btn" id="payNow">
      <svg class="lock-icon" viewBox="0 0 24 24">
        <path d="M12 2a5 5 0 00-5 5v3H6a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2v-8a2 2 0 00-2-2h-1V7a5 5 0 00-5-5zm-3 5a3 3 0 016 0v3H9V7zm10 5v8H5v-8h14z"/>
      </svg>
      Pay Securely
    </button>

    <div class="delivery-info">Account will be delivered to: <b>${user.email}</b></div>

    <div class="trust-badges">
      <img src="https://img.icons8.com/color/48/000000/paypal.png" alt="PayPal">
      <img src="https://img.icons8.com/color/48/000000/secured-letter.png" alt="Secure SSL">
      <img src="https://img.icons8.com/color/48/000000/trust.png" alt="Trusted">
    </div>

    <div id="commentSection">
      <h3>What buyers are saying</h3>
      <textarea id="commentInput" rows="3" placeholder="Write your opinion..."></textarea>
      <button id="postCommentBtn" disabled>Post Comment</button>
      <div id="commentStatus">Comment posted ✅</div>
      <div id="commentList"><div class="loading">Loading comments...</div></div>
    </div>
  `;

  document.getElementById("payNow").addEventListener("click", () => {
    document.getElementById("paymentMethodModal").style.display = "flex";
    document.getElementById("manualAmountText").textContent = `$${price}`;

    document.getElementById("manualPayLink").href =
      `https://www.paypal.com/paypalme/farainkiwani456/${price}?country.x=ZA&locale.x=en_US`;

    document.getElementById("standardPayLink").href =
      `https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&business=cashmarco2000@gmail.com&item_name=${encodeURIComponent(title)}&amount=${price}&currency_code=USD`;

    document.getElementById("payNow").disabled = true;
  });

  // Comment logic
  const commentInput = document.getElementById("commentInput");
  const postBtn = document.getElementById("postCommentBtn");
  const commentStatus = document.getElementById("commentStatus");
  commentStatus.style.display = "none";

  commentInput.addEventListener("input", () => {
    postBtn.disabled = commentInput.value.trim().length < 3;
  });

  postBtn.addEventListener("click", async () => {
    const msg = commentInput.value.trim();
    if (msg.length < 3) return;
    postBtn.disabled = true;
    await push(ref(db, `comments/${productId}`), {
      uid: user.uid,
      email: user.email,
      text: msg,
      postedAt: serverTimestamp()
    });
    commentInput.value = "";
    postBtn.disabled = true;
    commentStatus.style.display = "block";
    setTimeout(() => {
      commentStatus.style.display = "none";
    }, 2000);
  });

  const commentList = document.getElementById("commentList");
  onValue(ref(db, `comments/${productId}`), async (snapshot) => {
    commentList.innerHTML = "";
    const comments = snapshot.val();
    if (!comments) {
      commentList.innerHTML = `<div style="color:#888; font-size:14px; text-align:center;">No comments yet. Be the first!</div>`;
      return;
    }

    const commentEntries = Object.entries(comments);
    commentEntries.sort((a, b) => (a[1].postedAt || 0) - (b[1].postedAt || 0));

    for (const [id, comment] of commentEntries) {
      try {
        const userSnap = await get(ref(db, `users/${comment.uid}`));
        const userData = userSnap.exists() ? userSnap.val() : {};
        const name = userData.username || comment.email.split("@")[0];
        const avatar = userData.avatar || "https://i.imgur.com/1XKxjzF.png";

        const commentEl = document.createElement("div");
        commentEl.className = "comment";
        commentEl.innerHTML = `
          <img src="${avatar}" alt="${name} avatar" loading="lazy" />
          <div class="comment-content">
            <div class="comment-author">${name}</div>
            <div class="comment-text">${comment.text.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>
            <div class="comment-date">${formatDate(comment.postedAt || Date.now())}</div>
          </div>
        `;
        commentList.appendChild(commentEl);
      } catch {}
    }
  });
});

// Payment button logic with metadata and tracking code
async function handlePaymentClick(e, paymentMethod) {
  e.preventDefault();
  const user = auth.currentUser;
  if (!user) return alert("Please log in to continue.");

  const username = await getUsername(user.uid);
  const sessionDuration = Math.floor((Date.now() - sessionStart) / 1000);
  const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone || "Unknown";
  const device = getDeviceType();
  const trackingCode = generateTrackingCode();

  await push(ref(db, `orders/${user.uid}`), {
    productId,
    email: user.email,
    username: username || null,
    paymentMethod,
    status: "pending",
    createdAt: serverTimestamp(),
    trackingCode,
    timezone,
    device,
    sessionDuration,
  });

  window.location.href = e.target.href;
}

document.getElementById("manualPayLink").addEventListener("click", (e) => handlePaymentClick(e, "manual"));
document.getElementById("standardPayLink").addEventListener("click", (e) => handlePaymentClick(e, "standard"));

// Modal tab switching
const manualTab = document.getElementById("manualTab");
const standardTab = document.getElementById("standardTab");
const manualSection = document.getElementById("manualSection");
const standardSection = document.getElementById("standardSection");

manualTab.addEventListener("click", () => {
  manualTab.classList.add("active");
  standardTab.classList.remove("active");
  manualSection.classList.add("active");
  standardSection.classList.remove("active");
});

standardTab.addEventListener("click", () => {
  standardTab.classList.add("active");
  manualTab.classList.remove("active");
  standardSection.classList.add("active");
  manualSection.classList.remove("active");
});

document.getElementById("paymentMethodModal").addEventListener("click", (e) => {
  if (e.target.id === "paymentMethodModal") {
    e.target.style.display = "none";
    document.getElementById("payNow").disabled = false;
  }
});
</script>
</body>  
</html>