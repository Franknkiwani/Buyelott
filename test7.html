<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tasks ‚Äì CyberRewards</title>
  <script type="module" src="https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js"></script>
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "San Francisco", "Helvetica Neue", sans-serif;
      padding: 1rem;
      margin: 0;
    }
    .header {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    .task {
      background: #111;
      border: 1px solid #333;
      border-radius: 18px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 20px rgba(255, 255, 255, 0.05);
    }
    .task h3 {
      margin-top: 0;
      font-size: 1.2rem;
    }
    .task button {
      background: #0a84ff;
      color: white;
      border: none;
      padding: 10px 18px;
      font-size: 1rem;
      border-radius: 14px;
      margin-top: 0.5rem;
      cursor: pointer;
    }
    .task button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    .balance {
      font-size: 1rem;
      font-weight: 500;
      margin-bottom: 1rem;
      background: #111;
      padding: 0.75rem;
      border-radius: 14px;
      border: 1px solid #333;
    }
  </style>
</head>
<body>
  <div class="header">üí∞ Earn Rewards</div>
  <div id="balanceDisplay" class="balance">Balance: $0.000</div>

  <!-- STATIC Task 1: Click to Earn -->
  <div class="task">
    <h3>üí∏ Earn $0.001 per click</h3>
    <p>Tap the button to earn money instantly. Once per minute allowed.</p>
    <button onclick="handleClickTask()" id="clickBtn">Click to Earn</button>
  </div>

  <!-- STATIC Task 2: Visit site -->
  <div class="task">
    <h3>üåê Visit and Earn $0.025</h3>
    <p>Visit our sponsor and get paid. No clickbait or spam. Once daily.</p>
    <button onclick="handleVisitTask()" id="visitBtn">Visit & Earn</button>
  </div>

  <!-- Firebase Tasks -->
  <div id="taskList"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getDatabase, ref, onValue, get, set } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
      authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
      databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
      projectId: "itzhoyoo-f9f7e",
      storageBucket: "itzhoyoo-f9f7e.filestorage.app",
      messagingSenderId: "1094792075584",
      appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
      measurementId: "G-LLT6F9WRKH"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    let uid = null;

    onAuthStateChanged(auth, user => {
      if (user) {
        uid = user.uid;
        updateBalance();
        loadFirebaseTasks();
      } else {
        alert("Login required");
        window.location.href = "/login.html";
      }
    });

    async function updateBalance() {
      const balRef = ref(db, `users/${uid}/balance`);
      const snap = await get(balRef);
      const balance = snap.exists() ? snap.val() : 0;
      document.getElementById("balanceDisplay").textContent = `Balance: $${balance.toFixed(3)}`;
    }

    async function incrementBalance(amount) {
      const balRef = ref(db, `users/${uid}/balance`);
      const snap = await get(balRef);
      const current = snap.exists() ? snap.val() : 0;
      await set(balRef, current + amount);
      updateBalance();
    }

    // === STATIC TASK HANDLERS ===
    async function handleClickTask() {
      const lastClickRef = ref(db, `users/${uid}/lastClickEarn`);
      const snap = await get(lastClickRef);
      const now = Date.now();
      const oneMinute = 60 * 1000;

      if (snap.exists() && now - snap.val() < oneMinute) {
        alert("Wait a minute between clicks.");
        return;
      }

      await set(lastClickRef, now);
      await incrementBalance(0.001);
      alert("Earned $0.001!");
    }

    async function handleVisitTask() {
      const today = new Date().toISOString().split('T')[0];
      const visitRef = ref(db, `users/${uid}/visitedToday`);
      const snap = await get(visitRef);

      if (snap.exists() && snap.val() === today) {
        alert("You already visited today.");
        return;
      }

      await set(visitRef, today);
      await incrementBalance(0.025);
      window.open("https://www.profitableratecpm.com/mtux2f3g?key=10f50e5fc3d4ec2f75c6e32cd767b041", "_blank");
    }

    // === FIREBASE TASKS ===
    function loadFirebaseTasks() {
      const taskRef = ref(db, 'tasks');
      onValue(taskRef, snapshot => {
        const container = document.getElementById("taskList");
        container.innerHTML = "";
        const tasks = snapshot.val();

        if (!tasks) {
          container.innerHTML = "<p>No tasks available.</p>";
          return;
        }

        Object.entries(tasks).forEach(([key, task]) => {
          const div = document.createElement("div");
          div.className = "task";
          div.innerHTML = `
            <h3>${task.title}</h3>
            <p>${task.description}</p>
            <small>Type: ${task.type || "general"} ‚Äì Reward: $${task.reward.toFixed(3)}</small><br>
            <button onclick="completeTask('${key}', ${task.reward}, ${task.maxPerDay || 'null'})">Complete Task</button>
          `;
          container.appendChild(div);
        });
      });
    }

    window.completeTask = async function (taskId, reward, maxPerDay) {
      const today = new Date().toISOString().split('T')[0];
      const taskPath = `users/${uid}/tasksCompleted/${taskId}`;
      const taskRef = ref(db, taskPath);
      const snap = await get(taskRef);

      const data = snap.exists() ? snap.val() : { count: 0, date: "" };
      if (data.date === today && maxPerDay && data.count >= maxPerDay) {
        alert("Daily limit reached for this task.");
        return;
      }

      await set(taskRef, {
        date: today,
        count: data.date === today ? data.count + 1 : 1
      });

      await incrementBalance(reward);
      alert(`Task completed! Earned $${reward.toFixed(3)}`);
    };
  </script>
</body>
</html>