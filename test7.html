<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Firebase Chat with Push</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #121212; color: #eee; margin: 0; padding: 20px;
  }
  #messages {
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #444;
    padding: 10px;
    margin-bottom: 10px;
    background: #222;
  }
  #input {
    width: 80%;
    padding: 8px;
  }
  button {
    padding: 8px 12px;
  }
  #status {
    margin-top: 10px;
    font-size: 0.9rem;
    color: #aaa;
  }
</style>
</head>
<body>

<h2>ðŸ”¥ Firebase Chat with Push Notifications</h2>

<div id="user-info"></div>
<button id="signOutBtn" style="display:none;">Sign Out</button>

<div id="chat-section" style="display:none;">
  <div id="messages"></div>
  <input id="input" placeholder="Type your message..." autocomplete="off" />
  <button id="sendBtn">Send</button>
</div>

<div id="status">Initializing...</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-messaging-compat.js"></script>

<script>
  // Your Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    storageBucket: "itzhoyoo-f9f7e.appspot.com",
    messagingSenderId: "1094792075584",
    appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
  };

  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();
  const messaging = firebase.messaging();

  const userInfoEl = document.getElementById('user-info');
  const signOutBtn = document.getElementById('signOutBtn');
  const chatSection = document.getElementById('chat-section');
  const messagesEl = document.getElementById('messages');
  const inputEl = document.getElementById('input');
  const sendBtn = document.getElementById('sendBtn');
  const statusEl = document.getElementById('status');

  async function signIn() {
    try {
      await auth.signInAnonymously();
      statusEl.textContent = 'Signed in anonymously';
    } catch (e) {
      statusEl.textContent = 'Sign-in error: ' + e.message;
    }
  }

  async function registerFCMToken(user) {
    try {
      const permission = await Notification.requestPermission();
      if (permission !== 'granted') {
        statusEl.textContent = 'Notification permission denied';
        return;
      }
      statusEl.textContent = 'Notification permission granted. Getting token...';

      const token = await messaging.getToken({
        vapidKey: 'BKnnH4sEI54qErGt9B_YCxGyCwpWx-Wk7D-edWaQSt_ZXYmZlwSBYbVx5Li3BjT3Gzr2rYM2dVBwFtpNreYDkjc' // Your public VAPID key
      });

      if (token) {
        statusEl.textContent = 'FCM Token received and saved!';
        await db.ref('fcmTokens/' + user.uid).set(token);
        console.log('FCM Token:', token);
      } else {
        statusEl.textContent = 'No FCM token received.';
      }
    } catch (e) {
      statusEl.textContent = 'Error getting notification permission or token: ' + e.message;
    }
  }

  function listenMessages() {
    db.ref('messages').limitToLast(50).on('child_added', snapshot => {
      const msg = snapshot.val();
      const el = document.createElement('div');
      el.textContent = `${msg.sender}: ${msg.text}`;
      messagesEl.appendChild(el);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });
  }

  async function sendMessage(text, uid) {
    if (!text.trim()) return;
    const message = {
      text,
      sender: uid,
      timestamp: Date.now()
    };
    await db.ref('messages').push(message);
    inputEl.value = '';
  }

  auth.onAuthStateChanged(async user => {
    if (user) {
      userInfoEl.textContent = `User ID: ${user.uid}`;
      signOutBtn.style.display = 'inline-block';
      chatSection.style.display = 'block';
      statusEl.textContent = 'Registering for push notifications...';
      await registerFCMToken(user);
      listenMessages();
    } else {
      userInfoEl.textContent = 'Not signed in';
      signOutBtn.style.display = 'none';
      chatSection.style.display = 'none';
      statusEl.textContent = 'Please sign in';
      await signIn();
    }
  });

  signOutBtn.onclick = () => auth.signOut();

  sendBtn.onclick = () => {
    const user = auth.currentUser;
    if (!user) return;
    sendMessage(inputEl.value, user.uid);
  };

  messaging.onMessage(payload => {
    console.log('Foreground message received: ', payload);
    // Optional: show UI alert, toast, etc.
  });
</script>

</body>
</html>