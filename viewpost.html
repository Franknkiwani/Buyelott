<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>View Post</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 20px;
    }
    .loading {
      height: 200px;
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 12px;
    }
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    .post-image {
      width: 100%;
      border-radius: 12px;
      margin-bottom: 15px;
    }
    .post-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .post-description {
      font-size: 16px;
      margin-bottom: 20px;
    }
    .stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      font-size: 14px;
      color: #555;
    }
    .comments-section {
      border-top: 1px solid #ddd;
      padding-top: 20px;
    }
    .comment {
      margin-bottom: 15px;
    }
    .comment-user {
      font-weight: bold;
    }
    .comment-text {
      margin-left: 10px;
    }
    .comment-form {
      display: flex;
      margin-top: 20px;
    }
    .comment-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-right: 10px;
    }
    .comment-button {
      padding: 10px 15px;
      border: none;
      background-color: #007aff;
      color: white;
      border-radius: 8px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="loading" class="loading"></div>
    <div id="post-content" style="display:none;">
      <img id="post-image" class="post-image" src="" alt="Post Image"/>
      <div id="post-title" class="post-title"></div>
      <div id="post-description" class="post-description"></div>
      <div class="stats">
        <div><span id="views-count">0</span> Views</div>
        <div><span id="likes-count">0</span> Likes</div>
        <div><span id="comments-count">0</span> Comments</div>
      </div>
      <div class="comments-section">
        <div id="comments-list"></div>
        <form id="comment-form" class="comment-form">
          <input type="text" id="comment-input" class="comment-input" placeholder="Add a comment..." required/>
          <button type="submit" class="comment-button">Post</button>
        </form>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, get, set, push, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
      authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
      databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
      projectId: "itzhoyoo-f9f7e",
      storageBucket: "itzhoyoo-f9f7e.filestorage.app",
      messagingSenderId: "1094792075584",
      appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
      measurementId: "G-LLT6F9WRKH"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get('postId');

    if (!postId) {
      document.getElementById('loading').innerText = "No postId provided in URL.";
    } else {
      const postRef = ref(db, `posts/${postId}`);

      get(postRef).then(snapshot => {
        if (snapshot.exists()) {
          const post = snapshot.val();

          // Update views
          const viewsRef = ref(db, `posts/${postId}/views`);
          get(viewsRef).then(viewSnap => {
            let views = viewSnap.exists() ? viewSnap.val() : 0;
            views++;
            set(viewsRef, views);
            document.getElementById('views-count').innerText = views;
          });

          // Likes count
          const likes = post.likes ? Object.keys(post.likes).length : 0;
          document.getElementById('likes-count').innerText = likes;

          // Comments count
          const comments = post.comments ? Object.keys(post.comments).length : 0;
          document.getElementById('comments-count').innerText = comments;

          // Fill content
          document.getElementById('post-image').src = post.image || '';
          document.getElementById('post-title').innerText = post.title || '';
          document.getElementById('post-description').innerText = post.description || '';

          document.getElementById('loading').style.display = 'none';
          document.getElementById('post-content').style.display = 'block';

          // Render comments
          const commentsList = document.getElementById('comments-list');
          commentsList.innerHTML = '';
          if (post.comments) {
            Object.values(post.comments).forEach(comment => {
              const commentDiv = document.createElement('div');
              commentDiv.className = 'comment';
              commentDiv.innerHTML = `<span class="comment-user">${comment.user}</span><span class="comment-text">${comment.text}</span>`;
              commentsList.appendChild(commentDiv);
            });
          }

          // Submit new comment
          document.getElementById('comment-form').addEventListener('submit', e => {
            e.preventDefault();
            const commentInput = document.getElementById('comment-input');
            const commentText = commentInput.value.trim();
            if (commentText) {
              const newCommentRef = push(ref(db, `posts/${postId}/comments`));
              set(newCommentRef, {
                user: "Anonymous", // Replace with real user data
                text: commentText,
                timestamp: Date.now()
              }).then(() => {
                commentInput.value = '';
              });
            }
          });

          // Live comment updates
          onValue(ref(db, `posts/${postId}/comments`), snapshot => {
            const commentsData = snapshot.val();
            const commentsList = document.getElementById('comments-list');
            commentsList.innerHTML = '';
            if (commentsData) {
              Object.values(commentsData).forEach(comment => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'comment';
                commentDiv.innerHTML = `<span class="comment-user">${comment.user}</span><span class="comment-text">${comment.text}</span>`;
                commentsList.appendChild(commentDiv);
              });
              document.getElementById('comments-count').innerText = Object.keys(commentsData).length;
            } else {
              document.getElementById('comments-count').innerText = '0';
            }
          });

        } else {
          document.getElementById('loading').innerText = "Post not found.";
        }
      }).catch(err => {
        console.error(err);
        document.getElementById('loading').innerText = "Error loading post.";
      });
    }
  </script>
</body>
</html>