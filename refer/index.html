<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Referral Tracking</title>
<style>
  body{display:flex;justify-content:center;align-items:center;height:100vh;background:#0d0d0d;color:white;font-family:-apple-system,BlinkMacSystemFont,'SF Pro',sans-serif;}
  .msg{padding:20px;background:rgba(255,255,255,0.1);border-radius:12px;backdrop-filter:blur(12px);}
</style>
</head>
<body>
<div class="msg" id="statusMsg">Processing referral...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getDatabase, ref, push, get, child, update } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

// ===== Firebase Config =====
const firebaseConfig = {
  apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
  authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
  databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
  projectId: "itzhoyoo-f9f7e",
  storageBucket: "itzhoyoo-f9f7e.filestorage.app",
  messagingSenderId: "1094792075584",
  appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
};

// ===== Initialize Firebase =====
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ===== Helper =====
const status = document.getElementById('statusMsg');

// Get URL params
const params = new URLSearchParams(window.location.search);
const referrerUID = params.get('uid');

if(!referrerUID){
  status.innerText = "No referral UID found. Redirecting...";
  setTimeout(()=>window.location.href="/", 1000);
} else {
  // Get today's timestamp
  const timestamp = Date.now();

  // Update referral stats in DB
  const refRef = ref(db, `referrals/${referrerUID}`);
  get(refRef).then(snap=>{
    const data = snap.exists() ? snap.val() : {users:0, clicks:0, rbx:0};

    // Increment clicks (this visitor clicked)
    const updates = {
      clicks: (data.clicks||0)+1
    };

    // Optionally, give RBX only when new users sign up (you can handle this later)
    update(refRef, updates).then(()=>{
      status.innerText = "Referral recorded! Redirecting...";
      
      // Redirect user to previous page (before /refer) or default home
      let redirectTo = "/";
      const prevPath = window.location.pathname.split('/refer')[0];
      if(prevPath && prevPath!=='') redirectTo = prevPath;

      setTimeout(()=>window.location.href = redirectTo, 800);
    }).catch(err=>{
      status.innerText = "Error recording referral. Redirecting...";
      setTimeout(()=>window.location.href="/", 1200);
      console.error(err);
    });
  });
}
</script>
</body>
</html>