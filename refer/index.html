<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Referral Tracking</title>
<style>
  body{display:flex;justify-content:center;align-items:center;height:100vh;background:#0d0d0d;color:white;font-family:-apple-system,BlinkMacSystemFont,'SF Pro',sans-serif;}
  .msg{padding:20px;background:rgba(255,255,255,0.1);border-radius:12px;backdrop-filter:blur(12px);}
</style>
</head>
<body>
<div class="msg" id="statusMsg">Processing referral...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

// ===== Firebase Config =====
const firebaseConfig = {
  apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
  authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
  databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
  projectId: "itzhoyoo-f9f7e",
  storageBucket: "itzhoyoo-f9f7e.filestorage.app",
  messagingSenderId: "1094792075584",
  appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
};

// ===== Initialize Firebase =====
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ===== DOM Element =====
const status = document.getElementById('statusMsg');

// Get UID from URL
const params = new URLSearchParams(window.location.search);
const refUID = params.get('uid');

if(!refUID){
  status.innerText = "No referral UID found. Redirecting...";
  setTimeout(()=>window.location.href="/", 1000);
} else {
  const refRef = ref(db, `referrals/${refUID}`);
  get(refRef).then(snap=>{
    const data = snap.exists() ? snap.val() : {users:0, clicks:0, rbx:0};

    const updates = {
      clicks: (data.clicks||0) + 1,
      rbx: (data.rbx||0) + 10,   // Credit 10 RBX per click
      users: (data.users||0) + 1 // optional: count as 1 user
    };

    update(refRef, updates).then(()=>{
      status.innerText = "Referral credited! Redirecting...";

      // Redirect visitor to page before /refer or home
      let redirectTo = "/";
      const prevPath = window.location.pathname.split('/refer')[0];
      if(prevPath && prevPath!=='') redirectTo = prevPath;

      setTimeout(()=>window.location.href = redirectTo, 800);
    }).catch(err=>{
      status.innerText = "Error recording referral. Redirecting...";
      console.error(err);
      setTimeout(()=>window.location.href="/", 1200);
    });
  });
}
</script>
</body>
</html>