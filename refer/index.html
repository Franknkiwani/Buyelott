<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Referral Tracking</title>
<style>
  html, body { margin:0; padding:0; height:100%; width:100%; font-family:-apple-system, BlinkMacSystemFont, 'SF Pro', sans-serif; overflow:hidden;}
  body { display:flex; flex-direction:column; background: linear-gradient(135deg, #0a0a0a, #1a1a1a); color:#fff;}
  .ios-status-bar {height: env(safe-area-inset-top, 44px); background: rgba(0,0,0,0.2); backdrop-filter: blur(20px); display:flex; align-items:center; justify-content:center; font-size:14px; letter-spacing:0.5px; z-index:10;}
  .container {flex:1; display:flex; align-items:center; justify-content:center; padding:20px;}
  .msg-card {background: rgba(255,255,255,0.08); border-radius:24px; backdrop-filter: blur(30px); padding:30px 25px; max-width:320px; width:90%; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.3); transition: transform 0.3s ease, opacity 0.3s ease; opacity:0; transform:translateY(20px);}
  .msg-card.show {opacity:1; transform:translateY(0);}
  .spinner {margin:20px auto; width:36px; height:36px; border:4px solid rgba(255,255,255,0.2); border-top:4px solid #fff; border-radius:50%; animation:spin 1s linear infinite;}
  @keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
  .error-fullscreen {position:fixed; top:0; left:0; width:100%; height:100%; background:#ff0000; display:flex; justify-content:center; align-items:center; color:#fff; font-size:22px; text-align:center; z-index:999; padding:20px;}
</style>
</head>
<body>

<div class="ios-status-bar">WATCH-4-RBX</div>

<div class="container">
  <div class="msg-card" id="statusMsg">
    <div class="spinner"></div>
    <div id="msgText">Processing referral...</div>
  </div>
</div>

<div id="errorScreen" class="error-fullscreen" style="display:none;">
  ‚ùå Error: You cannot claim RBX again! <br> Either it's your own referral or your device already claimed.
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

// ===== Firebase Config =====
const firebaseConfig = {
  apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
  authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
  databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
  projectId: "itzhoyoo-f9f7e",
  storageBucket: "itzhoyoo-f9f7e.filestorage.app",
  messagingSenderId: "1094792075584",
  appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
};

// ===== Initialize Firebase =====
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const statusCard = document.getElementById('statusMsg');
const msgText = document.getElementById('msgText');
const errorScreen = document.getElementById('errorScreen');

setTimeout(()=>statusCard.classList.add('show'), 50);

const params = new URLSearchParams(window.location.search);
const refUID = params.get('uid');

// Simple device check using localStorage
const deviceKey = 'referral_claimed_' + refUID;
if(localStorage.getItem(deviceKey)){
  errorScreen.style.display = 'flex';
  statusCard.style.display = 'none';
}

onAuthStateChanged(auth, async (user)=>{
  if(!user){
    msgText.innerText = "Please login first!";
    return;
  }

  const currentUID = user.uid;

  // OWNER check: prevent self-referral
  if(currentUID === refUID){
    errorScreen.style.display = 'flex';
    statusCard.style.display = 'none';
    return;
  }

  if(!refUID){
    msgText.innerText = "No referral UID found. Redirecting...";
    setTimeout(()=>window.location.href="/", 1000);
    return;
  }

  const rbxPerClick = 10;
  const refRef = ref(db, `referrals/${refUID}`);

  try{
    const snap = await get(refRef);
    const data = snap.exists() ? snap.val() : {users:0, clicks:0, rbx:0, claimedBy:[]};

    // Check if this device or user already claimed
    if(data.claimedBy && data.claimedBy.includes(currentUID)){
      errorScreen.style.display = 'flex';
      statusCard.style.display = 'none';
      return;
    }

    // Update referral stats
    const updates = {
      clicks: (data.clicks||0)+1,
      rbx: (data.rbx||0)+rbxPerClick,
      users: (data.users||0)+1,
      claimedBy: [...(data.claimedBy||[]), currentUID]
    };

    await update(refRef, updates);

    // Add RBX to user
    const balRef = ref(db, `users/${refUID}/rbxbalance`);
    const balSnap = await get(balRef);
    const currentBalance = balSnap.exists() ? balSnap.val() : 0;
    await set(balRef, currentBalance + rbxPerClick);

    // Mark device as claimed
    localStorage.setItem(deviceKey, 'true');

    msgText.innerText = "Referral credited! Redirecting...";
    setTimeout(()=>window.location.href=document.referrer||"/", 1000);

  }catch(err){
    console.error(err);
    errorScreen.style.display = 'flex';
    statusCard.style.display = 'none';
  }
});
</script>

</body>
</html>