<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Referral Tracking</title>
<style>
html, body { margin:0; padding:0; height:100%; width:100%; font-family:-apple-system, BlinkMacSystemFont, 'SF Pro', sans-serif; overflow:hidden;}
body { display:flex; flex-direction:column; background: linear-gradient(135deg, #0a0a0a, #1a1a1a); color:#fff;}
.ios-status-bar {height: env(safe-area-inset-top, 44px); background: rgba(0,0,0,0.2); backdrop-filter: blur(20px); display:flex; align-items:center; justify-content:center; font-size:14px; letter-spacing:0.5px; z-index:10;}
.container {flex:1; display:flex; align-items:center; justify-content:center; padding:20px;}
.msg-card {background: rgba(255,255,255,0.08); border-radius:24px; backdrop-filter: blur(30px); padding:30px 25px; max-width:320px; width:90%; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.3); transition: transform 0.3s ease, opacity 0.3s ease; opacity:0; transform:translateY(20px);}
.msg-card.show {opacity:1; transform:translateY(0);}
.spinner {margin:20px auto; width:36px; height:36px; border:4px solid rgba(255,255,255,0.2); border-top:4px solid #fff; border-radius:50%; animation:spin 1s linear infinite;}
@keyframes spin {0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

/* Modal */
.modal-overlay {
  position: fixed;
  top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.6);
  display:flex;
  justify-content:center;
  align-items:center;
  opacity:0;
  pointer-events:none;
  transition: opacity 0.3s ease;
}
.modal-overlay.show {opacity:1; pointer-events:auto;}
.modal {
  background: rgba(255,255,255,0.08);
  border-radius:20px;
  backdrop-filter: blur(25px);
  padding:25px 20px;
  max-width:320px;
  width:90%;
  text-align:center;
  box-shadow:0 15px 35px rgba(0,0,0,0.4);
  animation: slideIn 0.4s ease forwards;
}
@keyframes slideIn {0% { transform: translateY(-20px); opacity:0; } 100% { transform: translateY(0); opacity:1; }}
.modal img { width:48px; height:48px; margin-bottom:15px; }
.modal h2 { font-size:18px; margin-bottom:10px; }
.modal p { font-size:14px; line-height:1.4; color:#ddd; margin-bottom:20px; }
.modal button {
  background:#007aff;
  color:#fff;
  border:none;
  padding:10px 20px;
  border-radius:12px;
  font-size:16px;
  cursor:pointer;
  transition: background 0.2s;
}
.modal button:hover { background:#005ecb; }
</style>
</head>
<body>



<div class="container">
  <div class="msg-card" id="statusMsg">
    <div class="spinner"></div>
    <div id="msgText">Tracking referral...</div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="modal-overlay">
  <div class="modal">
    <img src="https://img.icons8.com/doodle/48/error.png" alt="error">
    <h2>Referral Cannot Be Claimed</h2>
    <p>You have already claimed this referral or it's your own link. You cannot claim RBX multiple times.</p>
    <button id="goBackBtn">Go Back</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
  authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
  databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
  projectId: "itzhoyoo-f9f7e",
  storageBucket: "itzhoyoo-f9f7e.filestorage.app",
  messagingSenderId: "1094792075584",
  appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const modal = document.getElementById('modal');
const goBackBtn = document.getElementById('goBackBtn');
const statusCard = document.getElementById('statusMsg');
const msgText = document.getElementById('msgText');

goBackBtn.addEventListener('click', ()=>window.location.href='https://otieu.com/4/7950037');

const params = new URLSearchParams(window.location.search);
const refUID = params.get('uid');
const deviceKey = 'referral_claimed_' + refUID;

// Show spinner
statusCard.classList.add('show');

if(localStorage.getItem(deviceKey)){
  modal.classList.add('show');
  statusCard.style.display='none';
}

onAuthStateChanged(auth, async (user)=>{
  if(!user){
    modal.classList.add('show');
    statusCard.style.display='none';
    return;
  }

  const currentUID = user.uid;

  if(currentUID === refUID || !refUID){
    modal.classList.add('show');
    statusCard.style.display='none';
    return;
  }

  const rbxPerClick = 10;
  const refRef = ref(db, `referrals/${refUID}`);

  try{
    const snap = await get(refRef);
    const data = snap.exists() ? snap.val() : {users:0, clicks:0, rbx:0, claimedBy:[]};

    if(data.claimedBy && data.claimedBy.includes(currentUID)){
      modal.classList.add('show');
      statusCard.style.display='none';
      return;
    }

    // Update referral stats
    const updates = {
      clicks: (data.clicks||0)+1,
      rbx: (data.rbx||0)+rbxPerClick,
      users: (data.users||0)+1,
      claimedBy: [...(data.claimedBy||[]), currentUID]
    };
    await update(refRef, updates);

    // Add RBX to user
    const balRef = ref(db, `users/${refUID}/rbxbalance`);
    const balSnap = await get(balRef);
    const currentBalance = balSnap.exists() ? balSnap.val() : 0;
    await set(balRef, currentBalance + rbxPerClick);

    // Mark device claimed
    localStorage.setItem(deviceKey, 'true');

    window.location.href = document.referrer || "/";
  }catch(err){
    console.error(err);
    modal.classList.add('show');
    statusCard.style.display='none';
  }
});
</script>

</body>
</html>