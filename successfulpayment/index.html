<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Payment Successful</title>
<style>
  body {
    background: #121212;
    color: #eee;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
    padding: 1rem;
    text-align: center;
  }
  .container {
    background: #1e1e1e;
    padding: 2rem 3rem;
    border-radius: 16px;
    box-shadow: 0 0 30px #0f0f0f;
    max-width: 400px;
    width: 100%;
  }
  h1 {
    color: #4caf50;
    margin-bottom: 0.5rem;
  }
  p {
    margin: 0.5rem 0 1.5rem;
    font-size: 1.1rem;
  }
  .summary {
    background: #272727;
    border-radius: 12px;
    padding: 1rem;
    margin-top: 1rem;
    font-weight: 600;
  }
  button {
    margin-top: 2rem;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 12px;
    background: #4caf50;
    color: #fff;
    font-size: 1.1rem;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  button:hover {
    background: #43a047;
  }
  .error {
    color: #f44336;
    font-weight: bold;
    margin-top: 1rem;
  }
</style>
</head>
<body>
  <div class="container">
    <h1>ðŸŽ‰ Payment Successful!</h1>
    <p id="message">Confirming your purchase...</p>
    <div class="summary" id="summary" style="display:none;">
      <p><strong>Ad ID:</strong> <span id="adId"></span></p>
      <p><strong>Views Purchased:</strong> <span id="viewsPurchased"></span></p>
      <p><strong>Amount Paid:</strong> $<span id="pricePaid"></span></p>
    </div>
    <button id="goBackBtn" style="display:none;">Back to Ads</button>
    <p class="error" id="errorMsg" style="display:none;"></p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getDatabase, ref, get, update, set } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
      authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
      databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
      projectId: "itzhoyoo-f9f7e",
      storageBucket: "itzhoyoo-f9f7e.filestorage.app",
      messagingSenderId: "1094792075584",
      appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
      measurementId: "G-LLT6F9WRKH"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // DOM refs
    const messageEl = document.getElementById("message");
    const summaryEl = document.getElementById("summary");
    const adIdEl = document.getElementById("adId");
    const viewsPurchasedEl = document.getElementById("viewsPurchased");
    const pricePaidEl = document.getElementById("pricePaid");
    const goBackBtn = document.getElementById("goBackBtn");
    const errorMsg = document.getElementById("errorMsg");

    const PURCHASE_KEY = "pendingPurchase";
    const MAX_PENDING_AGE = 30 * 60 * 1000; // 30 minutes in ms

    // Clear pending purchase data
    function clearPendingPurchase() {
      localStorage.removeItem(PURCHASE_KEY);
    }

    // Update Firebase with purchase info
    async function finalizePurchase(purchase, userId) {
      const key = `${purchase.adId}_${userId}`;
      const adRef = ref(db, `dlsaccountsads/${key}`);

      try {
        const snap = await get(adRef);
        if (snap.exists()) {
          const currentData = snap.val();
          const newViews = (currentData.viewsRemaining || 0) + purchase.viewsPurchased;
          await update(adRef, {
            viewsRemaining: newViews,
            pricePaid: (currentData.pricePaid || 0) + purchase.pricePaid,
            isFree: false,
          });
        } else {
          await set(adRef, {
            uid: userId,
            adId: purchase.adId,
            viewsRemaining: purchase.viewsPurchased,
            viewsPerDay: purchase.viewsPurchased,
            isFree: false,
            pricePaid: purchase.pricePaid,
            clicks: 0,
            createdAt: Date.now(),
          });
        }
        return true;
      } catch (e) {
        console.error("Firebase update error:", e);
        return false;
      }
    }

    // Main flow
    async function main() {
      // Get purchase info from localStorage
      const raw = localStorage.getItem(PURCHASE_KEY);
      if (!raw) {
        showError("No purchase info found. Please try again.");
        return;
      }

      let purchase;
      try {
        purchase = JSON.parse(raw);
      } catch {
        showError("Malformed purchase data.");
        clearPendingPurchase();
        return;
      }

      // Check if purchase is older than 30 minutes
      if (Date.now() - purchase.timestamp > MAX_PENDING_AGE) {
        showError("Purchase session expired. Please try again.");
        clearPendingPurchase();
        return;
      }

      adIdEl.textContent = purchase.adId;
      viewsPurchasedEl.textContent = purchase.viewsPurchased;
      pricePaidEl.textContent = purchase.pricePaid.toFixed(2);

      // Wait for Firebase auth user
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          showError("You must be signed in to complete the purchase.");
          return;
        }

        messageEl.textContent = "Finalizing your purchase, please wait...";

        const success = await finalizePurchase(purchase, user.uid);

        if (success) {
          messageEl.textContent = "âœ… Your purchase has been recorded successfully!";
          summaryEl.style.display = "block";
          goBackBtn.style.display = "inline-block";
          clearPendingPurchase();
        } else {
          showError("Failed to update purchase data. Please contact support.");
        }
      });
    }

    function showError(text) {
      messageEl.style.display = "none";
      errorMsg.textContent = text;
      errorMsg.style.display = "block";
      goBackBtn.style.display = "inline-block";
    }

    goBackBtn.addEventListener("click", () => {
      window.location.href = "/ads"; // Change to your main ads page
    });

    main();
  </script>
</body>
</html>