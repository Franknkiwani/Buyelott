<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CyberChat Inbox</title>
<style>
  /* Reset & base */
  body {
    margin: 0; padding: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #000;
    color: #eee;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    background: #0a0a0a;
    padding: 14px 18px;
    font-weight: 700;
    font-size: 1.4rem;
    border-bottom: 1px solid #222;
    position: fixed;
    width: 100%;
    top: 0; left: 0;
    z-index: 1000;
    user-select: none;
  }
  main {
    flex: 1;
    margin-top: 56px;
    overflow-y: auto;
    background: #111;
  }
  .chat-list-item {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid #222;
    cursor: pointer;
    transition: background 0.15s ease;
  }
  .chat-list-item:hover {
    background: #222;
  }
  .avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 14px;
    border: 1.5px solid #333;
    flex-shrink: 0;
  }
  .chat-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .username {
    font-weight: 600;
    font-size: 1rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .last-message {
    font-size: 0.85rem;
    color: #aaa;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-top: 3px;
  }
  .timestamp {
    font-size: 0.75rem;
    color: #666;
    margin-left: 8px;
    flex-shrink: 0;
    white-space: nowrap;
  }
  .unread-badge {
    background: #1da1f2;
    color: #000;
    font-weight: 700;
    font-size: 0.75rem;
    padding: 2px 8px;
    border-radius: 12px;
    margin-left: 8px;
    user-select: none;
  }
</style>
</head>
<body>
<header>CyberChat Inbox</header>
<main id="chatList" aria-label="Chat list" role="list"></main>

<script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.4.0/firebase-database-compat.js"></script>

<script>
  // Firebase config â€” replace with yours if needed
  const firebaseConfig = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    storageBucket: "itzhoyoo-f9f7e.filestorage.app",
    messagingSenderId: "1094792075584",
    appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  const chatListEl = document.getElementById('chatList');
  let currentUser = null;

  function formatTimestamp(ts) {
    if (!ts) return '';
    const d = new Date(ts);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Find the "other user" in the chat metadata users object
  function getOtherUid(usersObj, currentUid) {
    return Object.keys(usersObj).find(uid => uid !== currentUid);
  }

  function createChatListItem(user, lastMsg, lastMsgTime, chatId, unread) {
    const item = document.createElement('div');
    item.className = 'chat-list-item';
    item.setAttribute('role', 'listitem');
    item.tabIndex = 0;

    item.onclick = () => {
      window.location.href = `/chat?uid=${user.uid}`;
    };
    item.onkeypress = (e) => {
      if (e.key === 'Enter') item.click();
    };

    // Show unread badge only if unread == true
    const unreadBadge = unread ? `<span class="unread-badge">NEW</span>` : '';

    item.innerHTML = `
      <img class="avatar" src="${user.avatar || 'https://via.placeholder.com/48?text=ðŸ‘¤'}" alt="Avatar of ${escapeHtml(user.username)}" />
      <div class="chat-info">
        <div class="username">@${escapeHtml(user.username || 'unknown')}</div>
        <div class="last-message">${escapeHtml(lastMsg || '')}</div>
      </div>
      <div>
        <div class="timestamp">${formatTimestamp(lastMsgTime)}</div>
        ${unreadBadge}
      </div>
    `;
    return item;
  }

  auth.onAuthStateChanged(user => {
    if (!user) {
      alert('Please log in to see your chats.');
      window.location.href = '/login';
      return;
    }
    currentUser = user;

    db.ref('/chats').once('value').then(snapshot => {
      const chats = snapshot.val() || {};
      chatListEl.innerHTML = '';

      const promises = [];

      Object.entries(chats).forEach(([chatId, chatData]) => {
        const meta = chatData.meta;
        if (!meta || !meta.users || !meta.users[currentUser.uid]) return;

        const otherUid = getOtherUid(meta.users, currentUser.uid);
        if (!otherUid) return;

        const messages = chatData.messages || {};
        const lastKey = Object.keys(messages).pop();
        const lastMsg = messages[lastKey];

        // Determine if the last message is unread:
        // Unread if last message sender != current user AND
        // last message timestamp > meta.lastReadTimes[currentUser.uid] (if stored)
        let unread = false;
        const lastReadTimes = meta.lastReadTimes || {};
        const userLastRead = lastReadTimes[currentUser.uid] || 0;
        if (lastMsg && lastMsg.sender !== currentUser.uid && lastMsg.timestamp > userLastRead) {
          unread = true;
        }

        const p = db.ref(`/users/${otherUid}`).once('value').then(userSnap => {
          const otherUser = userSnap.val() || { username: 'unknown', avatar: '' };
          otherUser.uid = otherUid;

          const chatItem = createChatListItem(otherUser, lastMsg?.text, lastMsg?.timestamp, chatId, unread);
          chatListEl.appendChild(chatItem);
        });
        promises.push(p);
      });

      return Promise.all(promises);
    }).catch(console.error);
  });
</script>
</body>
</html>