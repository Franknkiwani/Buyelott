<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DLS 25 HUB</title>
  <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@600;800&display=swap" rel="stylesheet" />
  <style>
    /* Reset & basics */
    * {
      box-sizing: border-box;
      margin: 0; padding: 0;
    }
    body {
      font-family: 'Urbanist', -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
      background: linear-gradient(135deg, #0e0e0e, #1a1a1a);
      color: #fff;
      min-height: 100vh;
      overflow-x: hidden;
    }
    header {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      z-index: 1000;
      box-shadow: 0 1px 6px rgba(0,0,0,0.25);
    }
    .logo-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .ball-emoji {
      font-size: 20px;
      filter: drop-shadow(0 0 2px #fff8);
    }
    .logo-text {
      font-size: 18px;
      font-weight: 800;
      color: #00ff88;
      text-shadow: 0 0 4px #00ff8855, 0 0 8px #00ff8844;
    }
    .my-team-button {
      padding: 6px 14px;
      font-size: 14px;
      font-weight: 600;
      background: rgba(255,255,255,0.08);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 10px;
      backdrop-filter: blur(10px);
      cursor: pointer;
      transition: all 0.2s ease-in-out;
    }
    .my-team-button:hover {
      background: rgba(0,255,136,0.15);
      color: #00ff88;
      border-color: #00ff88;
    }
    main {
      padding-top: 60px;
      padding-left: 16px;
      padding-right: 16px;
    }
    .background-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: radial-gradient(circle at top left, #22222255, transparent);
      pointer-events: none;
      z-index: -1;
    }
    
    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn 0.3s ease forwards;
    }
    .modal {
      background: rgba(255,255,255,0.07);
      border-radius: 15px;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      box-shadow: 0 8px 32px 0 rgba(0,255,136,0.3);
      padding: 24px 32px;
      max-width: 420px;
      width: 90vw;
      color: #e0ffe0;
      text-align: center;
      position: relative;
    }
    .modal h2 {
      margin-bottom: 12px;
      font-weight: 900;
      font-size: 1.5rem;
      color: #00ff88;
      text-shadow: 0 0 6px #00ff8899;
    }
    .modal .close-btn {
      position: absolute;
      top: 12px;
      right: 16px;
      background: none;
      border: none;
      font-size: 24px;
      color: #00ff88;
      cursor: pointer;
      transition: color 0.2s ease;
      font-weight: 900;
      line-height: 1;
    }
    .modal .close-btn:hover {
      color: #00bb66;
    }
    .user-team {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-size: 1.2rem;
      margin-bottom: 18px;
      font-weight: 700;
    }
    .user-team .flag {
      width: 28px;
      height: 20px;
      border-radius: 3px;
      object-fit: cover;
      filter: drop-shadow(0 0 2px #0008);
      border: 1px solid #00ff88aa;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.95rem;
      color: #c0ffc0cc;
      text-align: left;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #00ff8822;
    }
    th {
      border-bottom: 2px solid #00ff8866;
      font-weight: 700;
      color: #00ff88dd;
    }
    td.flag-cell img {
      width: 22px;
      height: 15px;
      border-radius: 3px;
      object-fit: cover;
      filter: drop-shadow(0 0 1px #0006);
      border: 1px solid #00ff88aa;
    }
    /* Highlight user row */
    tr.user-row {
      background: rgba(0, 255, 136, 0.15);
      font-weight: 700;
      color: #00ff88;
      box-shadow: inset 2px 0 6px #00ff88bb;
    }

    @keyframes fadeIn {
      from {opacity: 0;}
      to {opacity: 1;}
    }
  </style>
</head>
<body>

  <div class="background-overlay"></div>

  <header>
    <div class="logo-container">
      <div class="ball-emoji">âš½</div>
      <div class="logo-text">DLS 25 HUB</div>
    </div>
    <button class="my-team-button" id="myTeamBtn">MY TEAM</button>
  </header>

  <main></main>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <button class="close-btn" id="closeModalBtn" aria-label="Close">&times;</button>
      <h2 id="modalTitle">Your Team</h2>
      <div class="user-team" id="userTeam">
        <!-- Flag + country name + rank here -->
      </div>
      <table id="groupTable" aria-describedby="modalTitle">
        <thead>
          <tr>
            <th>Flag</th>
            <th>Team Name</th>
            <th>Points</th>
            <th>Rank</th>
          </tr>
        </thead>
        <tbody>
          <!-- Teams go here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import {
    getDatabase,
    ref,
    get,
    set,
    update,
    runTransaction,
    onValue,
  } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    storageBucket: "itzhoyoo-f9f7e.filestorage.app",
    messagingSenderId: "1094792075584",
    appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
    measurementId: "G-LLT6F9WRKH",
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // UI elements
  const myTeamBtn = document.getElementById("myTeamBtn");
  const modalOverlay = document.getElementById("modalOverlay");
  const closeModalBtn = document.getElementById("closeModalBtn");
  const userTeamDiv = document.getElementById("userTeam");
  const groupTableBody = document.querySelector("#groupTable tbody");

  let userCountry = null;
  let userPoints = 0;
  let rankedTeams = [];

  // Detect user country via ipapi
  async function detectCountry() {
    try {
      const res = await fetch("https://ipapi.co/json/");
      if (!res.ok) throw new Error("Failed to fetch country data");
      const data = await res.json();
      userCountry = { name: data.country_name, code: data.country_code };
    } catch (error) {
      console.error("Country detection error:", error);
      userCountry = { name: "Unknown", code: "UN" };
    }
  }

  // Fetch all teams in GroupA from Firebase dynamically, with their points and names
  async function fetchTeamsAndPoints() {
    const groupRef = ref(db, 'groups/GroupA');
    try {
      const snapshot = await get(groupRef);
      if (snapshot.exists()) {
        const data = snapshot.val();
        // Convert Firebase object to array with code, name, points
        return Object.entries(data).map(([code, info]) => ({
          code: code.toUpperCase(),
          name: info.countryName || info.name || code,
          points: info.points || 0,
          rank: 0,
        }));
      }
    } catch (e) {
      console.error("Firebase fetch error:", e);
    }
    return [];
  }

  // Sort and assign ranks
  function calculateRanks(teamsWithPoints) {
    teamsWithPoints.sort((a, b) => b.points - a.points);
    let currentRank = 1;
    for (let i = 0; i < teamsWithPoints.length; i++) {
      if (i > 0 && teamsWithPoints[i].points < teamsWithPoints[i - 1].points) {
        currentRank = i + 1;
      }
      teamsWithPoints[i].rank = currentRank;
    }
  }

  // Show modal and render real teams dynamically
  async function showModal() {
    if (!userCountry) {
      userTeamDiv.textContent = "Loading your team info...";
      return;
    }
    rankedTeams = await fetchTeamsAndPoints();
    calculateRanks(rankedTeams);

    const userTeamInfo = rankedTeams.find(t => t.code === userCountry.code);
    userPoints = userTeamInfo ? userTeamInfo.points : 0;
    const userRank = userTeamInfo ? userTeamInfo.rank : "-";

    userTeamDiv.innerHTML = `
      <img class="flag" src="https://flagcdn.com/w40/${userCountry.code.toLowerCase()}.png" alt="${userCountry.name} flag" />
      <span>${userCountry.name}</span>
      <span style="font-weight: 500; margin-left: 10px; font-size: 0.85rem; color: #aaffaa;">
        (Points: ${userPoints}, Rank: ${userRank})
      </span>
    `;

    groupTableBody.innerHTML = "";
    rankedTeams.forEach((team) => {
      const isUser = team.code === userCountry.code;
      groupTableBody.innerHTML += `
        <tr class="${isUser ? "user-row" : ""}">
          <td class="flag-cell"><img src="https://flagcdn.com/w40/${team.code.toLowerCase()}.png" alt="${team.name} flag" /></td>
          <td>${team.name}</td>
          <td>${team.points}</td>
          <td>${team.rank}</td>
        </tr>
      `;
    });

    modalOverlay.style.display = "flex";
    document.body.style.overflow = "hidden";
  }

  function hideModal() {
    modalOverlay.style.display = "none";
    document.body.style.overflow = "";
  }

  // Helper: group names for assignment
  const MAX_GROUPS = 4;
  const MAX_COUNTRIES_PER_GROUP = 4;

  function groupNameFromIndex(index) {
    return `Group${String.fromCharCode(65 + index)}`; // A, B, C, D
  }

  // Check if tournament ended
  async function isTournamentEnded() {
    const endDateRef = ref(db, "tournament/endDate");
    try {
      const snapshot = await get(endDateRef);
      if (!snapshot.exists()) return false;
      const endDateStr = snapshot.val();
      const now = new Date();
      const endDate = new Date(endDateStr);
      return now >= endDate;
    } catch (e) {
      console.error("Error fetching tournament end date:", e);
      return false;
    }
  }

  // Assign user to a team in a group (dynamic)
  async function assignUserTeam(userId) {
    if (!userCountry) {
      throw new Error("User country not detected");
    }

    const ended = await isTournamentEnded();
    if (ended) {
      return { error: "Tournament has ended, no more teams can be assigned." };
    }

    // Check if this country is already assigned anywhere
    for (let i = 0; i < MAX_GROUPS; i++) {
      const group = groupNameFromIndex(i);
      const groupRef = ref(db, `groups/${group}`);
      const snapshot = await get(groupRef);
      const groupData = snapshot.exists() ? snapshot.val() : {};

      for (const [teamUserId, teamInfo] of Object.entries(groupData)) {
        if (teamInfo.countryCode === userCountry.code) {
          if (teamUserId === userId) {
            return { assignedGroup: group, message: `You already represent your country in ${group}` };
          }
          return { error: `Another user already represents ${userCountry.name}. Try again later.` };
        }
      }
    }

    // Assign user to first group with space
    for (let i = 0; i < MAX_GROUPS; i++) {
      const group = groupNameFromIndex(i);
      const groupRef = ref(db, `groups/${group}`);

      const result = await runTransaction(groupRef, (currentData) => {
        if (currentData === null) currentData = {};

        const countriesInGroup = new Set();
        for (const userIdKey in currentData) {
          countriesInGroup.add(currentData[userIdKey].countryCode);
        }
        if (countriesInGroup.size >= MAX_COUNTRIES_PER_GROUP) {
          return; // group full, abort transaction
        }

        currentData[userId] = {
          countryName: userCountry.name,
          countryCode: userCountry.code,
          assignedAt: new Date().toISOString(),
        };

        return currentData;
      });

      if (result.committed) {
        return { assignedGroup: group, message: `Assigned to ${group}` };
      }
      // Else try next group
    }

    return { error: "All groups are full. Maximum 16 unique countries assigned." };
  }

  // Demo usage â€” replace user123 with actual logged-in user ID
  async function handleUserAssignment() {
    const userId = "user123"; // Replace with your auth user ID in real app

    try {
      const result = await assignUserTeam(userId);
      if (result.error) {
        console.warn(result.error);
        userTeamDiv.textContent = result.error;
      } else {
        console.log(result.message);
        userTeamDiv.textContent = `${userCountry.name} assigned to ${result.assignedGroup}`;
      }
    } catch (e) {
      console.error("Assignment error:", e);
      userTeamDiv.textContent = "Error assigning team. Try again.";
    }
  }

  // Init
  window.addEventListener("load", async () => {
    await detectCountry();
    await handleUserAssignment();
  });

  myTeamBtn.addEventListener("click", showModal);
  closeModalBtn.addEventListener("click", hideModal);

  modalOverlay.addEventListener("click", (e) => {
    if (e.target === modalOverlay) hideModal();
  });

  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modalOverlay.style.display === "flex") {
      hideModal();
    }
  });
</script>
</body>
</html>