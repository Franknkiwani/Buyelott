<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Premier League Country Table</title>
<style>
  body {
    margin: 0;
    background: #121212;
    color: #eee;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    border: 10px solid #1f1f1f;
    height: 100vh;
    user-select: none;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    font-size: 1.4rem;
    padding-top: 30px;
  }
  #sidebar {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid #eee;
    padding: 20px 30px;
    border-radius: 12px;
    background: #222;
    width: 80%;
    max-width: 500px;
    box-shadow: 0 0 15px rgba(255,255,255,0.15);
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  #country-box {
    display: flex;
    align-items: center;
    gap: 12px;
    font-weight: 700;
    font-size: 1.3rem;
  }
  #flag {
    font-size: 1.8rem;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-weight: 600;
    font-size: 1rem;
    user-select: text;
  }
  thead tr {
    background: #333;
  }
  thead th {
    padding: 8px 6px;
    border-bottom: 3px solid #eee;
    text-align: center;
  }
  tbody tr {
    border-bottom: 1px solid #444;
    transition: background 0.25s;
    cursor: default;
  }
  tbody tr:hover {
    background: #444;
  }
  tbody td {
    padding: 8px 6px;
    text-align: center;
  }
  tbody tr.own-country {
    background: #4a6f4a !important;
    box-shadow: inset 0 0 10px #6fff6f;
  }
  #message-box {
    background: #300000cc;
    color: #f88;
    padding: 12px;
    border-radius: 8px;
    font-weight: 700;
    user-select: text;
  }
  #enter-next-season {
    margin-top: 12px;
    padding: 10px;
    background: #4444aa;
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-weight: 700;
    font-size: 1rem;
    transition: background 0.3s;
  }
  #enter-next-season:hover {
    background: #6666cc;
  }
  #countdown {
    margin-top: 12px;
    font-weight: 600;
    color: #aad;
  }
</style>
</head>
<body>
  <div id="sidebar">
    <div id="country-box">
      <span id="flag">üè≥Ô∏è</span>
      <span id="country-name">Loading...</span>
    </div>

    <div id="message-box" style="display:none;"></div>
    <button id="enter-next-season" style="display:none;">Enter for Next Season</button>
    <div id="countdown"></div>

    <table id="league-table" style="display:none;">
      <thead>
        <tr>
          <th>Pos</th><th>Country</th><th>P</th><th>W</th><th>D</th><th>L</th><th>Pts</th>
        </tr>
      </thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import { getDatabase, ref, get, set, push } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
    authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
    databaseURL: "https://itzhoyoo-f9f7e-default-rtdb.firebaseio.com",
    projectId: "itzhoyoo-f9f7e",
    storageBucket: "itzhoyoo-f9f7e.filestorage.app",
    messagingSenderId: "1094792075584",
    appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
    measurementId: "G-LLT6F9WRKH"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const flagEl = document.getElementById('flag');
  const countryNameEl = document.getElementById('country-name');
  const messageBox = document.getElementById('message-box');
  const enterNextBtn = document.getElementById('enter-next-season');
  const countdownEl = document.getElementById('countdown');
  const table = document.getElementById('league-table');
  const tableBody = document.getElementById('table-body');

  let seasonEnd = null;

  // Generate or get local user ID (simple UUID)
  function getUserId() {
    let id = localStorage.getItem('plUserId');
    if (!id) {
      id = 'user_' + Math.random().toString(36).slice(2, 10) + Date.now().toString(36);
      localStorage.setItem('plUserId', id);
    }
    return id;
  }
  const userId = getUserId();

  function countryCodeToEmoji(code) {
    if (!code) return 'üè≥Ô∏è';
    const OFFSET = 127397;
    return code.toUpperCase().split('').map(c => String.fromCodePoint(c.charCodeAt(0) + OFFSET)).join('');
  }

  async function fetchSeasonEndDate() {
    try {
      const seasonRef = ref(db, 'seasonEndDate');
      const snapshot = await get(seasonRef);
      if (snapshot.exists()) {
        let val = snapshot.val();
        if(typeof val === 'string') {
          seasonEnd = new Date(val);
        } else if(typeof val === 'number') {
          seasonEnd = new Date(val);
        } else {
          throw new Error("Invalid seasonEndDate format");
        }
      } else {
        seasonEnd = new Date('2025-05-12T23:59:59Z');
      }
    } catch (e) {
      console.warn("Season end date fetch failed", e);
      seasonEnd = new Date('2025-05-12T23:59:59Z');
    }
  }

  function updateCountdown() {
    if(!seasonEnd) return;
    const now = new Date();
    let diff = seasonEnd - now;
    if(diff < 0) {
      countdownEl.textContent = "Season ended. New season coming soon!";
      enterNextBtn.style.display = "none";
      return;
    }
    const days = Math.floor(diff / (1000*60*60*24));
    diff -= days*(1000*60*60*24);
    const hrs = Math.floor(diff / (1000*60*60));
    diff -= hrs*(1000*60*60);
    const mins = Math.floor(diff / (1000*60));
    diff -= mins*(1000*60);
    const secs = Math.floor(diff / 1000);
    countdownEl.textContent = `Season ends in: ${days}d ${hrs}h ${mins}m ${secs}s`;
  }

  function startCountdown() {
    updateCountdown();
    setInterval(updateCountdown, 1000);
  }

  async function init() {
    await fetchSeasonEndDate();

    try {
      const res = await fetch('https://ipapi.co/json/');
      if (!res.ok) throw new Error('Failed to fetch IP info');
      const data = await res.json();

      const countryCode = data.country_code || '';
      const countryName = data.country_name || 'Unknown';

      flagEl.textContent = countryCodeToEmoji(countryCode);
      countryNameEl.textContent = countryName;

      checkCountryInLeague(countryCode, countryName);
      startCountdown();
    } catch (e) {
      countryNameEl.textContent = 'Unknown';
      flagEl.textContent = '‚ùì';
      showMessage("Could not detect your country.");
      console.warn(e);
    }
  }

  function showMessage(msg) {
    messageBox.textContent = msg;
    messageBox.style.display = "block";
  }
  function hideMessage() {
    messageBox.style.display = "none";
  }

  async function checkCountryInLeague(countryCode, countryName) {
    const leagueRef = ref(db, 'premierLeagueTeams');
    const snapshot = await get(leagueRef);
    const teams = snapshot.exists() ? snapshot.val() : {};

    // Map countryCode -> team
    const countries = {};
    for (const key in teams) {
      if (teams[key].countryCode) countries[teams[key].countryCode] = {...teams[key], id:key};
    }

    // Sort by points desc
    const leagueEntries = Object.values(countries).sort((a,b) => (b.points||0)-(a.points||0));

    // Check ownership
    const existingTeam = countries[countryCode];
    if(existingTeam) {
      if(existingTeam.ownerId === userId) {
        // This user owns this team - no sorry, just show table
        hideMessage();
        enterNextBtn.style.display = "none";
        renderTable(leagueEntries, countryCode);
        table.style.display = "block";
      } else {
        // Taken by someone else
        showMessage(`Sorry, someone already represents your country: ${countryName}`);
        enterNextBtn.style.display = "block";
        renderTable(leagueEntries, countryCode);
        table.style.display = "block";
      }
    } else {
      // Not taken, add user as new team owner
      hideMessage();
      enterNextBtn.style.display = "none";

      const newTeam = {
        countryCode,
        countryName,
        played: 0,
        won: 0,
        drawn: 0,
        lost: 0,
        points: 0,
        ownerId: userId
      };

      const newTeamRef = await push(leagueRef);
      await set(newTeamRef, newTeam);

      leagueEntries.push({...newTeam, id: newTeamRef.key});
      leagueEntries.sort((a,b) => (b.points || 0) - (a.points || 0));
      renderTable(leagueEntries, countryCode);
      table.style.display = "block";
    }
  }

  function renderTable(teams, userCountryCode) {
    tableBody.innerHTML = '';
    teams.forEach((team, i) => {
      const tr = document.createElement('tr');
      if(team.countryCode === userCountryCode) tr.classList.add('own-country');

      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${countryCodeToEmoji(team.countryCode)} ${team.countryName}</td>
        <td>${team.played || 0}</td>
        <td>${team.won || 0}</td>
        <td>${team.drawn || 0}</td>
        <td>${team.lost || 0}</td>
        <td>${team.points || 0}</td>
      `;
      tableBody.appendChild(tr);
    });
  }

  enterNextBtn.onclick = () => {
    alert("Thanks for your interest! You'll be notified when the next season starts.");
    // Optionally, add user to waitlist here.
  };

  init();
</script>
</body>
</html>