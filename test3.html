<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Location Tracker</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      background: #f9f9f9;
      color: #222;
      padding: 2rem;
      max-width: 450px;
      margin: 50px auto;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
    }
    .loading {
      font-style: italic;
      color: #888;
    }
    .error {
      color: red;
    }
    .location-info {
      margin-top: 1rem;
      text-align: left;
    }
  </style>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <h1>User Location Tracker</h1>
  <p id="status" class="loading">Fetching locationâ€¦</p>
  <div id="location" class="location-info"></div>

  <script>
    // Your real Firebase config below
    const firebaseConfig = {
      apiKey: "AIzaSyDFHskUWiyHhZke3KT9kkOtFI_gPsKfiGo",
      authDomain: "itzhoyoo-f9f7e.firebaseapp.com",
      projectId: "itzhoyoo-f9f7e",
      storageBucket: "itzhoyoo-f9f7e.filestorage.app",
      messagingSenderId: "1094792075584",
      appId: "1:1094792075584:web:d49e9c3f899d3cd31082a5",
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    async function fetchLocation() {
      try {
        const res = await fetch('http://ip-api.com/json/');
        if (!res.ok) throw new Error('Network response was not OK');
        const data = await res.json();
        if (data.status !== 'success') throw new Error('Failed to get location');

        document.getElementById('status').textContent = 'Location found:';
        const locDiv = document.getElementById('location');

        locDiv.innerHTML = `
          <strong>Country:</strong> ${data.country} (${data.countryCode})<br/>
          <strong>Region:</strong> ${data.regionName} (${data.region})<br/>
          <strong>City:</strong> ${data.city}<br/>
          <strong>ZIP:</strong> ${data.zip}<br/>
          <strong>Latitude:</strong> ${data.lat}<br/>
          <strong>Longitude:</strong> ${data.lon}<br/>
          <strong>Timezone:</strong> ${data.timezone}<br/>
          <strong>ISP:</strong> ${data.isp}<br/>
          <strong>Org:</strong> ${data.org}
        `;

        // Save location data to Firestore
        await saveLocation(data);

      } catch (err) {
        document.getElementById('status').textContent = 'Could not fetch location.';
        document.getElementById('status').classList.remove('loading');
        document.getElementById('status').classList.add('error');
        console.error('Error fetching location:', err);
      }
    }

    async function saveLocation(locationData) {
      try {
        // Compose doc ID by countryCode_region_city, replace spaces with underscores
        const docId = `${locationData.countryCode}_${locationData.region}_${locationData.city}`.replace(/\s+/g, '_');

        const docRef = db.collection('userLocations').doc(docId);

        // Atomically increment count in Firestore, merge other info
        await docRef.set({
          country: locationData.country,
          countryCode: locationData.countryCode,
          region: locationData.regionName,
          city: locationData.city,
          count: firebase.firestore.FieldValue.increment(1),
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        console.log('Location saved to Firestore:', docId);
      } catch (error) {
        console.error('Error saving location:', error);
      }
    }

    fetchLocation();
  </script>
</body>
</html>